<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intentional â€” Dashboard</title>
<style>
*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, sans-serif;
  background: #0a0a0a;
  color: #ffffff;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  user-select: none;
  -webkit-user-select: none;
  display: flex;
}

/* ===== Sidebar ===== */
.sidebar {
  width: 220px;
  min-height: 100vh;
  background: rgba(255, 255, 255, 0.02);
  border-right: 1px solid rgba(255, 255, 255, 0.08);
  padding: 20px 0;
  flex-shrink: 0;
}

.sidebar-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 20px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  margin-bottom: 12px;
}

.logo-ring {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(139, 92, 246, 0.2) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.sidebar-title {
  font-size: 16px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.sidebar-divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.06);
  margin: 8px 20px;
}

.sidebar-label {
  padding: 8px 20px 4px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.25);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.5);
  cursor: pointer;
  transition: all 0.15s ease;
  border-left: 3px solid transparent;
}

.sidebar-item:hover {
  color: rgba(255, 255, 255, 0.8);
  background: rgba(255, 255, 255, 0.03);
}

.sidebar-item.active {
  color: #ffffff;
  background: rgba(99, 102, 241, 0.1);
  border-left-color: #6366f1;
}

.sidebar-item-icon {
  font-size: 16px;
  width: 20px;
  text-align: center;
}

/* ===== Main Content ===== */
.main {
  flex: 1;
  overflow-y: auto;
  max-height: 100vh;
}

/* ===== Header ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 20px 32px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: rgba(255, 255, 255, 0.2);
  transition: background 0.3s;
}
.status-dot.active { background: #34d399; }
.status-dot.inactive { background: rgba(255, 255, 255, 0.2); }

.status-text {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.5);
  transition: color 0.3s;
}

.save-btn {
  width: 100%;
  padding: 12px;
  margin-top: 20px;
  margin-bottom: 20px;
  background: #6366f1;
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: background 0.2s, opacity 0.2s;
}
.save-btn:hover { background: #5558e6; }
.save-btn.saved {
  background: rgba(52, 211, 153, 0.15);
  color: #34d399;
  cursor: default;
}

.save-indicator {
  font-size: 12px;
  color: rgba(52, 211, 153, 0.8);
  opacity: 0;
  transition: opacity 0.3s;
  position: fixed;
  top: 12px;
  right: 24px;
  z-index: 100;
}
.save-indicator.visible { opacity: 1; }

/* ===== Pages ===== */
.page {
  display: none;
  max-width: 720px;
  margin: 0 auto;
  padding: 32px;
}

.page.active {
  display: block;
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.4);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
}

.platform-section-title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255,255,255,0.5);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin: 28px 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid rgba(255,255,255,0.06);
}

/* Collapsible platform settings */
.platform-settings-group {
  overflow: hidden;
  max-height: 2000px;
  opacity: 1;
  transition: max-height 0.35s ease, opacity 0.25s ease, margin 0.35s ease;
}
.platform-settings-group.collapsed {
  max-height: 0;
  opacity: 0;
  margin: 0;
  pointer-events: none;
}

/* Distracting sites list */
.distracting-sites-list {
  padding: 4px 20px 12px;
}
.distracting-site {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 10px 0;
}
.distracting-site + .distracting-site {
  border-top: 1px solid rgba(255,255,255,0.06);
}
.distracting-site-icon {
  font-size: 18px;
  width: 28px;
  text-align: center;
}
.distracting-site-domain {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
}
.distracting-site-badge {
  font-size: 11px;
  color: rgba(99,102,241,0.8);
  background: rgba(99,102,241,0.1);
  padding: 3px 8px;
  border-radius: 6px;
  font-weight: 500;
}
.distracting-site-badge.custom {
  color: rgba(245,158,11,0.9);
  background: rgba(245,158,11,0.1);
}
.distracting-site-remove {
  background: none;
  border: none;
  color: rgba(255,255,255,0.3);
  cursor: pointer;
  font-size: 16px;
  padding: 4px 8px;
  border-radius: 4px;
  line-height: 1;
  transition: color 0.15s, background 0.15s;
}
.distracting-site-remove:hover {
  color: #ef4444;
  background: rgba(239,68,68,0.1);
}
.distracting-sites-add {
  display: flex;
  gap: 8px;
  padding: 8px 20px 14px;
}
.distracting-sites-add input {
  flex: 1;
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 8px 12px;
  color: #fff;
  font-size: 13px;
  outline: none;
  transition: border-color 0.15s;
}
.distracting-sites-add input:focus {
  border-color: rgba(99,102,241,0.5);
}
.distracting-sites-add input::placeholder {
  color: rgba(255,255,255,0.3);
}
.distracting-sites-add button {
  background: rgba(99,102,241,0.15);
  border: 1px solid rgba(99,102,241,0.3);
  color: rgba(99,102,241,0.9);
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s;
}
.distracting-sites-add button:hover {
  background: rgba(99,102,241,0.25);
}
.distracting-sites-hint {
  font-size: 12px;
  color: rgba(255,255,255,0.35);
  padding: 0 20px 14px;
  font-style: italic;
}

/* ===== Distracting Apps ===== */
.distracting-apps-list {
  padding: 4px 20px 12px;
}
.distracting-app {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 0;
}
.distracting-app + .distracting-app {
  border-top: 1px solid rgba(255,255,255,0.06);
}
.distracting-app-icon {
  width: 24px;
  height: 24px;
  border-radius: 6px;
}
.distracting-app-name {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
  color: rgba(255,255,255,0.85);
}
.distracting-app-remove {
  background: none;
  border: none;
  color: rgba(255,255,255,0.3);
  cursor: pointer;
  font-size: 16px;
  padding: 4px 8px;
  border-radius: 4px;
  line-height: 1;
  transition: color 0.15s, background 0.15s;
}
.distracting-app-remove:hover {
  color: #ef4444;
  background: rgba(239,68,68,0.1);
}
.distracting-apps-add-btn {
  background: rgba(99,102,241,0.15);
  border: 1px solid rgba(99,102,241,0.3);
  color: rgba(99,102,241,0.9);
  padding: 8px 16px;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: background 0.15s;
  width: 100%;
}
.distracting-apps-add-btn:hover {
  background: rgba(99,102,241,0.25);
}
.distracting-apps-empty {
  font-size: 13px;
  color: rgba(255,255,255,0.35);
  padding: 4px 0;
  font-style: italic;
}

/* ===== App Picker Modal ===== */
.app-picker-modal {
  position: fixed;
  inset: 0;
  z-index: 300;
  background: rgba(0,0,0,0.6);
  display: flex;
  align-items: center;
  justify-content: center;
}
.app-picker-card {
  background: #1a1a2e;
  border: 1px solid rgba(255,255,255,0.08);
  border-radius: 16px;
  padding: 20px;
  width: 400px;
  max-height: 500px;
  overflow: hidden;
  display: flex;
  flex-direction: column;
}
.app-picker-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 12px;
}
.app-picker-close {
  background: none;
  border: none;
  color: rgba(255,255,255,0.4);
  font-size: 20px;
  cursor: pointer;
  padding: 4px 8px;
  border-radius: 4px;
}
.app-picker-close:hover {
  color: #fff;
  background: rgba(255,255,255,0.06);
}
.app-picker-search {
  background: rgba(255,255,255,0.06);
  border: 1px solid rgba(255,255,255,0.1);
  border-radius: 8px;
  padding: 8px 12px;
  color: #fff;
  font-size: 14px;
  margin-bottom: 12px;
  outline: none;
}
.app-picker-search:focus {
  border-color: rgba(99,102,241,0.5);
}
.app-picker-search::placeholder {
  color: rgba(255,255,255,0.3);
}
.app-picker-list {
  overflow-y: auto;
  flex: 1;
  max-height: 360px;
}
.app-picker-row {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 8px 12px;
  border-radius: 8px;
  cursor: pointer;
}
.app-picker-row:hover {
  background: rgba(255,255,255,0.06);
}
.app-picker-row-icon {
  width: 28px;
  height: 28px;
  border-radius: 6px;
}
.app-picker-row-name {
  flex: 1;
  font-size: 14px;
  color: rgba(255,255,255,0.85);
}
.app-picker-row-added {
  font-size: 11px;
  color: rgba(99,102,241,0.8);
  background: rgba(99,102,241,0.1);
  padding: 3px 8px;
  border-radius: 6px;
  font-weight: 500;
}
.app-picker-loading {
  text-align: center;
  padding: 40px 0;
  color: rgba(255,255,255,0.4);
  font-size: 13px;
}

/* ===== Usage Cards ===== */
.usage-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  margin-bottom: 32px;
}

.usage-card {
  padding: 24px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  transition: all 0.3s ease;
}

.usage-card:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.12);
}

.usage-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.usage-card-icon { font-size: 20px; }
.usage-card-platform { font-size: 15px; font-weight: 600; }

.usage-card-time {
  display: flex;
  align-items: baseline;
  gap: 6px;
  margin-bottom: 12px;
}

.usage-minutes {
  font-size: 40px;
  font-weight: 700;
  line-height: 1;
}

.usage-minutes.youtube { color: #ef4444; }
.usage-minutes.instagram { color: #e879f9; }
.usage-minutes.facebook { color: #60a5fa; }

.usage-unit {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.4);
}

.usage-budget {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
}

.usage-bar {
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  margin-top: 12px;
  overflow: hidden;
}

.usage-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s ease;
}

.usage-bar-fill.youtube { background: #ef4444; }
.usage-bar-fill.instagram { background: #e879f9; }
.usage-bar-fill.facebook { background: #60a5fa; }
.usage-bar-fill.free-browse { background: #f59e0b; }

.usage-session {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 10px;
}

.usage-session-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #34d399;
  animation: session-pulse 2s ease-in-out infinite;
}

@keyframes session-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.usage-session-label {
  font-size: 11px;
  font-weight: 600;
  color: #34d399;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.usage-session-intent {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.55);
  font-style: italic;
  margin-top: 8px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.04);
  border-radius: 8px;
  border-left: 2px solid rgba(52, 211, 153, 0.4);
}

.usage-card.has-session {
  border-color: rgba(52, 211, 153, 0.2);
}

.usage-free-browse {
  font-size: 11px;
  color: rgba(245, 158, 11, 0.7);
  margin-top: 6px;
  display: none;
}

/* ===== Settings Card ===== */
.settings-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 20px;
}

.settings-card-title {
  padding: 16px 20px 8px;
  font-size: 13px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.4);
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.setting-row {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  gap: 14px;
}

.setting-row + .setting-row {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.setting-label {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
}

.setting-desc {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.35);
  margin-top: 2px;
}

.setting-value {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.5);
  min-width: 50px;
  text-align: right;
}

/* Toggle Switch */
.toggle {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-track {
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

.toggle-track::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: #ffffff;
  border-radius: 50%;
  transition: transform 0.2s;
}

.toggle input:checked + .toggle-track {
  background: #6366f1;
}

.toggle input:checked + .toggle-track::after {
  transform: translateX(20px);
}

/* Range Slider */
.setting-range {
  -webkit-appearance: none;
  appearance: none;
  width: 120px;
  height: 4px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 2px;
  outline: none;
}

.setting-range::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  background: #6366f1;
  border-radius: 50%;
  cursor: pointer;
}

/* Select Dropdown */
.setting-select {
  padding: 6px 12px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 13px;
  outline: none;
  cursor: pointer;
}

.setting-select option {
  background: #1a1a2e;
  color: #ffffff;
}

/* Number Input */
.setting-number {
  width: 70px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 14px;
  text-align: center;
  outline: none;
}

.setting-number:focus {
  border-color: #6366f1;
}

/* ===== Browser Status ===== */
.browser-section { margin-bottom: 32px; }

.browser-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  overflow: hidden;
}

.browser-row {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  gap: 14px;
}

.browser-row + .browser-row {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.browser-icon { font-size: 20px; width: 28px; height: 28px; text-align: center; flex-shrink: 0; border-radius: 6px; overflow: hidden; }
.browser-icon img { width: 100%; height: 100%; object-fit: contain; }
.browser-name { width: 110px; flex-shrink: 0; font-size: 14px; font-weight: 500; }

.browser-status {
  font-size: 12px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.browser-status.connected { color: #34d399; }
.browser-status.disconnected { color: rgba(255, 255, 255, 0.3); }

.browser-status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.browser-status-dot.connected { background: #34d399; }
.browser-status-dot.disconnected { background: rgba(255, 255, 255, 0.2); }

.browser-row.browser-connected {
  background: rgba(52, 211, 153, 0.06);
}

.browser-ext-url {
  flex: 1;
  font-size: 11px;
  color: rgba(255, 255, 255, 0.35);
  font-family: "SF Mono", Menlo, monospace;
  padding: 3px 8px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.browser-ext-url:hover {
  color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.1);
}

.browser-ext-url.copied {
  color: #34d399;
}

.browser-install-btn {
  padding: 5px 14px;
  font-size: 12px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  background: #6366f1;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  font-family: inherit;
}

.browser-install-btn:hover {
  background: #5558e6;
  transform: translateY(-1px);
}

/* ===== Empty State ===== */
.empty-state {
  text-align: center;
  padding: 48px 20px;
  color: rgba(255, 255, 255, 0.4);
}

.empty-state-icon { font-size: 48px; margin-bottom: 16px; }
.empty-state-text { font-size: 15px; line-height: 1.5; }

/* ===== Lock / Accountability ===== */
.lock-container {
  padding: 0;
}

/* Lock mode radio selector */
.lock-mode-option {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  gap: 14px;
  cursor: pointer;
  transition: background 0.15s;
}

.lock-mode-option + .lock-mode-option {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.lock-mode-option:hover {
  background: rgba(255, 255, 255, 0.03);
}

.lock-mode-option.selected {
  background: rgba(99, 102, 241, 0.06);
}

.lock-mode-radio {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.2);
  flex-shrink: 0;
  position: relative;
  transition: border-color 0.15s;
}

.lock-mode-option.selected .lock-mode-radio {
  border-color: #6366f1;
}

.lock-mode-option.selected .lock-mode-radio::after {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #6366f1;
}

/* Status badges */
.status-badge {
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-badge::before {
  content: '';
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-badge.locked { color: #ef4444; }
.status-badge.locked::before { background: #ef4444; }
.status-badge.unlocked { color: #34d399; }
.status-badge.unlocked::before { background: #34d399; }
.status-badge.pending { color: #f59e0b; }
.status-badge.pending::before { background: #f59e0b; }
.status-badge.declined { color: #ef4444; }
.status-badge.declined::before { background: #ef4444; }
.status-badge.expired { color: #f59e0b; }
.status-badge.expired::before { background: #f59e0b; }
.status-badge.confirmed { color: #34d399; }
.status-badge.confirmed::before { background: #34d399; }

/* Setting input (inline in setting-row) */
.setting-input {
  flex: 1;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 14px;
  outline: none;
  font-family: inherit;
  min-width: 0;
}

.setting-input:focus {
  border-color: #6366f1;
}

.setting-input::placeholder {
  color: rgba(255, 255, 255, 0.3);
}

/* Chip/Tag Input */
.chip-container {
  padding: 12px 20px 16px;
}
.chip-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
  min-height: 24px;
}
.chip-list:empty::before {
  content: attr(data-empty);
  color: rgba(255, 255, 255, 0.25);
  font-size: 13px;
  font-style: italic;
}
.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: rgba(99, 102, 241, 0.15);
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: 20px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.85);
}
.chip-remove {
  cursor: pointer;
  opacity: 0.5;
  font-size: 14px;
  line-height: 1;
  transition: opacity 0.15s;
}
.chip-remove:hover {
  opacity: 1;
}
.chip-input-row {
  display: flex;
  gap: 8px;
}
.chip-input-row input {
  flex: 1;
  padding: 6px 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 13px;
  outline: none;
  font-family: inherit;
}
.chip-input-row input:focus {
  border-color: #6366f1;
}
.chip-input-row input::placeholder {
  color: rgba(255, 255, 255, 0.3);
}
.chip-input-row button {
  padding: 6px 14px;
  background: rgba(99, 102, 241, 0.2);
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: 8px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 13px;
  cursor: pointer;
  font-family: inherit;
  transition: background 0.15s;
}
.chip-input-row button:hover {
  background: rgba(99, 102, 241, 0.35);
}

/* Full-width button rows */
.lock-btn-row {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.lock-btn-row .btn-primary,
.lock-btn-row .btn-secondary,
.lock-btn-row .btn-danger {
  flex: 1;
  text-align: center;
  margin-top: 0;
}

/* Helper text between cards */
.lock-helper-text {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
  padding: 12px 4px;
  line-height: 1.5;
}

/* Unlock code input */
.unlock-code-input {
  width: 200px;
  padding: 16px 24px;
  background: rgba(255, 255, 255, 0.06);
  border: 2px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  color: #ffffff;
  font-size: 28px;
  font-weight: 700;
  text-align: center;
  letter-spacing: 8px;
  outline: none;
  transition: border-color 0.2s;
}

.unlock-code-input:focus {
  border-color: #6366f1;
}

.unlock-code-input::placeholder {
  color: rgba(255, 255, 255, 0.2);
  letter-spacing: 4px;
  font-size: 18px;
}

/* Countdown timer */
.countdown-display {
  font-size: 48px;
  font-weight: 700;
  color: #f59e0b;
  font-variant-numeric: tabular-nums;
  margin: 16px 0;
}

/* Temporarily unlocked banner */
.unlock-timer-bar {
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  margin: 16px auto;
  max-width: 300px;
  overflow: hidden;
}

.unlock-timer-fill {
  height: 100%;
  background: #34d399;
  border-radius: 2px;
  transition: width 1s linear;
}

.btn-primary {
  padding: 12px 32px;
  background: #6366f1;
  border: none;
  border-radius: 10px;
  color: #ffffff;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-primary:hover {
  background: #5558e6;
  transform: translateY(-1px);
}

.btn-primary:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  padding: 12px 32px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 10px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
}

.btn-danger {
  padding: 12px 32px;
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 10px;
  color: #ef4444;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-danger:hover {
  background: rgba(239, 68, 68, 0.25);
}

/* ===== Advanced Page ===== */
.info-row {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  gap: 14px;
}

.info-row + .info-row {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.info-label {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
  min-width: 120px;
}

.info-value {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
  font-family: "SF Mono", Menlo, monospace;
  word-break: break-all;
}

/* ===== Toast ===== */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  padding: 12px 24px;
  background: #6366f1;
  color: #ffffff;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 500;
  z-index: 1000;
  transition: transform 0.3s ease;
  pointer-events: none;
}

.toast.visible {
  transform: translateX(-50%) translateY(0);
}

.toast.error {
  background: #ef4444;
}

.toast.warning {
  background: #f59e0b;
  color: #000000;
}

/* ===== Locked Settings ===== */
.setting-row.locked {
  opacity: 0.4;
  pointer-events: none;
  position: relative;
}

.locked-banner {
  padding: 12px 20px;
  background: rgba(239, 68, 68, 0.08);
  border: 1px solid rgba(239, 68, 68, 0.2);
  border-radius: 10px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.6);
}

/* Lock-confirmable: OFF toggle that can be enabled with confirmation */
.setting-row.lock-confirmable {
  position: relative;
}
.setting-row.lock-confirmable::after {
  content: 'ðŸ”’';
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  opacity: 0.35;
}

/* Lock Confirmation Modal */
.lock-confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(4px);
}
.lock-confirm-box {
  background: #1e1e2e;
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 16px;
  padding: 28px 32px;
  max-width: 400px;
  width: 90%;
  text-align: center;
}
.lock-confirm-icon {
  font-size: 32px;
  margin-bottom: 12px;
}
.lock-confirm-box h3 {
  margin: 0 0 8px;
  font-size: 17px;
  font-weight: 600;
  color: #fff;
}
.lock-confirm-box p {
  margin: 0 0 8px;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.6);
  line-height: 1.5;
}
.lock-confirm-warning {
  color: rgba(251, 191, 36, 0.8) !important;
  font-size: 13px !important;
  margin-top: 12px !important;
  margin-bottom: 20px !important;
}
.lock-confirm-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}
.lock-confirm-cancel {
  padding: 8px 20px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
  cursor: pointer;
  font-family: inherit;
}
.lock-confirm-cancel:hover {
  background: rgba(255, 255, 255, 0.12);
}
.lock-confirm-enable {
  padding: 8px 20px;
  background: rgba(99, 102, 241, 0.3);
  border: 1px solid rgba(99, 102, 241, 0.5);
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  font-family: inherit;
  font-weight: 500;
}
.lock-confirm-enable:hover {
  background: rgba(99, 102, 241, 0.45);
}

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 3px; }

/* ===== Weekly Usage Chart ===== */
.weekly-bars {
  display: flex;
  align-items: flex-end;
  gap: 8px;
  height: 140px;
  padding: 12px 0;
}
.weekly-bar-col {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  height: 100%;
}
.weekly-bar-value {
  font-size: 11px;
  color: var(--text-secondary);
  margin-bottom: 4px;
  min-height: 16px;
}
.weekly-bar-track {
  flex: 1;
  width: 100%;
  max-width: 32px;
  background: var(--card);
  border-radius: 4px;
  display: flex;
  align-items: flex-end;
  overflow: hidden;
}
.weekly-bar-fill {
  width: 100%;
  background: linear-gradient(to top, #6366f1, #818cf8);
  border-radius: 4px;
  min-height: 2px;
  transition: height 0.3s ease;
}
.weekly-bar-label {
  font-size: 11px;
  color: var(--text-secondary);
  margin-top: 4px;
}
.weekly-bar-today .weekly-bar-fill {
  background: linear-gradient(to top, #6366f1, #a78bfa);
}
.weekly-bar-today .weekly-bar-label {
  color: var(--text-primary);
  font-weight: 600;
}
.journal-entry {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
}
.journal-entry:last-child { border-bottom: none; }
.journal-time {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.4);
  min-width: 60px;
  font-variant-numeric: tabular-nums;
}
.journal-platform {
  font-size: 14px;
  min-width: 20px;
  text-align: center;
}
.journal-intent {
  flex: 1;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.8);
}
.journal-intent.free-browse {
  color: #f59e0b;
  font-style: italic;
}
.journal-duration {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.5);
  text-align: right;
  min-width: 60px;
}
.journal-over {
  font-size: 11px;
  color: #ef4444;
}
.journal-empty {
  color: rgba(255, 255, 255, 0.3);
  font-size: 13px;
  padding: 24px 0;
  text-align: center;
}

/* ===== Focus Plan ===== */
.focus-top-row {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
}
.focus-score-compact {
  width: 140px;
  text-align: center;
  flex-shrink: 0;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  padding: 20px 12px;
}
.focus-score-compact .focus-score-ring {
  width: 80px; height: 80px;
  margin: 0 auto 8px;
}
.focus-score-compact .focus-score-ring svg {
  width: 80px; height: 80px;
}
.focus-score-compact .focus-score-value {
  font-size: 22px;
}
.focus-score-compact .focus-score-label {
  font-size: 11px;
  color: rgba(255, 255, 255, 0.35);
  margin-top: 4px;
}
.today-split-row {
  display: flex;
  gap: 16px;
  margin-bottom: 20px;
}
.today-split-row > * {
  flex: 1;
  min-width: 0;
}
.focus-goals-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  padding: 16px 20px;
}
.focus-goals-title {
  font-size: 12px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.35);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 12px;
}
.focus-profile-inline {
  background: rgba(99, 102, 241, 0.06);
  border: 1px solid rgba(99, 102, 241, 0.15);
  border-radius: 16px;
  padding: 20px;
  margin-bottom: 20px;
}
.focus-profile-inline .setting-desc { margin-bottom: 10px; }
.focus-save-bar {
  position: sticky;
  bottom: 0;
  padding: 12px 0;
  background: linear-gradient(transparent, #0a0a0a 40%);
  text-align: center;
}

.focus-textarea {
  width: 100%;
  padding: 10px 14px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 10px;
  color: #ffffff;
  font-family: inherit;
  font-size: 14px;
  line-height: 1.5;
  resize: vertical;
  outline: none;
  transition: border-color 0.2s;
}
.focus-textarea:focus { border-color: #6366f1; }
.focus-textarea::placeholder { color: rgba(255, 255, 255, 0.25); }

.focus-goal-row {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 8px;
}
.focus-goal-number {
  width: 20px; height: 20px;
  border-radius: 50%;
  background: rgba(99, 102, 241, 0.15);
  color: #6366f1;
  font-size: 11px; font-weight: 700;
  display: flex; align-items: center; justify-content: center;
  flex-shrink: 0;
}
.focus-goal-input {
  flex: 1;
  padding: 7px 10px;
  background: rgba(255, 255, 255, 0.05);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: #ffffff;
  font-size: 13px;
  font-family: inherit;
  outline: none;
  min-width: 0;
}
.focus-goal-input:focus { border-color: #6366f1; }
.focus-goal-input::placeholder { color: rgba(255, 255, 255, 0.25); }

.btn-icon {
  width: 32px; height: 32px;
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  background: rgba(255, 255, 255, 0.03);
  color: rgba(255, 255, 255, 0.6);
  font-size: 16px;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.btn-icon:hover { background: rgba(255, 255, 255, 0.08); color: #fff; }

.btn-small {
  padding: 6px 14px;
  font-size: 12px; font-weight: 600;
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: 8px;
  background: rgba(99, 102, 241, 0.1);
  color: #a5b4fc;
  cursor: pointer;
  transition: background 0.15s;
}
.btn-small:hover { background: rgba(99, 102, 241, 0.2); }

.btn-small-deep {
  border-color: rgba(220, 38, 38, 0.3);
  background: rgba(220, 38, 38, 0.1);
  color: #f87171;
}
.btn-small-deep:hover { background: rgba(220, 38, 38, 0.2); }

.btn-small-free {
  border-color: rgba(52, 211, 153, 0.3);
  background: rgba(52, 211, 153, 0.1);
  color: #6ee7b7;
}
.btn-small-free:hover { background: rgba(52, 211, 153, 0.2); }

/* ===== Earned Browse Widget ===== */
.earned-browse-widget {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.06);
  border-radius: 12px;
  padding: 16px;
}

/* --- Extra Time Request Flow --- */
.earned-extra-time-link {
  background: none;
  border: none;
  padding: 0;
  font-size: 11px;
  font-family: inherit;
  color: rgba(255, 255, 255, 0.35);
  cursor: pointer;
  transition: color 0.15s ease;
  white-space: nowrap;
}
.earned-extra-time-link:hover {
  color: rgba(255, 255, 255, 0.6);
  text-decoration: underline;
}
.earned-extra-time-flow {
  margin-top: 10px;
}
.extra-time-pills {
  display: flex;
  gap: 8px;
}
.extra-time-pill {
  flex: 1;
  padding: 8px 4px;
  font-size: 12px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.05);
  border: 1.5px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: inherit;
}
.extra-time-pill:hover {
  background: rgba(255, 255, 255, 0.08);
  border-color: rgba(255, 255, 255, 0.2);
  color: #fff;
}
.extra-time-pill.selected {
  background: rgba(99, 102, 241, 0.15);
  border-color: #6366f1;
  color: #fff;
}
.extra-time-action-btn {
  flex: 1;
  padding: 7px 12px;
  font-size: 12px;
  font-weight: 600;
  color: #fff;
  background: #6366f1;
  border: none;
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: inherit;
}
.extra-time-action-btn:hover { background: #4f46e5; }
.extra-time-action-btn:disabled {
  opacity: 0.35;
  cursor: not-allowed;
}
.extra-time-cancel-btn {
  padding: 7px 12px;
  font-size: 12px;
  font-weight: 500;
  color: rgba(255, 255, 255, 0.4);
  background: transparent;
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 6px;
  cursor: pointer;
  transition: all 0.15s ease;
  font-family: inherit;
}
.extra-time-cancel-btn:hover {
  color: rgba(255, 255, 255, 0.6);
  border-color: rgba(255, 255, 255, 0.15);
}
.extra-time-code-grid {
  display: flex;
  gap: 6px;
  justify-content: center;
}
.extra-time-code-cell {
  width: 36px;
  height: 40px;
  text-align: center;
  font-size: 18px;
  font-weight: 700;
  color: #fff;
  background: rgba(255, 255, 255, 0.05);
  border: 1.5px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  outline: none;
  caret-color: #6366f1;
  transition: border-color 0.15s ease;
  font-family: inherit;
}
.extra-time-code-cell:focus {
  border-color: #6366f1;
  background: rgba(99, 102, 241, 0.08);
}
.extra-time-error {
  font-size: 11px;
  color: #ef4444;
  margin-top: 6px;
}

/* ===== Collapsible Sections ===== */
.collapsible-section {
  margin-bottom: 8px;
}
.collapsible-header {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 16px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 12px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.7);
  transition: background 0.15s;
  user-select: none;
}
.collapsible-header:hover {
  background: rgba(255, 255, 255, 0.05);
  color: rgba(255, 255, 255, 0.9);
}
.collapsible-arrow {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.35);
  transition: transform 0.2s;
  display: inline-block;
}
.collapsible-arrow.expanded {
  transform: rotate(90deg);
}
.collapsible-body {
  padding: 12px 0 0;
}


/* Calendar */
.calendar-container {
  position: relative;
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  background: rgba(255, 255, 255, 0.02);
  overflow: hidden;
  max-height: 420px;
  overflow-y: auto;
  margin-bottom: 16px;
}
.calendar-grid {
  position: relative;
  /* height set dynamically by JS based on CALENDAR_HOUR_HEIGHT */
}
.calendar-hour-row {
  position: absolute;
  left: 0; right: 0;
  height: 42px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  display: flex;
}
.calendar-hour-label {
  width: 56px;
  padding: 4px 8px 0 0;
  text-align: right;
  font-size: 11px;
  color: rgba(255, 255, 255, 0.25);
  flex-shrink: 0;
  font-variant-numeric: tabular-nums;
}
.calendar-hour-track {
  flex: 1;
  position: relative;
  cursor: pointer;
}
.calendar-hour-track::before {
  content: '';
  position: absolute; inset: 0;
  background: repeating-linear-gradient(
    -45deg, transparent, transparent 4px,
    rgba(255, 255, 255, 0.015) 4px, rgba(255, 255, 255, 0.015) 8px
  );
  pointer-events: none;
}

.calendar-block {
  position: absolute;
  left: 60px; right: 8px;
  border-radius: 8px;
  padding: 6px 10px;
  cursor: pointer;
  z-index: 2;
  transition: box-shadow 0.15s;
  overflow: hidden;
}
.calendar-block:hover { box-shadow: 0 0 0 1px rgba(255, 255, 255, 0.2); }
.calendar-block.deep-work {
  background: rgba(220, 38, 38, 0.2);
  border-left: 3px solid #dc2626;
}
.calendar-block.focus-hours {
  background: rgba(99, 102, 241, 0.2);
  border-left: 3px solid #6366f1;
}
.calendar-block.free-time {
  background: rgba(52, 211, 153, 0.12);
  border-left: 3px solid #34d399;
}
.calendar-block-title {
  font-size: 12px; font-weight: 600;
  color: rgba(255, 255, 255, 0.85);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.calendar-block-time {
  font-size: 10px;
  color: rgba(255, 255, 255, 0.4);
  margin-top: 2px;
}
.calendar-block-badge {
  position: absolute;
  top: 6px; right: 8px;
  font-size: 9px; font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}
.calendar-block-badge.badge-free { color: #34d399; }
.calendar-block-badge.badge-deep { color: #f87171; }
.calendar-block-resize {
  position: absolute;
  left: 0; right: 0;
  height: 6px;
  cursor: ns-resize;
  z-index: 3;
}
.calendar-block-resize.top { top: 0; }
.calendar-block-resize.bottom { bottom: 0; }
.calendar-block-ring {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 42px; height: 42px;
  pointer-events: auto;
  cursor: pointer;
}
.calendar-block-ring-pending {
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  width: 42px; height: 42px;
  pointer-events: none;
  opacity: 0.4;
}
.calendar-block-ring svg {
  transform: rotate(-90deg);
  width: 42px; height: 42px;
}
.calendar-block-ring .ring-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.08);
  stroke-width: 3;
}
.calendar-block-ring .ring-fill {
  fill: none;
  stroke-width: 3;
  stroke-linecap: round;
  stroke-dasharray: 100.53;
  stroke-dashoffset: 100.53;
  transition: stroke-dashoffset 0.8s ease-out;
}
.calendar-block-ring .ring-text {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 10px; font-weight: 700;
  color: rgba(255, 255, 255, 0.85);
}
.calendar-block-ring .ring-earned {
  position: absolute;
  right: 100%;
  top: 50%;
  transform: translateY(-50%);
  font-size: 9px;
  font-weight: 600;
  color: #34d399;
  white-space: nowrap;
  margin-right: 4px;
}
.calendar-block-score-badge {
  position: absolute;
  right: 8px; top: 6px;
  font-size: 9px; font-weight: 700;
  color: rgba(255, 255, 255, 0.6);
  pointer-events: auto;
  cursor: pointer;
}
.calendar-block.dragging {
  opacity: 0.85;
  box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
  z-index: 10;
  cursor: grabbing;
}
.calendar-block.past {
  opacity: 0.5;
  cursor: default;
}
.calendar-block.past .calendar-block-resize {
  display: none;
}
.calendar-block.past:hover {
  filter: none;
  box-shadow: none;
}
.calendar-block.active {
  border: 1px solid rgba(99, 102, 241, 0.4);
  box-shadow: 0 0 12px rgba(99, 102, 241, 0.12);
}
.calendar-block.active .calendar-block-resize.top {
  display: none;
}

.calendar-now-line {
  position: absolute;
  left: 56px; right: 0;
  height: 2px;
  background: #ef4444;
  z-index: 5;
  pointer-events: none;
}
.calendar-now-line::before {
  content: '';
  position: absolute;
  left: -4px; top: -3px;
  width: 8px; height: 8px;
  border-radius: 50%;
  background: #ef4444;
}

/* Zoom Control */
.calendar-zoom-wrapper {
  position: sticky;
  top: 0;
  z-index: 6;
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: rgba(10, 10, 10, 0.85);
  backdrop-filter: blur(8px);
  border-bottom: 1px solid rgba(255, 255, 255, 0.04);
}
.calendar-zoom-icon { font-size: 10px; color: rgba(255, 255, 255, 0.25); }
.calendar-zoom-slider {
  width: 80px; height: 2px;
  -webkit-appearance: none; background: rgba(255, 255, 255, 0.1);
  border-radius: 1px; outline: none; cursor: pointer;
}
.calendar-zoom-slider::-webkit-slider-thumb {
  -webkit-appearance: none; width: 10px; height: 10px;
  border-radius: 50%; background: rgba(255, 255, 255, 0.35); cursor: pointer;
}
.calendar-focus-stats {
  margin-left: auto;
  display: flex;
  gap: 10px;
  font-size: 10px;
  color: rgba(255, 255, 255, 0.3);
}
.calendar-focus-stats span span {
  font-weight: 600;
}

/* Date Navigation */
.calendar-date-nav {
  display: flex; align-items: center; gap: 6px; margin-left: 12px;
}
.calendar-date-nav button {
  background: none; border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 6px; color: rgba(255, 255, 255, 0.5);
  font-size: 12px; padding: 2px 8px; cursor: pointer;
  transition: all 0.15s;
}
.calendar-date-nav button:hover {
  border-color: rgba(255, 255, 255, 0.25);
  color: rgba(255, 255, 255, 0.8);
}
.calendar-date-label {
  font-size: 13px; color: rgba(255, 255, 255, 0.6);
  font-weight: 500; min-width: 100px; text-align: center;
}

/* Empty State */
.calendar-empty-state {
  position: absolute; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  z-index: 4; pointer-events: none;
}
.calendar-empty-text {
  font-size: 14px; color: rgba(255, 255, 255, 0.3); margin-bottom: 16px;
}
.calendar-empty-btn {
  pointer-events: auto; padding: 10px 24px;
  background: rgba(99, 102, 241, 0.15);
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: 10px; color: #a5b4fc;
  font-size: 14px; font-weight: 600; cursor: pointer;
  transition: all 0.15s;
}
.calendar-empty-btn:hover {
  background: rgba(99, 102, 241, 0.25);
  border-color: rgba(99, 102, 241, 0.5);
}

/* Block Editor Popover */
.block-editor {
  position: fixed;
  background: #1a1a2e;
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  padding: 16px;
  z-index: 100;
  width: 280px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
}
.block-editor-row { margin-bottom: 12px; }
.block-editor-row label {
  display: block;
  font-size: 12px;
  color: rgba(255, 255, 255, 0.5);
  margin-bottom: 4px;
}
.block-editor-input {
  width: 100%;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  font-family: inherit;
  outline: none;
}
.block-editor-input:focus { border-color: #6366f1; }
.block-editor-time-row {
  display: flex; gap: 8px; align-items: center;
}
.block-editor-time-input { width: 100px; text-align: center; }
.block-type-selector {
  display: flex; gap: 2px; background: rgba(255,255,255,0.06); border-radius: 8px; padding: 2px;
}
.block-type-btn {
  flex: 1; padding: 6px 8px; border: none; border-radius: 6px; cursor: pointer;
  font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.5); background: transparent;
  transition: all 0.15s;
}
.block-type-btn.selected {
  color: #fff; background: rgba(99,102,241,0.4);
}
.block-type-btn.selected.type-deep {
  background: rgba(220,38,38,0.35);
}
.block-type-btn.selected.type-free {
  background: rgba(52,211,153,0.3);
}
.block-editor-actions {
  display: flex; gap: 8px; margin-top: 16px;
}
.block-editor-delete {
  color: #ef4444 !important;
  border-color: rgba(239, 68, 68, 0.3) !important;
  background: rgba(239, 68, 68, 0.1) !important;
}
.block-editor-delete:hover {
  background: rgba(239, 68, 68, 0.2) !important;
}

/* Block Assessment Popover */
.block-assessment-popover {
  position: fixed;
  background: #1a1a2e;
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  z-index: 100;
  width: 320px;
  max-height: 440px;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}
.ba-header {
  padding: 12px 14px 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}
.ba-header-title { flex: 1; font-size: 13px; font-weight: 600; }
.ba-header-score { font-size: 13px; font-weight: 700; }
.ba-header-close {
  width: 20px; height: 20px; border-radius: 6px; border: none;
  background: rgba(255, 255, 255, 0.08); color: rgba(255, 255, 255, 0.5);
  font-size: 12px; cursor: pointer;
  display: flex; align-items: center; justify-content: center;
}
.ba-header-close:hover { background: rgba(255, 255, 255, 0.15); }
.ba-summary {
  padding: 0 14px 10px;
  font-size: 11px;
  color: rgba(255, 255, 255, 0.4);
}
.ba-empty {
  padding: 24px 14px; text-align: center;
  font-size: 12px; color: rgba(255, 255, 255, 0.3);
}
.ba-info-btn {
  width: 18px; height: 18px; border-radius: 50%; border: none;
  background: rgba(255, 255, 255, 0.06); color: rgba(255, 255, 255, 0.3);
  font-size: 11px; cursor: pointer; flex-shrink: 0;
  display: flex; align-items: center; justify-content: center;
  transition: background 0.15s, color 0.15s;
}
.ba-info-btn:hover { background: rgba(255, 255, 255, 0.12); color: rgba(255, 255, 255, 0.6); }
.ba-info-btn.open { background: rgba(99, 102, 241, 0.2); color: #818cf8; }
.ba-reason {
  font-size: 11px; color: rgba(255, 255, 255, 0.4);
  padding: 4px 0 2px; line-height: 1.4;
  display: none;
}
.ba-reason.visible { display: block; }
.ba-dot {
  width: 7px; height: 7px; border-radius: 50%; flex-shrink: 0;
}
.ba-dot.relevant { background: #34d399; }
.ba-dot.irrelevant { background: #ef4444; }
.ba-dot.neutral { background: #6b7280; }
/* Timeline view container */
.ba-timeline-content {
  flex: 1; overflow-y: auto;
}
/* Timeline view */
.ba-timeline-seg {
  height: 100%; min-width: 2px; position: relative; cursor: pointer;
  transition: filter 0.15s;
}
.ba-timeline-seg:hover { filter: brightness(1.3); }
.ba-timeline-seg.relevant { background: #34d399; }
.ba-timeline-seg.irrelevant { background: #ef4444; }
.ba-timeline-seg.neutral { background: #6b7280; }
.ba-timeline-seg + .ba-timeline-seg { border-left: 1px solid rgba(0,0,0,0.25); }
.ba-timeline-seg.highlight { filter: brightness(1.3); }
.ba-timeline-seg.dimmed { opacity: 0.3; }
.ba-timeline-axis {
  display: flex; justify-content: space-between;
  margin: 0 14px 10px; font-size: 10px; color: rgba(255,255,255,0.3);
  font-variant-numeric: tabular-nums;
}
.ba-timeline-legend { padding: 4px 0; }
.ba-timeline-legend-row {
  display: flex; align-items: center; gap: 8px;
  padding: 6px 14px; cursor: pointer; transition: background 0.15s;
}
.ba-timeline-legend-row:hover { background: rgba(255,255,255,0.04); }
.ba-timeline-legend-row + .ba-timeline-legend-row { border-top: 1px solid rgba(255,255,255,0.04); }
.ba-timeline-legend-name {
  flex: 1; min-width: 0; font-size: 12px; color: rgba(255,255,255,0.85);
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.ba-timeline-legend-time {
  font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.5);
  font-variant-numeric: tabular-nums; flex-shrink: 0;
}
.ba-timeline-legend-pct {
  font-size: 11px; color: rgba(255,255,255,0.3);
  font-variant-numeric: tabular-nums; flex-shrink: 0;
  min-width: 28px; text-align: right;
}
/* Magnifying loupe */
.ba-timeline-bar-wrap { position: relative; margin: 0 14px 4px; }
.ba-timeline-bar {
  display: flex; height: 20px; border-radius: 6px; overflow: hidden;
  background: rgba(255,255,255,0.06); position: relative;
  margin: 0; /* margin now on wrapper */
}
.ba-loupe {
  position: fixed; width: 120px;
  border-radius: 8px; overflow: hidden;
  border: 1px solid rgba(255,255,255,0.25);
  background: #1a1a2e;
  pointer-events: none; display: none;
  box-shadow: 0 4px 12px rgba(0,0,0,0.5);
  z-index: 200;
}
.ba-loupe-label {
  font-size: 10px; color: rgba(255,255,255,0.7);
  padding: 3px 6px; text-align: center;
  white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
  background: rgba(0,0,0,0.3);
}
.ba-loupe-inner {
  display: flex; height: 36px; position: relative;
}
.ba-loupe-seg {
  height: 100%; min-width: 1px;
}
.ba-loupe-seg.relevant { background: #34d399; }
.ba-loupe-seg.irrelevant { background: #ef4444; }
.ba-loupe-seg.neutral { background: #6b7280; }
.ba-loupe-seg + .ba-loupe-seg { border-left: 1px solid rgba(0,0,0,0.2); }
.ba-loupe-line {
  position: fixed; width: 1px;
  background: rgba(255,255,255,0.35); pointer-events: none;
  display: none; z-index: 200;
}
/* Detail strip */
.ba-detail-strip {
  margin: 6px 14px 0; background: rgba(255,255,255,0.04);
  border-radius: 6px; overflow: hidden;
  max-height: 0; transition: max-height 0.3s ease, padding 0.3s ease;
  font-size: 11px; color: rgba(255,255,255,0.6); line-height: 1.5;
  padding: 0 10px;
}
.ba-detail-strip.open { max-height: 200px; padding: 8px 10px; }
.ba-detail-item { display: flex; gap: 6px; align-items: baseline; }
.ba-detail-time {
  color: rgba(255,255,255,0.3); font-size: 10px;
  font-variant-numeric: tabular-nums; flex-shrink: 0;
}
.ba-detail-dot {
  width: 5px; height: 5px; border-radius: 50%; flex-shrink: 0; margin-top: 4px;
}
.ba-detail-dot.relevant { background: #34d399; }
.ba-detail-dot.irrelevant { background: #ef4444; }
.ba-detail-dot.neutral { background: #6b7280; }
.ba-detail-name { min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
/* Tooltip */
.ba-tooltip {
  position: fixed; z-index: 200;
  background: #0f0f1a; border: 1px solid rgba(255,255,255,0.15);
  border-radius: 8px; padding: 8px 10px;
  font-size: 11px; color: rgba(255,255,255,0.85);
  pointer-events: none; max-width: 240px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.5);
  line-height: 1.4;
}
.ba-tooltip-title { font-weight: 600; margin-bottom: 2px; }
.ba-tooltip-time { color: rgba(255,255,255,0.4); font-size: 10px; }
.ba-tooltip-pages { color: rgba(255,255,255,0.35); font-size: 10px; margin-top: 4px; }
/* Focus Score */
.focus-score-hero {
  text-align: center;
  padding: 24px 0 32px;
}
.focus-score-ring {
  position: relative;
  width: 120px; height: 120px;
  margin: 0 auto 12px;
}
.focus-score-ring svg {
  transform: rotate(-90deg);
  width: 120px; height: 120px;
}
.score-bg {
  fill: none;
  stroke: rgba(255, 255, 255, 0.06);
  stroke-width: 8;
}
.score-fill {
  fill: none;
  stroke: #6366f1;
  stroke-width: 8;
  stroke-linecap: round;
  stroke-dasharray: 339.292;
  stroke-dashoffset: 339.292;
  transition: stroke-dashoffset 1s ease-out;
}
.focus-score-value {
  position: absolute;
  top: 50%; left: 50%;
  transform: translate(-50%, -50%);
  font-size: 32px; font-weight: 700;
}
.focus-score-label {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.4);
}

.focus-plan-summary {
  background: rgba(99, 102, 241, 0.06);
  border: 1px solid rgba(99, 102, 241, 0.15);
  border-radius: 16px;
  padding: 20px;
  margin-top: 16px;
}
.focus-plan-status {
  font-size: 14px; font-weight: 600;
  color: #34d399;
  margin-bottom: 8px;
}
.focus-plan-goals {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.5);
  line-height: 1.6;
}

/* Relevance Log */
.relevance-entry {
  display: flex; align-items: flex-start; gap: 10px;
  padding: 8px 20px; border-bottom: 1px solid rgba(255, 255, 255, 0.04);
  font-size: 13px;
}
.relevance-entry:last-child { border-bottom: none; }
.relevance-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; margin-top: 5px; }
.relevance-dot.relevant { background: #34d399; }
.relevance-dot.irrelevant { background: #ef4444; }
.relevance-time { font-size: 11px; color: rgba(255, 255, 255, 0.3); min-width: 55px; flex-shrink: 0; font-variant-numeric: tabular-nums; }
.relevance-title { color: rgba(255, 255, 255, 0.8); font-weight: 500; }
.relevance-reason { color: rgba(255, 255, 255, 0.4); font-size: 12px; margin-top: 2px; }
.relevance-action { font-size: 10px; font-weight: 600; text-transform: uppercase; letter-spacing: 0.3px; margin-top: 2px; }
.relevance-action.nudged { color: #f59e0b; }
.relevance-action.blocked { color: #ef4444; }
.copy-assessments-btn {
  background: none; border: 1px solid rgba(255,255,255,0.1); border-radius: 6px;
  color: rgba(255,255,255,0.35); font-size: 11px; padding: 2px 8px; cursor: pointer;
  margin-left: auto; transition: color 0.15s, border-color 0.15s;
}
.copy-assessments-btn:hover { color: rgba(255,255,255,0.6); border-color: rgba(255,255,255,0.2); }

.focus-calendar-header {
  display: flex; align-items: center; justify-content: space-between;
  margin-bottom: 16px;
}
.focus-calendar-header-left {
  display: flex; align-items: center; gap: 12px;
}
.focus-calendar-header-right {
  display: flex; gap: 8px;
}
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-header">
    <div class="logo-ring">ðŸŽ¯</div>
    <span class="sidebar-title">Intentional</span>
  </div>
  <div class="sidebar-item active" data-page="today" onclick="navigateTo('today')">
    <span class="sidebar-item-icon">ðŸ“‹</span> Today
  </div>
  <div class="sidebar-item" data-page="distractions" onclick="navigateTo('distractions')">
    <span class="sidebar-item-icon">ðŸš«</span> Distractions
  </div>
  <div class="sidebar-item" data-page="lock" onclick="navigateTo('lock')">
    <span class="sidebar-item-icon">ðŸ”’</span> Accountability
  </div>
  <div class="sidebar-item" data-page="settings" onclick="navigateTo('settings')">
    <span class="sidebar-item-icon">âš™ï¸</span> Settings
  </div>
</div>

<div class="save-indicator" id="save-indicator">Saved</div>

<!-- Main -->
<div class="main">

  <!-- Header -->
  <div class="header">
    <div class="header-right">
      <span class="status-dot" id="monitoring-dot"></span>
      <span class="status-text" id="monitoring-text">Monitoring active</span>
    </div>
  </div>

  <!-- Page: Usage -->
  <div class="page active" id="page-today">

    <!-- A. Schedule -->
    <div class="focus-calendar-header">
      <div class="focus-calendar-header-left">
        <div class="section-title" style="margin-bottom: 0;">Schedule</div>
        <div class="calendar-date-nav">
          <button id="calendar-nav-prev" onclick="navigateScheduleDate(-1)">&larr;</button>
          <span class="calendar-date-label" id="calendar-date-label">Today</span>
          <button id="calendar-nav-next" onclick="navigateScheduleDate(1)" style="visibility:hidden;">&rarr;</button>
        </div>
      </div>
      <div class="focus-calendar-header-right" id="calendar-add-buttons">
        <button class="btn-small btn-small-deep" onclick="addFocusBlock('deepWork')">+ Deep Work</button>
        <button class="btn-small" onclick="addFocusBlock('focusHours')">+ Focus Hours</button>
        <button class="btn-small btn-small-free" onclick="addFocusBlock('freeTime')">+ Free Time</button>
        <button onclick="navigateToEnforcementSection()" title="Enforcement settings" style="background:none;border:none;color:rgba(255,255,255,0.4);font-size:16px;cursor:pointer;padding:2px 6px;margin-left:2px;">&#x2026;</button>
      </div>
    </div>
    <div class="calendar-container" id="calendar-container"></div>

    <!-- B. Earned Browse (full width) -->
    <div class="earned-browse-widget" id="earned-browse-widget" style="margin-top: 16px;">
      <div class="focus-goals-title">Earned Browse</div>
      <div style="height: 20px; background: rgba(255,255,255,0.06); border-radius: 4px; overflow: hidden; display: flex; margin-top: 8px;">
        <div id="eb4-bar-avail" style="background: #34d399; transition: width 0.3s; border-radius: 4px 0 0 4px;"></div>
        <div id="eb4-bar-used" style="background: #f87171; transition: width 0.3s;"></div>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: rgba(255,255,255,0.5);">
        <span id="eb4-avail-label" style="color: #34d399;">0 available</span>
        <span id="eb4-used-label" style="color: #f87171;">0 used</span>
      </div>

      <!-- Footer: platform usage, cost, extra time -->
      <div id="earned-platform-usage" style="display: flex; align-items: center; gap: 16px; margin-top: 10px; font-size: 11px; color: rgba(255,255,255,0.4);">
        <span id="earned-yt-usage"></span>
        <span id="earned-ig-usage"></span>
        <span id="earned-fb-usage"></span>
        <span id="earned-extra-time-section" style="display: none; margin-left: auto;"><button id="earned-extra-time-btn" class="earned-extra-time-link">Request Extra Time</button></span>
      </div>
      <div style="display: flex; justify-content: space-between; margin-top: 6px; font-size: 11px; color: rgba(255,255,255,0.4);">
        <span id="earned-cost-indicator"></span>
        <span id="earned-deep-work" style="display: none;">Deep work active</span>
        <span id="earned-visits"></span>
      </div>
      <!-- Extra Time Flow -->
      <div id="earned-extra-time-flow" class="earned-extra-time-flow" style="display: none;">
        <div id="extra-time-step-amount" style="display: none;">
          <div style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 8px;">How much extra time?</div>
          <div class="extra-time-pills">
            <button class="extra-time-pill" data-minutes="15">15 min</button>
            <button class="extra-time-pill" data-minutes="30">30 min</button>
            <button class="extra-time-pill" data-minutes="60">60 min</button>
          </div>
          <div id="extra-time-send-error" class="extra-time-error" style="display: none;"></div>
          <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button id="extra-time-send" class="extra-time-action-btn" disabled>Send Request</button>
            <button class="extra-time-cancel-btn" data-action="cancel">Cancel</button>
          </div>
          <div id="extra-time-remaining" style="font-size: 11px; color: rgba(255,255,255,0.35); margin-top: 6px;"></div>
        </div>
        <div id="extra-time-step-code" style="display: none;">
          <div id="extra-time-code-msg" style="font-size: 12px; color: rgba(255,255,255,0.5); margin-bottom: 8px;"></div>
          <div class="extra-time-code-grid">
            <input class="extra-time-code-cell" type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-index="0">
            <input class="extra-time-code-cell" type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-index="1">
            <input class="extra-time-code-cell" type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-index="2">
            <input class="extra-time-code-cell" type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-index="3">
            <input class="extra-time-code-cell" type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-index="4">
            <input class="extra-time-code-cell" type="text" maxlength="1" inputmode="numeric" pattern="[0-9]" autocomplete="off" data-index="5">
          </div>
          <div id="extra-time-code-error" class="extra-time-error" style="display: none;"></div>
          <div style="display: flex; gap: 8px; margin-top: 10px;">
            <button id="extra-time-verify" class="extra-time-action-btn" disabled>Verify</button>
            <button class="extra-time-cancel-btn" data-action="cancel">Cancel</button>
          </div>
        </div>
        <div id="extra-time-step-success" style="display: none;">
          <div id="extra-time-success-msg" style="font-size: 13px; font-weight: 600; color: #34d399;"></div>
        </div>
      </div>
    </div>

    <!-- Profile setup (inline, shown when no profile exists) -->
    <div id="focus-profile-inline" class="focus-profile-inline" style="display:none;">
      <div style="font-size:14px;font-weight:600;margin-bottom:8px;">Tell us about yourself</div>
      <div class="setting-desc">This helps us judge which tabs and apps are relevant to your work.</div>
      <div class="setting-desc" style="margin-bottom:4px;color:rgba(255,255,255,0.3);font-size:11px;">
        What's your job or role? What do you do each day?
      </div>
      <textarea id="focus-profile" class="focus-textarea" rows="3"
        placeholder="e.g. I'm a software engineer building a React app. Most of my day is coding, reviewing PRs, and reading docs..."></textarea>
      <button class="btn-small" style="margin-top:10px;" onclick="saveProfileInline()">Save profile</button>
    </div>

    <!-- D. Collapsible Detail Sections -->
    <div style="margin-top: 24px;">
      <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapsible('goals')">
          <span class="collapsible-arrow" id="arrow-goals">â–¸</span>
          <span>Today's Goals</span>
        </div>
        <div class="collapsible-body" id="body-goals" style="display:none;">
          <div class="focus-goal-row">
            <span class="focus-goal-number">1</span>
            <input type="text" id="focus-goal-1" class="focus-goal-input" placeholder="Most important task...">
          </div>
          <div class="focus-goal-row">
            <span class="focus-goal-number">2</span>
            <input type="text" id="focus-goal-2" class="focus-goal-input" placeholder="Second priority...">
          </div>
          <div class="focus-goal-row">
            <span class="focus-goal-number">3</span>
            <input type="text" id="focus-goal-3" class="focus-goal-input" placeholder="Third priority...">
          </div>
        </div>
      </div>

      <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapsible('sessions')">
          <span class="collapsible-arrow" id="arrow-sessions">â–¸</span>
          <span>Today's Sessions</span>
        </div>
        <div class="collapsible-body" id="body-sessions" style="display:none;">
          <div id="journal-entries">
            <div class="journal-empty">No sessions yet today</div>
          </div>
        </div>
      </div>

      <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapsible('assessments')">
          <span class="collapsible-arrow" id="arrow-assessments">â–¸</span>
          <span>AI Assessments</span>
          <button class="copy-assessments-btn" onclick="event.stopPropagation(); sendMessage({type:'EXPORT_RELEVANCE_LOG'});" title="Open persistent log file">Open Log File</button>
          <button class="copy-assessments-btn" id="copyAssessmentsBtn" onclick="event.stopPropagation(); copyAssessments();">Copy</button>
        </div>
        <div class="collapsible-body" id="body-assessments" style="display:none;">
          <div id="relevance-log" style="max-height:300px;overflow-y:auto;">
            <div class="setting-row"><div class="setting-desc">No assessments yet</div></div>
          </div>
        </div>
      </div>

      <div class="collapsible-section">
        <div class="collapsible-header" onclick="toggleCollapsible('blocks')">
          <span class="collapsible-arrow" id="arrow-blocks">â–¸</span>
          <span>Per-Block Details</span>
        </div>
        <div class="collapsible-body" id="body-blocks" style="display:none;">
          <div id="score-block-breakdown">
            <div class="setting-row"><div class="setting-desc">No blocks completed yet</div></div>
          </div>
        </div>
      </div>
    </div>

  </div>

  <!-- Page: Distractions -->
  <div class="page" id="page-distractions">
    <div class="section-title">Distractions</div>

    <!-- ===== Distracting Websites ===== -->
    <div class="settings-card">
      <div class="settings-card-title">Distracting Websites</div>
      <div class="setting-desc" style="padding: 2px 20px 8px;">These sites are gated by your earned browse pool. When your time runs out, they're blocked.</div>
      <div class="distracting-sites-list" id="distracting-sites-list"></div>
      <div class="distracting-sites-add" id="distracting-sites-add">
        <input type="text" id="distracting-site-input" placeholder="e.g. reddit.com, twitter.com">
        <button type="button" onclick="addDistractingSite()">Add</button>
      </div>
    </div>

    <!-- ===== Distracting Apps ===== -->
    <div class="settings-card" style="margin-top: 16px;">
      <div class="settings-card-title">Distracting Apps</div>
      <div class="setting-desc" style="padding: 2px 20px 8px;">These apps are always marked as off-task during work blocks.</div>
      <div class="distracting-apps-list" id="distracting-apps-list"></div>
      <div class="distracting-sites-add" id="distracting-apps-add">
        <button type="button" class="distracting-apps-add-btn" onclick="showAppPicker()">+ Add App</button>
      </div>
    </div>

    <!-- App Picker Modal -->
    <div class="app-picker-modal" id="app-picker-modal" style="display: none;" onclick="if(event.target===this)hideAppPicker()">
      <div class="app-picker-card">
        <div class="app-picker-header">
          <span style="font-size: 16px; font-weight: 600; color: #fff;">Add Distracting App</span>
          <button class="app-picker-close" onclick="hideAppPicker()">&times;</button>
        </div>
        <input type="text" class="app-picker-search" id="app-picker-search" placeholder="Search apps..." oninput="filterAppPicker()">
        <div class="app-picker-list" id="app-picker-list"></div>
      </div>
    </div>

    <!-- ===== Content Filtering ===== -->
    <div class="platform-section-title" style="margin-top: 36px;">Content Filtering</div>

    <!-- ===== YouTube ===== -->
    <div class="platform-section-title">YouTube</div>

    <div class="settings-card">
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable YouTube filtering</div>
          <div class="setting-desc">AI checks video titles against your intent</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="yt-enabled" checked onchange="onSettingChange(); togglePlatformSettings('yt')">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>

    <div class="platform-settings-group" id="yt-settings-group">
      <div class="settings-card">
        <div class="settings-card-title">Filtering</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Relevance threshold</div>
            <div class="setting-desc">Higher = stricter filtering</div>
          </div>
          <input type="range" class="setting-range" id="yt-threshold" min="1" max="100" value="35" oninput="document.getElementById('yt-threshold-val').textContent = this.value + '%'; onSettingChange()">
          <span class="setting-value" id="yt-threshold-val">35%</span>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">Content Blocking</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block Shorts</div>
            <div class="setting-desc">Remove YouTube Shorts from feed</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="yt-block-shorts" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Hide sponsored content</div>
            <div class="setting-desc">Remove ads and sponsored videos</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="yt-hide-sponsored" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">Your Intentions</div>
        <div class="chip-container">
          <div class="chip-list" id="yt-categories-list" data-empty="No intentions added â€” the extension will ask each session"></div>
          <div class="chip-input-row">
            <input type="text" id="yt-category-input" placeholder="e.g. AI, cooking, programming..." />
            <button onclick="addChipItem('yt-categories', 'yt-category-input')">Add</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Instagram ===== -->
    <div class="platform-section-title">Instagram</div>

    <div class="settings-card">
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable Instagram filtering</div>
          <div class="setting-desc">AI checks images against your intent</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-enabled" checked onchange="onSettingChange(); togglePlatformSettings('ig')">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>

    <div class="platform-settings-group" id="ig-settings-group">
      <div class="settings-card">
        <div class="settings-card-title">Content Blocking</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block Reels</div>
            <div class="setting-desc">Remove video posts from feed and block /reels/</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="ig-block-reels" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block Explore page</div>
            <div class="setting-desc">Block access to /explore/</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="ig-block-explore" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">NSFW filter</div>
            <div class="setting-desc">Block adult content using image classification</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="ig-nsfw-filter" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Hide sponsored posts</div>
            <div class="setting-desc">Remove ads from feed</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="ig-hide-ads" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">Filtering</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Relevance threshold</div>
            <div class="setting-desc">Higher = stricter filtering</div>
          </div>
          <input type="range" class="setting-range" id="ig-threshold" min="1" max="100" value="35" oninput="document.getElementById('ig-threshold-val').textContent = this.value + '%'; onSettingChange()">
          <span class="setting-value" id="ig-threshold-val">35%</span>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">Content to Avoid</div>
        <div class="chip-container">
          <div class="chip-list" id="ig-blocked-categories-list" data-empty="No categories added"></div>
          <div class="chip-input-row">
            <input type="text" id="ig-blocked-category-input" placeholder="e.g. gossip, fitness, politics..." />
            <button onclick="addChipItem('ig-blocked-categories', 'ig-blocked-category-input')">Add</button>
          </div>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">Blocked Accounts</div>
        <div class="chip-container">
          <div class="chip-list" id="ig-blocked-accounts-list" data-empty="No accounts blocked"></div>
          <div class="chip-input-row">
            <input type="text" id="ig-blocked-account-input" placeholder="Instagram username..." />
            <button onclick="addChipItem('ig-blocked-accounts', 'ig-blocked-account-input')">Add</button>
          </div>
        </div>
      </div>
    </div>

    <!-- ===== Facebook ===== -->
    <div class="platform-section-title">Facebook</div>

    <div class="settings-card">
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable Facebook filtering</div>
          <div class="setting-desc">Route guards and feed filtering</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-enabled" checked onchange="onSettingChange(); togglePlatformSettings('fb')">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>

    <div class="platform-settings-group" id="fb-settings-group">
      <div class="settings-card">
        <div class="settings-card-title">Content Blocking</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block Watch videos</div>
            <div class="setting-desc">Block access to Facebook Watch</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="fb-block-watch" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block Reels</div>
            <div class="setting-desc">Block Facebook Reels</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="fb-block-reels" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block Marketplace</div>
            <div class="setting-desc">Block Facebook Marketplace</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="fb-block-marketplace" onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block Gaming</div>
            <div class="setting-desc">Block Facebook Gaming section</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="fb-block-gaming" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block Stories</div>
            <div class="setting-desc">Hide Stories from the top of your feed</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="fb-block-stories" onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
      </div>

      <div class="settings-card">
        <div class="settings-card-title">Feed Filtering</div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block sponsored posts</div>
            <div class="setting-desc">Remove ads and sponsored content from feed</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="fb-block-sponsored" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Block suggested content</div>
            <div class="setting-desc">Remove "Suggested for you" and "People you may know"</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="fb-block-suggested" checked onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Friends-only mode</div>
            <div class="setting-desc">Only show posts from friends in your feed</div>
          </div>
          <label class="toggle">
            <input type="checkbox" id="fb-friends-only" onchange="onSettingChange()">
            <span class="toggle-track"></span>
          </label>
        </div>
        <div class="setting-row">
          <div>
            <div class="setting-label">Scroll limit</div>
            <div class="setting-desc">Posts before "Time to refocus" wall (0 = off)</div>
          </div>
          <input type="number" class="setting-number" id="fb-scroll-limit" value="50" min="0" max="500" onchange="onSettingChange()">
          <span class="setting-value">posts</span>
        </div>
      </div>
    </div>

    <button class="save-btn" id="distractions-save-btn" onclick="saveSettingsBtn(this)">Save</button>
  </div>

  <!-- Page: Accountability / Lock -->
  <div class="page" id="page-lock">
    <div class="section-title">Accountability Partner</div>
    <div class="lock-container" id="lock-content">
      <div class="lock-icon">ðŸ”“</div>
      <div class="lock-title">Loading...</div>
    </div>
  </div>

  <!-- Page: Settings (Account + Browsers + Time Limits + Device + Reset & Delete) -->
  <div class="page" id="page-settings">
    <div class="section-title">Settings</div>

    <!-- Account Card -->
    <div class="settings-card">
      <div class="settings-card-title">Account</div>

      <!-- Account: Loading -->
      <div id="account-loading">
        <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 12px 0;">Checking...</p>
      </div>

      <!-- Account: Logged Out -->
      <div id="account-logged-out" style="display: none;">
        <p class="setting-desc" style="margin-bottom: 12px;">
          Sign in to sync settings across devices and recover after reinstall.
        </p>
        <div style="display: flex; flex-direction: column; gap: 12px; padding: 0 20px 8px;">
          <div>
            <div class="setting-label" style="padding: 0 0 4px;">Email</div>
            <input type="email" id="auth-email" class="setting-input" placeholder="you@example.com" style="width: 100%;">
          </div>
          <button class="btn-primary" id="auth-send-btn" onclick="authSendCode()">Send verification code</button>
          <p id="auth-login-error" class="setting-desc" style="color: #ef4444; display: none;"></p>
        </div>
      </div>

      <!-- Account: Code Entry -->
      <div id="account-code-entry" style="display: none;">
        <p class="setting-desc" style="margin-bottom: 12px;">
          We sent a 6-digit code to <strong id="auth-code-email" style="color: #fff;"></strong>
        </p>
        <div style="display: flex; flex-direction: column; gap: 12px; padding: 0 20px 8px;">
          <div>
            <div class="setting-label" style="padding: 0 0 4px;">Code</div>
            <input type="text" id="auth-code" class="setting-input" placeholder="000000" maxlength="6" style="width: 100%; letter-spacing: 4px; font-size: 18px;">
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button class="btn-primary" id="auth-verify-btn" onclick="authVerifyCode()">Verify</button>
            <a href="#" style="color: rgba(255,255,255,0.5); font-size: 13px; text-decoration: none;" onclick="authBackToEmail(); return false;">â† Back</a>
          </div>
          <p id="auth-verify-error" class="setting-desc" style="color: #ef4444; display: none;"></p>
        </div>
      </div>

      <!-- Account: Signed In -->
      <div id="account-signed-in" style="display: none;">
        <div class="info-row">
          <span class="info-label">Email</span>
          <span class="info-value" id="account-email">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Member since</span>
          <span class="info-value" id="account-since">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Devices</span>
          <span class="info-value" id="account-devices">-</span>
        </div>
        <div style="padding: 12px 20px 8px;">
          <button class="btn-secondary" onclick="authSignOut()">Sign out</button>
        </div>
      </div>
    </div>

    <!-- Browsers Card -->
    <div class="settings-card" style="padding: 0; overflow: hidden;">
      <div class="settings-card-title" style="padding: 16px 20px 12px;">Browsers</div>
      <div class="browser-card" id="browser-card" style="border: none; border-radius: 0;">
        <div class="empty-state" id="browser-empty" style="padding: 20px;">
          <div class="empty-state-text" style="font-size: 13px;">Loading browser status...</div>
        </div>
      </div>
    </div>

    <!-- Focus Plan Card -->
    <div class="settings-card">
      <div class="settings-card-title">Focus Plan</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable Daily Focus Plan</div>
          <div class="setting-desc">Structure your day with time blocks and get nudges when you drift off-task</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="focus-enabled" onchange="onFocusEnabledChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block irrelevant tabs</div>
          <div class="setting-desc">Redirect off-task browser tabs during work blocks</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="focus-enforcement" checked onchange="onFocusEnforcementChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">AI Model</div>
          <div class="setting-desc">Model used for relevance scoring</div>
        </div>
        <select class="setting-select" id="ai-model-select" onchange="onAIModelChange()">
          <option value="apple">Apple (3B, fast)</option>
          <option value="qwen">Qwen3 4B (slower, smarter)</option>
        </select>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Focus Profile</div>
          <div class="setting-desc">Describes your work so we can judge relevance</div>
        </div>
        <button class="btn-small" onclick="navigateTo('today')" style="white-space:nowrap;">Edit profile</button>
      </div>
    </div>

    <!-- Enforcement Settings Card -->
    <div class="settings-card" id="enforcement-settings-card">
      <div class="settings-card-title">Enforcement Settings</div>
      <style>
        .enf-grid {
          display: grid;
          grid-template-columns: 1fr 80px 80px;
          gap: 0;
          margin-top: 4px;
        }
        .enf-grid .enf-header {
          font-size: 12px;
          font-weight: 600;
          padding: 0 0 10px 0;
          text-align: center;
        }
        .enf-grid .enf-row {
          display: contents;
        }
        .enf-grid .enf-row > * {
          padding: 10px 0;
          border-top: 1px solid rgba(255,255,255,0.06);
        }
        .enf-grid .enf-label {
          font-size: 13px;
          color: rgba(255,255,255,0.85);
          display: flex;
          align-items: center;
        }
        .enf-grid .enf-toggle {
          display: flex;
          align-items: center;
          justify-content: center;
        }
        .enf-grid .enf-toggle .toggle {
          display: inline-block;
        }
      </style>
      <div class="enf-grid">
        <div></div>
        <div class="enf-header" style="color: #f87171;">Deep Work</div>
        <div class="enf-header" style="color: #818cf8;">Focus Hours</div>

        <div class="enf-row">
          <div class="enf-label">Nudge notifications</div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-dw-nudge" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-fh-nudge" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
        </div>

        <div class="enf-row">
          <div class="enf-label">Screen red shift</div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-dw-redshift" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-fh-redshift" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
        </div>

        <div class="enf-row">
          <div class="enf-label">Auto-redirect</div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-dw-redirect" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-fh-redirect" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
        </div>

        <div class="enf-row">
          <div class="enf-label">Blocking overlay</div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-dw-overlay" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-fh-overlay" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
        </div>

        <div class="enf-row">
          <div class="enf-label">Intervention exercises</div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-dw-intervention" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-fh-intervention" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
        </div>

        <div class="enf-row">
          <div class="enf-label">Background audio from distracting sites</div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-dw-audio" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
          <div class="enf-toggle"><label class="toggle"><input type="checkbox" id="enf-fh-audio" onchange="onEnforcementSettingChange()"><span class="toggle-track"></span></label></div>
        </div>
      </div>
    </div>

    <!-- Time Limits Card -->
    <div class="settings-card">
      <div class="settings-card-title">Time Limits</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Per-period limit</div>
          <div class="setting-desc">Max time within a rolling period</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="adv-period-enabled" onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Period minutes</div>
          <div class="setting-desc">Max minutes per period</div>
        </div>
        <input type="number" class="setting-number" id="adv-period-minutes" value="20" min="1" max="120" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Period length</div>
          <div class="setting-desc">Rolling period in hours</div>
        </div>
        <input type="number" class="setting-number" id="adv-period-hours" value="1" min="1" max="24" onchange="onSettingChange()">
        <span class="setting-value">hr</span>
      </div>
    </div>

    <!-- Device Card -->
    <div class="settings-card">
      <div class="settings-card-title">Device</div>
      <div class="info-row">
        <span class="info-label">Device ID</span>
        <span class="info-value" id="adv-device-id">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">Backend</span>
        <span class="info-value">api.intentional.social</span>
      </div>
      <div class="info-row">
        <span class="info-label">Version</span>
        <span class="info-value">1.0</span>
      </div>
    </div>

    <!-- Reset & Delete Card -->
    <div class="settings-card">
      <div class="settings-card-title">Reset & Delete</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Reset all settings</div>
          <div class="setting-desc">Clear settings and return to onboarding</div>
        </div>
        <button class="btn-danger" onclick="confirmReset()">Reset</button>
      </div>
      <div class="setting-row" id="delete-account-row" style="display: none;">
        <div>
          <div class="setting-label">Delete account</div>
          <div class="setting-desc">Permanently removes your account. Confirmation email required.</div>
        </div>
        <button class="btn-danger" id="auth-delete-btn" onclick="authDeleteAccount()">Delete</button>
      </div>
      <p id="auth-delete-msg" class="setting-desc" style="display: none; padding: 0 20px 12px;"></p>
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ===== Bridge =====
function sendMessage(payload) {
  if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.intentional) {
    window.webkit.messageHandlers.intentional.postMessage(payload);
  }
}

// ===== Settings State =====
var settings = {
  lockMode: 'none',
  partnerEmail: '',
  partnerName: '',
  consentStatus: 'none',
  maxPerPeriod: { enabled: false, minutes: 20, periodHours: 1 },
  temporaryUnlockUntil: null,
  selfUnlockAvailableAt: null,
  unlockRequested: false,
  youtube: {},
  instagram: {},
  facebook: {},
  deviceId: ''
};

var settingSaveTimer = null;

// ===== Toast =====
var toastTimer = null;
function showToast(msg, type) {
  var el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast visible' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() {
    el.className = 'toast';
  }, type === 'error' ? 4000 : 3000);
}

// ===== Navigation =====
function navigateTo(pageId) {
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.sidebar-item').forEach(function(s) { s.classList.remove('active'); });
  var page = document.getElementById('page-' + pageId);
  if (page) page.classList.add('active');
  var nav = document.querySelector('[data-page="' + pageId + '"]');
  if (nav) nav.classList.add('active');

  // Poll consent status when viewing accountability page with pending consent
  if (pageId === 'lock' && settings.consentStatus === 'pending') {
    sendMessage({ type: 'GET_PARTNER_STATUS' });
    startConsentPolling();
  } else {
    stopConsentPolling();
  }

  // Load account + browser status when viewing settings page
  if (pageId === 'settings') {
    loadAccountPage();
    sendMessage({ type: 'GET_EXTENSION_STATUS' });
    sendMessage({ type: 'GET_SCHEDULE_STATE' });
  }

  // Load all data when viewing Today page
  if (pageId === 'today') {
    sendMessage({ type: 'GET_JOURNAL' });
    loadFocusState();
    sendMessage({ type: 'GET_RELEVANCE_LOG' });
    relevanceLogTimer = setInterval(function() {
      sendMessage({ type: 'GET_RELEVANCE_LOG' });
    }, 5000);
  } else {
    if (calendarNowTimer) { clearInterval(calendarNowTimer); calendarNowTimer = null; }
    if (relevanceLogTimer) { clearInterval(relevanceLogTimer); relevanceLogTimer = null; }
  }
}

// ===== Collapsible Sections =====
function toggleCollapsible(id) {
  var body = document.getElementById('body-' + id);
  var arrow = document.getElementById('arrow-' + id);
  if (!body || !arrow) return;
  if (body.style.display === 'none') {
    body.style.display = 'block';
    arrow.classList.add('expanded');
  } else {
    body.style.display = 'none';
    arrow.classList.remove('expanded');
  }
}

// ===== Refresh Data =====
function refresh() {
  sendMessage({ type: 'GET_DASHBOARD_DATA' });
  sendMessage({ type: 'GET_EXTENSION_STATUS' });
  // Load journal if on Today page
  var todayPage = document.getElementById('page-today');
  if (todayPage && todayPage.classList.contains('active')) {
    sendMessage({ type: 'GET_JOURNAL' });
  }
}

// ===== HTML Escape =====
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ===== Button Loading States =====
function setButtonLoading(btnId, loadingText) {
  var btn = document.getElementById(btnId);
  if (!btn) return;
  btn._originalText = btn.textContent;
  btn.textContent = loadingText || 'Loading...';
  btn.disabled = true;
  btn.style.opacity = '0.6';
}

function clearButtonLoading(btnId) {
  var btn = document.getElementById(btnId);
  if (!btn) return;
  btn.textContent = btn._originalText || btn.textContent;
  btn.disabled = false;
  btn.style.opacity = '';
}

// ===== Chip/Tag Management =====
function renderChips(listId, items) {
  var list = document.getElementById(listId + '-list');
  if (!list) return;
  list.innerHTML = '';
  (items || []).forEach(function(item) {
    var chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = item + ' <span class="chip-remove" onclick="removeChipItem(\'' + listId + '\', \'' + item.replace(/'/g, "\\'") + '\')">&times;</span>';
    list.appendChild(chip);
  });
}

function getChipItems(listId) {
  var list = document.getElementById(listId + '-list');
  if (!list) return [];
  var chips = list.querySelectorAll('.chip');
  var items = [];
  chips.forEach(function(chip) {
    // Get text content minus the Ã— button
    var text = chip.childNodes[0].textContent.trim();
    if (text) items.push(text);
  });
  return items;
}

function addChipItem(listId, inputId) {
  var input = document.getElementById(inputId);
  if (!input) return;
  var value = input.value.trim().toLowerCase();
  if (!value) return;
  var items = getChipItems(listId);
  if (items.indexOf(value) === -1) {
    items.push(value);
    renderChips(listId, items);
    onSettingChange();
  }
  input.value = '';
  input.focus();
}

function removeChipItem(listId, value) {
  var items = getChipItems(listId);
  items = items.filter(function(i) { return i !== value; });
  renderChips(listId, items);
  onSettingChange();
}

// Wire Enter key for chip inputs
document.addEventListener('DOMContentLoaded', function() {
  ['yt-category-input', 'ig-blocked-category-input', 'ig-blocked-account-input'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) {
      el.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          var listId = id.replace('-input', '').replace('-category', '-categories').replace('-account', '-accounts');
          // Map input ID to list ID
          if (id === 'yt-category-input') listId = 'yt-categories';
          else if (id === 'ig-blocked-category-input') listId = 'ig-blocked-categories';
          else if (id === 'ig-blocked-account-input') listId = 'ig-blocked-accounts';
          addChipItem(listId, id);
        }
      });
    }
  });

  // Wire Enter key for distracting site input
  var dsInput = document.getElementById('distracting-site-input');
  if (dsInput) {
    dsInput.addEventListener('keydown', function(e) {
      if (e.key === 'Enter') { e.preventDefault(); addDistractingSite(); }
    });
  }

  // Set up lock interceptors on toggle checkboxes
  setupLockInterceptors();

  // Initialize extra time request flow
  initExtraTimeFlow();
});

// ===== Distracting Sites Management =====
var PINNED_SITES = [
  { domain: 'youtube.com', icon: 'â–¶ï¸', badge: 'Filtering' },
  { domain: 'instagram.com', icon: 'ðŸ“·', badge: 'Filtering' },
  { domain: 'facebook.com', icon: 'ðŸ‘¤', badge: 'Filtering' }
];
var customDistractingSites = [];
var disabledPlatforms = [];

function renderDistractingSites() {
  var list = document.getElementById('distracting-sites-list');
  if (!list) return;
  list.innerHTML = '';
  var locked = typeof isSettingsLocked === 'function' && isSettingsLocked();
  PINNED_SITES.forEach(function(site) {
    if (disabledPlatforms.indexOf(site.domain) !== -1) return; // Skip disabled platforms
    var div = document.createElement('div');
    div.className = 'distracting-site pinned';

    var icon = document.createElement('span');
    icon.className = 'distracting-site-icon';
    icon.textContent = site.icon;
    div.appendChild(icon);

    var domainEl = document.createElement('span');
    domainEl.className = 'distracting-site-domain';
    domainEl.textContent = site.domain;
    div.appendChild(domainEl);

    var badge = document.createElement('span');
    badge.className = 'distracting-site-badge';
    badge.textContent = site.badge;
    div.appendChild(badge);

    if (!locked) {
      var removeBtn = document.createElement('button');
      removeBtn.className = 'distracting-site-remove';
      removeBtn.title = 'Remove';
      removeBtn.textContent = 'Ã—';
      removeBtn.addEventListener('click', function() { disablePinnedSite(site.domain); });
      div.appendChild(removeBtn);
    }

    list.appendChild(div);
  });
  customDistractingSites.forEach(function(domain) {
    var div = document.createElement('div');
    div.className = 'distracting-site custom';

    var icon = document.createElement('span');
    icon.className = 'distracting-site-icon';
    icon.textContent = 'ðŸŒ';
    div.appendChild(icon);

    var domainEl = document.createElement('span');
    domainEl.className = 'distracting-site-domain';
    domainEl.textContent = domain;
    div.appendChild(domainEl);

    var badge = document.createElement('span');
    badge.className = 'distracting-site-badge custom';
    badge.textContent = 'Tracking';
    div.appendChild(badge);

    if (!locked) {
      var removeBtn = document.createElement('button');
      removeBtn.className = 'distracting-site-remove';
      removeBtn.title = 'Remove';
      removeBtn.textContent = 'Ã—';
      removeBtn.addEventListener('click', function() { removeDistractingSite(domain); });
      div.appendChild(removeBtn);
    }

    list.appendChild(div);
  });
}

function normalizeDomain(input) {
  if (!input) return null;
  var s = input.trim().toLowerCase();
  // Strip protocol
  s = s.replace(/^https?:\/\//, '');
  // Strip www.
  s = s.replace(/^www\./, '');
  // Strip path, query, hash, port
  s = s.split('/')[0].split('?')[0].split('#')[0].split(':')[0];
  // Must contain a dot
  if (s.indexOf('.') === -1) return null;
  if (s.length < 3) return null;
  return s;
}

function addDistractingSite() {
  var input = document.getElementById('distracting-site-input');
  if (!input) return;
  var domain = normalizeDomain(input.value);
  if (!domain) { input.value = ''; return; }
  // Check if re-enabling a disabled pinned site
  var isPinned = PINNED_SITES.some(function(s) { return s.domain === domain; });
  if (isPinned) {
    var idx = disabledPlatforms.indexOf(domain);
    if (idx !== -1) {
      disabledPlatforms.splice(idx, 1);
      renderDistractingSites();
      clearTimeout(settingSaveTimer);
      saveAllSettings();
    }
    input.value = '';
    return;
  }
  // Check duplicates
  if (customDistractingSites.indexOf(domain) !== -1) { input.value = ''; return; }
  customDistractingSites.push(domain);
  renderDistractingSites();
  input.value = '';
  input.focus();
  clearTimeout(settingSaveTimer);
  saveAllSettings();  // Immediate save â€” sites must persist before app close
}

function disablePinnedSite(domain) {
  if (disabledPlatforms.indexOf(domain) === -1) {
    disabledPlatforms.push(domain);
  }
  renderDistractingSites();
  clearTimeout(settingSaveTimer);
  saveAllSettings();  // Immediate save
}

function removeDistractingSite(domain) {
  customDistractingSites = customDistractingSites.filter(function(d) { return d !== domain; });
  renderDistractingSites();
  clearTimeout(settingSaveTimer);
  saveAllSettings();  // Immediate save â€” sites must persist before app close
}

// ===== Distracting Apps Management =====
var distractingApps = [];
var installedAppsCache = null;

function renderDistractingApps() {
  var list = document.getElementById('distracting-apps-list');
  if (!list) return;
  list.innerHTML = '';
  var locked = typeof isSettingsLocked === 'function' && isSettingsLocked();
  if (distractingApps.length === 0) {
    var empty = document.createElement('div');
    empty.className = 'distracting-apps-empty';
    empty.textContent = 'No apps added yet';
    list.appendChild(empty);
    return;
  }
  distractingApps.forEach(function(app) {
    var div = document.createElement('div');
    div.className = 'distracting-app';

    if (app.icon) {
      var icon = document.createElement('img');
      icon.className = 'distracting-app-icon';
      icon.src = 'data:image/png;base64,' + app.icon;
      div.appendChild(icon);
    } else {
      var iconPlaceholder = document.createElement('span');
      iconPlaceholder.style.cssText = 'width:24px;height:24px;display:flex;align-items:center;justify-content:center;font-size:16px;';
      iconPlaceholder.textContent = 'ðŸ“±';
      div.appendChild(iconPlaceholder);
    }

    var name = document.createElement('span');
    name.className = 'distracting-app-name';
    name.textContent = app.name;
    div.appendChild(name);

    if (!locked) {
      var removeBtn = document.createElement('button');
      removeBtn.className = 'distracting-app-remove';
      removeBtn.title = 'Remove';
      removeBtn.textContent = 'Ã—';
      removeBtn.addEventListener('click', function() { removeDistractingApp(app.bundleId); });
      div.appendChild(removeBtn);
    }

    list.appendChild(div);
  });
}

function addDistractingApp(app) {
  if (distractingApps.some(function(a) { return a.bundleId === app.bundleId; })) return;
  distractingApps.push({ name: app.name, bundleId: app.bundleId, icon: app.icon });
  renderDistractingApps();
  clearTimeout(settingSaveTimer);
  saveAllSettings();
}

function removeDistractingApp(bundleId) {
  distractingApps = distractingApps.filter(function(a) { return a.bundleId !== bundleId; });
  renderDistractingApps();
  clearTimeout(settingSaveTimer);
  saveAllSettings();
}

function showAppPicker() {
  var modal = document.getElementById('app-picker-modal');
  modal.style.display = 'flex';
  var search = document.getElementById('app-picker-search');
  search.value = '';
  search.focus();

  if (installedAppsCache) {
    renderAppPickerList(installedAppsCache);
  } else {
    document.getElementById('app-picker-list').innerHTML = '<div class="app-picker-loading">Loading apps...</div>';
    sendMessage({ type: 'GET_INSTALLED_APPS' });
  }
}

function hideAppPicker() {
  document.getElementById('app-picker-modal').style.display = 'none';
}

// Called from native app with installed apps list
window._installedAppsResult = function(apps) {
  installedAppsCache = apps;
  renderAppPickerList(apps);
};

function renderAppPickerList(apps) {
  var list = document.getElementById('app-picker-list');
  var search = document.getElementById('app-picker-search');
  var query = (search ? search.value : '').toLowerCase();

  var filtered = apps;
  if (query) {
    filtered = apps.filter(function(app) {
      return app.name.toLowerCase().indexOf(query) !== -1;
    });
  }

  list.innerHTML = '';
  if (filtered.length === 0) {
    list.innerHTML = '<div class="app-picker-loading">No apps found</div>';
    return;
  }

  filtered.forEach(function(app) {
    var row = document.createElement('div');
    row.className = 'app-picker-row';

    if (app.icon) {
      var icon = document.createElement('img');
      icon.className = 'app-picker-row-icon';
      icon.src = 'data:image/png;base64,' + app.icon;
      row.appendChild(icon);
    } else {
      var iconPlaceholder = document.createElement('span');
      iconPlaceholder.style.cssText = 'width:28px;height:28px;display:flex;align-items:center;justify-content:center;font-size:18px;';
      iconPlaceholder.textContent = 'ðŸ“±';
      row.appendChild(iconPlaceholder);
    }

    var name = document.createElement('span');
    name.className = 'app-picker-row-name';
    name.textContent = app.name;
    row.appendChild(name);

    var isAdded = distractingApps.some(function(a) { return a.bundleId === app.bundleId; });
    if (isAdded) {
      var badge = document.createElement('span');
      badge.className = 'app-picker-row-added';
      badge.textContent = 'Added';
      row.appendChild(badge);
    } else {
      row.addEventListener('click', function() {
        addDistractingApp(app);
        renderAppPickerList(installedAppsCache);
      });
    }

    list.appendChild(row);
  });
}

function filterAppPicker() {
  if (installedAppsCache) {
    renderAppPickerList(installedAppsCache);
  }
}

// ===== Platform Settings Collapse =====
function togglePlatformSettings(platform) {
  var toggle = document.getElementById(platform + '-enabled');
  var group = document.getElementById(platform + '-settings-group');
  if (!toggle || !group) return;
  if (toggle.checked) {
    group.classList.remove('collapsed');
  } else {
    group.classList.add('collapsed');
  }
}

function syncAllPlatformCollapses() {
  ['yt', 'ig', 'fb'].forEach(togglePlatformSettings);
}

// ===== Setting Change Handler (debounced save) =====
var _lockInterceptActive = false; // Set by lock interceptor to suppress normal save

function onSettingChange() {
  if (_lockInterceptActive) return; // Lock interceptor is handling this change
  clearTimeout(settingSaveTimer);
  settingSaveTimer = setTimeout(saveAllSettings, 800);
  // Reset save buttons to "Save" when settings change
  document.querySelectorAll('.save-btn').forEach(function(btn) {
    btn.textContent = 'Save';
    btn.classList.remove('saved');
  });
}

function saveSettingsBtn(btn) {
  clearTimeout(settingSaveTimer);
  btn.textContent = 'Saving...';
  btn.disabled = true;
  saveAllSettings();
  // The _saveSettingsResult callback will update the button
}

function saveAllSettings() {
  var ytSettings = {
    enabled: document.getElementById('yt-enabled').checked,
    threshold: parseInt(document.getElementById('yt-threshold').value) || 35,
    blockShorts: document.getElementById('yt-block-shorts').checked,
    hideSponsored: document.getElementById('yt-hide-sponsored').checked,
    blockMode: 'hide',
    zenDuration: 10,
    categories: getChipItems('yt-categories')
  };

  var igSettings = {
    enabled: document.getElementById('ig-enabled').checked,
    threshold: parseInt(document.getElementById('ig-threshold').value) || 35,
    blockReels: document.getElementById('ig-block-reels').checked,
    blockExplore: document.getElementById('ig-block-explore').checked,
    nsfwFilter: document.getElementById('ig-nsfw-filter').checked,
    hideAds: document.getElementById('ig-hide-ads').checked,
    blockedCategories: getChipItems('ig-blocked-categories'),
    blockedAccounts: getChipItems('ig-blocked-accounts')
  };

  var fbSettings = {
    enabled: document.getElementById('fb-enabled').checked,
    blockWatch: document.getElementById('fb-block-watch').checked,
    blockReels: document.getElementById('fb-block-reels').checked,
    blockMarketplace: document.getElementById('fb-block-marketplace').checked,
    blockGaming: document.getElementById('fb-block-gaming').checked,
    blockStories: document.getElementById('fb-block-stories').checked,
    blockSponsored: document.getElementById('fb-block-sponsored').checked,
    blockSuggested: document.getElementById('fb-block-suggested').checked,
    scrollLimit: parseInt(document.getElementById('fb-scroll-limit').value) || 0,
    friendsOnly: document.getElementById('fb-friends-only').checked
  };

  var maxPerPeriod = {
    enabled: document.getElementById('adv-period-enabled').checked,
    minutes: parseInt(document.getElementById('adv-period-minutes').value) || 20,
    periodHours: parseInt(document.getElementById('adv-period-hours').value) || 1
  };

  sendMessage({
    type: 'SAVE_SETTINGS',
    settings: {
      youtube: ytSettings,
      instagram: igSettings,
      facebook: fbSettings,
      lockMode: settings.lockMode,
      partnerEmail: settings.partnerEmail,
      partnerName: settings.partnerName,
      maxPerPeriod: maxPerPeriod,
      distractingSites: customDistractingSites,
      disabledPlatforms: disabledPlatforms,
      distractingApps: distractingApps.map(function(a) { return { name: a.name, bundleId: a.bundleId }; })
    }
  });
}

// Populate settings UI from loaded data
function populateSettingsUI(data) {
  if (data.youtube) {
    var yt = data.youtube;
    document.getElementById('yt-enabled').checked = yt.enabled !== false;
    document.getElementById('yt-threshold').value = yt.threshold || 35;
    document.getElementById('yt-threshold-val').textContent = (yt.threshold || 35) + '%';
    document.getElementById('yt-block-shorts').checked = yt.blockShorts !== false;
    document.getElementById('yt-hide-sponsored').checked = yt.hideSponsored !== false;
    renderChips('yt-categories', yt.categories || []);
  }

  if (data.instagram) {
    var ig = data.instagram;
    document.getElementById('ig-enabled').checked = ig.enabled !== false;
    document.getElementById('ig-threshold').value = ig.threshold || 35;
    document.getElementById('ig-threshold-val').textContent = (ig.threshold || 35) + '%';
    document.getElementById('ig-block-reels').checked = ig.blockReels !== false;
    document.getElementById('ig-block-explore').checked = ig.blockExplore !== false;
    document.getElementById('ig-nsfw-filter').checked = ig.nsfwFilter !== false;
    document.getElementById('ig-hide-ads').checked = ig.hideAds !== false;
    renderChips('ig-blocked-categories', ig.blockedCategories || []);
    renderChips('ig-blocked-accounts', ig.blockedAccounts || []);
  }

  if (data.facebook) {
    var fb = data.facebook;
    document.getElementById('fb-enabled').checked = fb.enabled !== false;
    document.getElementById('fb-block-watch').checked = fb.blockWatch !== false;
    document.getElementById('fb-block-reels').checked = fb.blockReels !== false;
    document.getElementById('fb-block-marketplace').checked = fb.blockMarketplace === true;
    document.getElementById('fb-block-gaming').checked = fb.blockGaming !== false;
    document.getElementById('fb-block-stories').checked = fb.blockStories === true;
    document.getElementById('fb-block-sponsored').checked = fb.blockSponsored !== false;
    document.getElementById('fb-block-suggested').checked = fb.blockSuggested !== false;
    document.getElementById('fb-scroll-limit').value = fb.scrollLimit !== undefined ? fb.scrollLimit : 50;
    document.getElementById('fb-friends-only').checked = fb.friendsOnly === true;
  }

  if (data.maxPerPeriod) {
    var mpp = data.maxPerPeriod;
    document.getElementById('adv-period-enabled').checked = mpp.enabled === true;
    document.getElementById('adv-period-minutes').value = mpp.minutes || 20;
    document.getElementById('adv-period-hours').value = mpp.periodHours || 1;
  }

  if (data.deviceId) {
    document.getElementById('adv-device-id').textContent = data.deviceId;
  }

  // Load custom distracting sites and disabled platforms
  customDistractingSites = data.distractingSites || [];
  disabledPlatforms = data.disabledPlatforms || [];
  renderDistractingSites();

  // Load distracting apps
  distractingApps = data.distractingApps || [];
  renderDistractingApps();

  // Sync platform collapse states after populating checkboxes
  syncAllPlatformCollapses();
}

// ===== Lock State Machine =====
function getLockState() {
  var mode = settings.lockMode || 'none';
  var consent = settings.consentStatus || 'none';
  var hasPartner = settings.partnerEmail && settings.partnerEmail !== '';

  // Check unlock state (permanent or temporary)
  if (settings.settingsUnlocked) return 'unlocked';
  if (settings.temporaryUnlockUntil) {
    var unlockEnd = new Date(settings.temporaryUnlockUntil).getTime();
    if (unlockEnd > Date.now()) {
      // Far-future sentinel (year 9000+) = permanently unlocked
      if (new Date(settings.temporaryUnlockUntil).getFullYear() >= 9000) return 'unlocked';
      return 'temporarily_unlocked';
    }
  }

  // Check self-lock countdown
  if (mode === 'self' && settings.selfUnlockAvailableAt) {
    var availAt = new Date(settings.selfUnlockAvailableAt).getTime();
    if (availAt > Date.now()) return 'self_countdown';
    // Timer expired but hasn't been verified yet â€” auto-verify will handle this
    // Don't fall through to unlock_code_entry (self-mode has no code)
  }

  // Check if we're waiting for unlock code entry (partner mode only)
  if (mode === 'partner' && settings.unlockRequested) return 'unlock_code_entry';

  // Consent states take priority over "locked" â€” if partner hasn't confirmed yet,
  // showing "locked" is wrong. Only show locked when consent is confirmed (or for self mode).
  if (hasPartner && consent === 'pending') return 'pending';
  if (hasPartner && consent === 'declined') return 'declined';
  if (hasPartner && consent === 'expired') return 'expired';

  // Now check actual lock state
  if (mode !== 'none') return 'locked';

  // Partner confirmed but no lock mode chosen yet
  if (hasPartner && consent === 'confirmed') return 'confirmed';

  return 'setup';
}

var selectedLockMode = 'none';

function selectLockMode(mode) {
  selectedLockMode = mode;
  document.querySelectorAll('.lock-mode-option').forEach(function(opt) {
    opt.classList.toggle('selected', opt.getAttribute('data-mode') === mode);
  });
  var partnerCard = document.getElementById('partner-fields-card');
  if (partnerCard) {
    partnerCard.style.display = (mode === 'none') ? 'none' : '';
  }
}

var countdownInterval = null;

function renderLockState() {
  var el = document.getElementById('lock-content');
  var state = getLockState();
  var email = escapeHtml(settings.partnerEmail || '');
  var name = escapeHtml(settings.partnerName || '');
  var partnerDisplay = name ? name + ' (' + email + ')' : email;

  // Clear any running countdown
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }

  switch (state) {
    case 'pending':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Invitation</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge pending">Pending</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Sent to</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">Your partner needs to click the confirmation link in their email before lock mode can be activated.</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="resend-invite-btn" onclick="resendInvite()">Resend Invitation</button>' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
        '</div>';
      startConsentPolling();
      break;

    case 'confirmed':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Status</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge confirmed">Confirmed</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">Your partner is ready. Choose how to lock your settings:</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="enable-partner-btn" onclick="enableLockMode(\'partner\')">Enable Partner Lock</button>' +
          '<button class="btn-secondary" id="enable-self-btn" onclick="enableLockMode(\'self\')">Enable 24-Hour Delay</button>' +
        '</div>' +
        '<div class="lock-btn-row" style="margin-top:8px;">' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
          '<button class="btn-danger" id="remove-partner-btn" onclick="removePartner()">Remove Partner</button>' +
        '</div>';
      stopConsentPolling();
      break;

    case 'locked':
      var mode = settings.lockMode || 'partner';
      var modeLabel = mode === 'partner' ? 'Partner Lock' : '24-Hour Delay';
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Lock Status</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge locked">Locked</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Mode</div>' +
            '<span class="setting-value">' + modeLabel + '</span>' +
          '</div>' +
          (partnerDisplay ?
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' : '') +
        '</div>' +
        '<div class="settings-card">' +
          '<div class="settings-card-title">Protected Settings</div>' +
          '<div class="setting-row"><div class="setting-label">Platform toggles (YouTube, Instagram, Facebook)</div></div>' +
          '<div class="setting-row"><div class="setting-label">Relevance thresholds</div></div>' +
          '<div class="setting-row"><div class="setting-label">Content blocking (Shorts, Reels, Watch)</div></div>' +
          '<div class="setting-row"><div class="setting-label">Blocked categories</div></div>' +
          '<div class="setting-row"><div class="setting-label">Free browse budgets</div></div>' +
        '</div>' +
        '<button class="btn-primary" id="request-unlock-btn" onclick="requestUnlock()" style="width:100%;margin-top:16px;">Request Unlock Code</button>';
      stopConsentPolling();
      break;

    case 'unlock_code_entry':
      var codeMode = settings.lockMode || 'partner';
      var codeMsg = codeMode === 'partner'
        ? 'A 6-digit code has been sent to your partner. Enter it below to temporarily unlock settings.'
        : 'Enter the 6-digit code you received to temporarily unlock settings.';
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Enter Unlock Code</div>' +
          '<div style="padding:24px 20px;text-align:center;">' +
            '<div class="lock-helper-text" style="padding:0;margin-bottom:20px;">' + codeMsg + '</div>' +
            '<input type="text" class="unlock-code-input" id="unlock-code" maxlength="6" placeholder="000000" oninput="onCodeInput(this)">' +
          '</div>' +
        '</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="verify-code-btn" onclick="verifyUnlockCode()" disabled>Verify Code</button>' +
          '<button class="btn-secondary" onclick="cancelUnlock()">Cancel</button>' +
        '</div>';
      setTimeout(function() {
        var inp = document.getElementById('unlock-code');
        if (inp) inp.focus();
      }, 100);
      stopConsentPolling();
      break;

    case 'self_countdown':
      var availAt = new Date(settings.selfUnlockAvailableAt).getTime();
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Unlock Request</div>' +
          '<div style="text-align:center;padding:24px 20px;">' +
            '<div style="font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:8px;">Time remaining</div>' +
            '<div class="countdown-display" id="countdown-timer" style="margin:12px 0;">--:--:--</div>' +
            '<div class="unlock-timer-bar"><div class="unlock-timer-fill" id="countdown-bar" style="width:100%;background:#f59e0b;"></div></div>' +
            '<div class="lock-helper-text" style="padding:0;margin-top:12px;">Settings will unlock automatically when the timer reaches zero.</div>' +
          '</div>' +
        '</div>' +
        '<button class="btn-secondary" onclick="cancelUnlock()" style="width:100%;margin-top:16px;">Cancel Request</button>';
      updateCountdown(availAt);
      countdownInterval = setInterval(function() {
        updateCountdown(availAt);
      }, 1000);
      stopConsentPolling();
      break;

    case 'unlocked':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Lock Status</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge unlocked">Unlocked</span>' +
          '</div>' +
          (partnerDisplay ?
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' : '') +
        '</div>' +
        '<div class="lock-helper-text">Settings are unlocked. Make your changes, then re-lock when done.</div>' +
        '<button class="btn-primary" onclick="relockSettings()" style="width:100%;">Re-lock Settings</button>' +
        '<div class="lock-btn-row" style="margin-top:8px;">' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
          '<button class="btn-danger" id="remove-partner-btn" onclick="removePartner()">Remove Partner</button>' +
        '</div>';
      stopConsentPolling();
      break;

    case 'temporarily_unlocked':
      var unlockEnd = new Date(settings.temporaryUnlockUntil).getTime();
      var totalMs = 5 * 60 * 1000;
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Temporary Unlock</div>' +
          '<div style="text-align:center;padding:24px 20px;">' +
            '<div style="font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:8px;">Time remaining</div>' +
            '<div class="countdown-display" id="unlock-countdown" style="color:#34d399;margin:12px 0;">--:--</div>' +
            '<div class="unlock-timer-bar"><div class="unlock-timer-fill" id="unlock-bar"></div></div>' +
            '<div class="lock-helper-text" style="padding:0;margin-top:12px;">Make your changes now. Lock re-engages when timer expires.</div>' +
          '</div>' +
        '</div>';
      updateUnlockCountdown(unlockEnd, totalMs);
      countdownInterval = setInterval(function() {
        updateUnlockCountdown(unlockEnd, totalMs);
      }, 1000);
      stopConsentPolling();
      break;

    case 'declined':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Invitation</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge declined">Declined</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">' + (name || email) + ' declined the accountability request. You can try a different partner.</div>' +
        '<div class="settings-card">' +
          '<div class="settings-card-title">New Partner</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Name</div>' +
            '<input class="setting-input" id="lock-partner-name" placeholder="Optional">' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Email</div>' +
            '<input class="setting-input" id="lock-partner-email" placeholder="partner@email.com" type="email">' +
          '</div>' +
        '</div>' +
        '<button class="btn-primary" id="save-lock-btn" onclick="saveLockSettings()" style="width:100%;margin-top:16px;">Save Lock Settings</button>';
      stopConsentPolling();
      break;

    case 'expired':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Invitation</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge expired">Expired</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Sent to</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">The invitation expired after 7 days without a response.</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="resend-invite-btn" onclick="resendInvite()">Resend Invitation</button>' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
        '</div>';
      stopConsentPolling();
      break;

    default: // 'setup'
      var noneSelected = selectedLockMode === 'none' || !selectedLockMode ? ' selected' : '';
      var partnerSelected = selectedLockMode === 'partner' ? ' selected' : '';
      var selfSelected = selectedLockMode === 'self' ? ' selected' : '';
      var showPartner = (selectedLockMode && selectedLockMode !== 'none') ? '' : ' style="display:none"';
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Lock Mode</div>' +
          '<div class="lock-mode-option' + noneSelected + '" data-mode="none" onclick="selectLockMode(\'none\')">' +
            '<div class="lock-mode-radio"></div>' +
            '<div>' +
              '<div class="setting-label">Unlocked</div>' +
              '<div class="setting-desc">Anyone can change settings freely</div>' +
            '</div>' +
          '</div>' +
          '<div class="lock-mode-option' + partnerSelected + '" data-mode="partner" onclick="selectLockMode(\'partner\')">' +
            '<div class="lock-mode-radio"></div>' +
            '<div>' +
              '<div class="setting-label">Partner Lock</div>' +
              '<div class="setting-desc">Partner receives unlock codes via email</div>' +
            '</div>' +
          '</div>' +
          '<div class="lock-mode-option' + selfSelected + '" data-mode="self" onclick="selectLockMode(\'self\')">' +
            '<div class="lock-mode-radio"></div>' +
            '<div>' +
              '<div class="setting-label">24-Hour Delay</div>' +
              '<div class="setting-desc">24-hour cooling period before settings can change</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="settings-card" id="partner-fields-card"' + showPartner + '>' +
          '<div class="settings-card-title">Accountability Partner</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Name</div>' +
            '<input class="setting-input" id="lock-partner-name" placeholder="Optional" value="' + name + '">' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Email</div>' +
            '<input class="setting-input" id="lock-partner-email" placeholder="partner@email.com" type="email" value="' + email + '">' +
          '</div>' +
        '</div>' +
        '<button class="btn-primary" id="save-lock-btn" onclick="saveLockSettings()" style="width:100%;margin-top:16px;">Save Lock Settings</button>';
      stopConsentPolling();
  }

  // Enforce lock on platform settings pages
  enforceLockMode();
}

// ===== Lock Enforcement on Settings Pages =====
var LOCKED_INPUT_IDS = [
  'yt-enabled', 'ig-enabled', 'fb-enabled',
  'yt-threshold', 'ig-threshold',
  'yt-block-shorts', 'ig-block-reels',
  'fb-block-watch', 'fb-block-reels', 'fb-block-marketplace',
  'fb-block-gaming', 'fb-block-stories',
  'fb-block-sponsored', 'fb-block-suggested', 'fb-friends-only',
  'yt-hide-sponsored',
  'adv-period-enabled', 'adv-period-minutes', 'adv-period-hours',
  'enf-dw-nudge', 'enf-dw-redshift', 'enf-dw-redirect', 'enf-dw-overlay', 'enf-dw-intervention',
  'enf-fh-nudge', 'enf-fh-redshift', 'enf-fh-redirect', 'enf-fh-overlay', 'enf-fh-intervention'
];

// Descriptions for the lock confirmation modal
var LOCK_CONFIRM_INFO = {
  'yt-enabled': { name: 'YouTube filtering', desc: 'YouTube videos will be filtered based on your stated intent.' },
  'ig-enabled': { name: 'Instagram filtering', desc: 'Instagram content will be filtered based on your settings.' },
  'fb-enabled': { name: 'Facebook filtering', desc: 'Facebook content will be filtered based on your settings.' },
  'yt-block-shorts': { name: 'Block YouTube Shorts', desc: 'YouTube Shorts will be completely removed from your feed.' },
  'ig-block-reels': { name: 'Block Instagram Reels', desc: 'Video posts and Reels will be removed from Instagram.' },
  'fb-block-watch': { name: 'Block Facebook Watch', desc: 'The Facebook Watch video section will be blocked.' },
  'fb-block-reels': { name: 'Block Facebook Reels', desc: 'Facebook Reels will be blocked.' },
  'fb-block-marketplace': { name: 'Block Marketplace', desc: 'Facebook Marketplace will be blocked.' },
  'fb-block-gaming': { name: 'Block Gaming', desc: 'The Facebook Gaming section will be blocked.' },
  'fb-block-stories': { name: 'Block Stories', desc: 'Facebook Stories will be hidden from the top of your feed.' },
  'fb-block-sponsored': { name: 'Block sponsored posts', desc: 'Sponsored posts and ads will be removed from your Facebook feed.' },
  'fb-block-suggested': { name: 'Block suggested content', desc: '"Suggested for you" and "People you may know" content will be removed.' },
  'fb-friends-only': { name: 'Friends-only mode', desc: 'Only posts from friends will appear in your feed.' }
};

function isSettingsLocked() {
  var state = getLockState();
  return state === 'locked' || state === 'unlock_code_entry' || state === 'self_countdown';
}

function enforceLockMode() {
  var locked = isSettingsLocked();

  // Fully locked inputs (pointer-events: none)
  LOCKED_INPUT_IDS.forEach(function(id) {
    var input = document.getElementById(id);
    if (!input) return;
    var row = input.closest('.setting-row');
    if (!row) return;

    if (locked) {
      // Checkbox toggles: OFF ones are confirmable, ON ones are fully locked
      if (input.type === 'checkbox' && !input.checked && LOCK_CONFIRM_INFO[id]) {
        row.classList.remove('locked');
        row.classList.add('lock-confirmable');
      } else {
        row.classList.add('locked');
        row.classList.remove('lock-confirmable');
      }
    } else {
      row.classList.remove('locked');
      row.classList.remove('lock-confirmable');
    }
  });

  // Add/remove locked banners on platform pages
  ['page-distractions'].forEach(function(pageId) {
    var page = document.getElementById(pageId);
    if (!page) return;
    var existingBanner = page.querySelector('.locked-banner');
    if (locked) {
      if (!existingBanner) {
        var banner = document.createElement('div');
        banner.className = 'locked-banner';
        banner.innerHTML = '<span>ðŸ”’</span> Settings are locked by your accountability partner. <a href="#" onclick="navigateTo(\'lock\'); return false;" style="color:#6366f1; text-decoration:underline;">Request unlock</a>';
        var firstCard = page.querySelector('.settings-card');
        if (firstCard) page.insertBefore(banner, firstCard);
      }
    } else {
      if (existingBanner) existingBanner.remove();
    }
  });
}

// ===== Lock Confirmation Modal =====
var _lockConfirmCallback = null;
var _lockInterceptorsSetup = false;

function showLockConfirm(inputId, callback) {
  var info = LOCK_CONFIRM_INFO[inputId];
  if (!info) { callback(false); return; }
  document.getElementById('lock-confirm-title').textContent = 'Enable ' + info.name + '?';
  document.getElementById('lock-confirm-desc').textContent = info.desc;
  document.getElementById('lock-confirm-warning').textContent = 'This change cannot be reversed while settings are locked.';
  document.getElementById('lock-confirm-modal').style.display = 'flex';
  _lockConfirmCallback = callback;
}

function closeLockConfirm(confirmed) {
  document.getElementById('lock-confirm-modal').style.display = 'none';
  if (_lockConfirmCallback) {
    _lockConfirmCallback(confirmed);
    _lockConfirmCallback = null;
  }
}

function setupLockInterceptors() {
  if (_lockInterceptorsSetup) return;
  _lockInterceptorsSetup = true;

  // Checkbox interceptors (existing)
  LOCKED_INPUT_IDS.forEach(function(id) {
    var input = document.getElementById(id);
    if (!input || input.type !== 'checkbox') return;

    input.addEventListener('change', function() {
      if (!isSettingsLocked()) return;

      _lockInterceptActive = true;
      setTimeout(function() { _lockInterceptActive = false; }, 50);

      if (input.checked) {
        input.checked = false;
        showLockConfirm(id, function(confirmed) {
          if (confirmed) {
            input.checked = true;
            var row = input.closest('.setting-row');
            if (row) {
              row.classList.add('locked');
              row.classList.remove('lock-confirmable');
            }
            _lockInterceptActive = false;
            onSettingChange();
          }
        });
      } else {
        input.checked = true;
      }
    }, true);
  });

}

// ===== Countdown Helpers =====
function updateCountdown(targetMs) {
  var el = document.getElementById('countdown-timer');
  if (!el) return;
  var diff = targetMs - Date.now();
  if (diff <= 0) {
    el.textContent = '00:00:00';
    // Countdown done - auto-unlock (no code needed for self-mode)
    if (countdownInterval) { clearInterval(countdownInterval); countdownInterval = null; }
    el.textContent = 'Unlocking...';
    sendMessage({ type: 'VERIFY_UNLOCK', code: '', auto_relock: false });
    return;
  }
  var hours = Math.floor(diff / 3600000);
  var mins = Math.floor((diff % 3600000) / 60000);
  var secs = Math.floor((diff % 60000) / 1000);
  el.textContent = pad(hours) + ':' + pad(mins) + ':' + pad(secs);
  // Update progress bar
  var bar = document.getElementById('countdown-bar');
  if (bar) {
    var totalMs = 24 * 3600000;
    bar.style.width = Math.max(0, (diff / totalMs) * 100) + '%';
  }
}

function updateUnlockCountdown(endMs, totalMs) {
  var countdownEl = document.getElementById('unlock-countdown');
  var barEl = document.getElementById('unlock-bar');
  if (!countdownEl) return;
  var diff = endMs - Date.now();
  if (diff <= 0) {
    countdownEl.textContent = '0:00';
    if (barEl) barEl.style.width = '0%';
    // Unlock window expired - go back to locked
    settings.temporaryUnlockUntil = null;
    renderLockState();
    return;
  }
  var mins = Math.floor(diff / 60000);
  var secs = Math.floor((diff % 60000) / 1000);
  countdownEl.textContent = mins + ':' + pad(secs);
  if (barEl) barEl.style.width = ((diff / totalMs) * 100) + '%';
}

function pad(n) { return n < 10 ? '0' + n : '' + n; }

// ===== Unlock Code Input =====
function onCodeInput(el) {
  el.value = el.value.replace(/[^0-9]/g, '');
  var btn = document.getElementById('verify-code-btn');
  if (btn) btn.disabled = el.value.length < 6;
}

function verifyUnlockCode() {
  var code = (document.getElementById('unlock-code') || {}).value || '';
  if (code.length < 6) return;
  setButtonLoading('verify-code-btn', 'Verifying...');
  sendMessage({ type: 'VERIFY_UNLOCK', code: code });
}

function cancelUnlock() {
  settings.unlockRequested = false;
  settings.selfUnlockAvailableAt = null;
  renderLockState();
}

function relockSettings() {
  settings.settingsUnlocked = false;
  settings.temporaryUnlockUntil = null;
  settings.unlockRequested = false;
  settings.selfUnlockAvailableAt = null;
  sendMessage({ type: 'RELOCK_SETTINGS' });
  showToast('Settings re-locked');
  renderLockState();
}

// ===== Lock Actions =====
function saveLockSettings() {
  var email = (document.getElementById('lock-partner-email') || {}).value || '';
  var name = (document.getElementById('lock-partner-name') || {}).value || '';

  if (selectedLockMode !== 'none' && !email) {
    showToast('Partner email is required for lock mode', 'error');
    return;
  }

  setButtonLoading('save-lock-btn', 'Saving...');
  settings.partnerEmail = email;
  settings.partnerName = name;

  sendMessage({
    type: 'SAVE_LOCK_SETTINGS',
    lockMode: selectedLockMode,
    partnerEmail: email,
    partnerName: name
  });
}

function enableLockMode(mode) {
  var btnId = mode === 'partner' ? 'enable-partner-btn' : 'enable-self-btn';
  setButtonLoading(btnId, 'Enabling...');
  sendMessage({
    type: 'SAVE_LOCK_SETTINGS',
    lockMode: mode,
    partnerEmail: settings.partnerEmail,
    partnerName: settings.partnerName
  });
}

function removePartner() {
  if (!confirm('Remove your accountability partner? This will also disable the lock.')) return;
  setButtonLoading('remove-partner-btn', 'Removing...');
  sendMessage({ type: 'REMOVE_PARTNER' });
}

function resendInvite() {
  setButtonLoading('resend-invite-btn', 'Sending...');
  sendMessage({ type: 'RESEND_PARTNER_INVITE' });
}

function changePartner() {
  settings.partnerEmail = '';
  settings.partnerName = '';
  settings.consentStatus = 'none';
  // Persist the clear to Swift so it survives app restart
  sendMessage({
    type: 'SAVE_LOCK_SETTINGS',
    lockMode: settings.lockMode || 'none',
    partnerEmail: '',
    partnerName: ''
  });
  stopConsentPolling();
  renderLockState();
}

function requestUnlock() {
  setButtonLoading('request-unlock-btn', 'Requesting...');
  sendMessage({ type: 'REQUEST_UNLOCK' });
}


function confirmReset() {
  if (confirm('Reset all settings and return to onboarding? This cannot be undone.')) {
    sendMessage({ type: 'RESET_SETTINGS' });
  }
}

function copyStoreUrl(el, url) {
  navigator.clipboard.writeText(url).then(function() {
    var original = el.textContent;
    el.textContent = 'Copied!';
    el.classList.add('copied');
    setTimeout(function() {
      el.textContent = original;
      el.classList.remove('copied');
    }, 1500);
  });
}

function installExtension(browserName, bundleId) {
  var name = decodeURIComponent(browserName).toLowerCase();
  var storeUrl;
  if (name.indexOf('firefox') !== -1 || name.indexOf('waterfox') !== -1 || name.indexOf('librewolf') !== -1 || name.indexOf('zen') !== -1 || name.indexOf('floorp') !== -1) {
    storeUrl = 'https://addons.mozilla.org/en-US/firefox/search/?q=intentional';
  } else if (name.indexOf('safari') !== -1 || name.indexOf('orion') !== -1) {
    storeUrl = 'https://apps.apple.com/search/intentional';
  } else {
    storeUrl = 'https://chromewebstore.google.com/search/intentional';
  }
  sendMessage({ type: 'OPEN_EXTENSIONS_PAGE', url: storeUrl, bundleId: bundleId || null });
}

// ===== Consent Polling =====
var consentPollTimer = null;

function startConsentPolling() {
  if (consentPollTimer) return;
  consentPollTimer = setInterval(function() {
    sendMessage({ type: 'GET_PARTNER_STATUS' });
  }, 10000);
}

function stopConsentPolling() {
  if (consentPollTimer) {
    clearInterval(consentPollTimer);
    consentPollTimer = null;
  }
}

// ===== Callbacks from Swift =====

// Settings loaded
window._settingsResult = function(data) {
  if (data.lockMode !== undefined) settings.lockMode = data.lockMode;
  if (data.partnerEmail !== undefined) settings.partnerEmail = data.partnerEmail || '';
  if (data.partnerName !== undefined) settings.partnerName = data.partnerName || '';
  if (data.consentStatus !== undefined) settings.consentStatus = data.consentStatus;
  if (data.temporaryUnlockUntil !== undefined) settings.temporaryUnlockUntil = data.temporaryUnlockUntil;
  if (data.selfUnlockAvailableAt !== undefined) settings.selfUnlockAvailableAt = data.selfUnlockAvailableAt;
  if (data.deviceId !== undefined) settings.deviceId = data.deviceId;

  populateSettingsUI(data);
  renderLockState();
};

// Save settings result
var _saveIndicatorTimeout = null;
window._saveSettingsResult = function(data) {
  if (data.success) {
    // Update save buttons
    document.querySelectorAll('.save-btn').forEach(function(btn) {
      btn.textContent = 'Saved';
      btn.classList.add('saved');
      btn.disabled = false;
    });
    // Show top-right indicator
    var indicator = document.getElementById('save-indicator');
    if (indicator) {
      indicator.textContent = 'Saved';
      indicator.style.color = 'rgba(52, 211, 153, 0.8)';
      indicator.classList.add('visible');
      clearTimeout(_saveIndicatorTimeout);
      _saveIndicatorTimeout = setTimeout(function() { indicator.classList.remove('visible'); }, 1500);
    }
  } else {
    document.querySelectorAll('.save-btn').forEach(function(btn) {
      btn.textContent = 'Save';
      btn.classList.remove('saved');
      btn.disabled = false;
    });
    showToast(data.message || 'Failed to save settings', 'error');
  }
};

// Lock settings saved
window._lockSettingsResult = function(data) {
  clearButtonLoading('save-lock-btn');
  settings.lockMode = data.lockMode || 'none';
  if (data.consentStatus) settings.consentStatus = data.consentStatus;
  if (data.partnerEmail !== undefined) settings.partnerEmail = data.partnerEmail || '';
  if (data.partnerName !== undefined) settings.partnerName = data.partnerName || '';

  renderLockState();

  if (data.success) {
    showToast(data.message || 'Lock settings saved');
  } else if (data.consentStatus === 'pending') {
    showToast('Partner invitation sent! Waiting for acceptance.', 'warning');
  } else {
    showToast(data.message || 'Failed to set lock mode', 'error');
  }
};

// Partner status (from polling)
window._partnerStatusResult = function(data) {
  if (!data.success) return;

  var changed = false;
  if (data.consentStatus && data.consentStatus !== settings.consentStatus) {
    settings.consentStatus = data.consentStatus;
    changed = true;
  }
  if (data.partnerEmail !== undefined && (data.partnerEmail || '') !== settings.partnerEmail) {
    settings.partnerEmail = data.partnerEmail || '';
    changed = true;
  }
  if (data.partnerName !== undefined && (data.partnerName || '') !== settings.partnerName) {
    settings.partnerName = data.partnerName || '';
    changed = true;
  }

  if (changed) {
    renderLockState();
  }
};

// Remove partner result
window._removePartnerResult = function(data) {
  if (data.success) {
    settings.partnerEmail = '';
    settings.partnerName = '';
    settings.consentStatus = 'none';
    settings.lockMode = 'none';
    settings.temporaryUnlockUntil = null;
    settings.selfUnlockAvailableAt = null;
    settings.unlockRequested = false;
    settings.settingsUnlocked = false;
    showToast('Partner removed');
  } else {
    showToast('Failed to remove partner', 'error');
  }
  renderLockState();
};

// Resend invite result
window._resendInviteResult = function(data) {
  clearButtonLoading('resend-invite-btn');
  if (data.success) {
    showToast(data.message || 'Invitation resent!');
  } else {
    showToast(data.message || 'Failed to resend invitation', 'error');
  }
};

// Unlock result
window._unlockResult = function(data) {
  if (data.success) {
    // Transition to code entry or countdown state
    if (settings.lockMode === 'self') {
      settings.selfUnlockAvailableAt = data.availableAt || new Date(Date.now() + 24 * 3600000).toISOString();
      showToast(data.message || 'Unlock countdown started');
    } else {
      settings.unlockRequested = true;
      showToast(data.message || 'Unlock code sent to your partner');
    }
    renderLockState();
  } else {
    clearButtonLoading('request-unlock-btn');
    showToast(data.message || 'Unlock request failed', 'error');
    if (data.message && data.message.indexOf('not locked') !== -1) {
      settings.lockMode = 'none';
      renderLockState();
    }
  }
};

// Verify unlock result
window._verifyUnlockResult = function(data) {
  if (data.success) {
    if (data.auto_relock === false) {
      showToast('Settings unlocked!');
      settings.settingsUnlocked = true;
      settings.temporaryUnlockUntil = null;
    } else {
      showToast('Settings unlocked for 5 minutes!');
      settings.temporaryUnlockUntil = data.unlockUntil || new Date(Date.now() + 5 * 60000).toISOString();
    }
    settings.unlockRequested = false;
    settings.selfUnlockAvailableAt = null;
    renderLockState();
  } else {
    clearButtonLoading('verify-code-btn');
    showToast(data.message || 'Invalid code', 'error');
  }
};

// Dashboard data
window._dashboardDataResult = function(data) {
  // Per-platform usage breakdown in earned browse widget
  var platforms = [
    { prefix: 'yt', key: 'youtube', label: 'YT' },
    { prefix: 'ig', key: 'instagram', label: 'IG' },
    { prefix: 'fb', key: 'facebook', label: 'FB' }
  ];
  platforms.forEach(function(p) {
    var d = data[p.key];
    if (!d) return;
    var used = d.minutesUsed || 0;
    var el = document.getElementById('earned-' + p.prefix + '-usage');
    if (el) {
      el.textContent = used > 0 ? (p.label + ': ' + used + ' min') : '';
    }
  });

  // Update earned browse state from dashboard data
  if (data.earnedBrowse) {
    window._earnedStatusResult(data.earnedBrowse);
  }
};

// Browser status
window._extensionStatusResult = function(data) {
  var card = document.getElementById('browser-card');
  var empty = document.getElementById('browser-empty');

  // Update monitoring indicator in header
  var dot = document.getElementById('monitoring-dot');
  var text = document.getElementById('monitoring-text');
  if (data.browsers && data.browsers.length > 0) {
    var connectedBrowsers = data.browsers.filter(function(b) { return b.hasExtension && b.isEnabled; });
    if (connectedBrowsers.length > 0) {
      if (dot) dot.className = 'status-dot active';
      if (text) {
        var names = connectedBrowsers.map(function(b) { return b.name; });
        text.textContent = names.length === 1 ? names[0] + ' connected' : names.length + ' browsers connected';
      }
    } else {
      if (dot) dot.className = 'status-dot inactive';
      if (text) text.textContent = 'No extension connected';
    }
  } else {
    if (dot) dot.className = 'status-dot inactive';
    if (text) text.textContent = 'No browsers detected';
  }

  if (!data.browsers || data.browsers.length === 0) {
    if (empty) {
      empty.innerHTML =
        '<div class="empty-state-icon">ðŸŒ</div>' +
        '<div class="empty-state-text">No browsers detected</div>';
    }
    return;
  }

  if (empty) empty.remove();

  // Sort: connected first, then alphabetical
  data.browsers.sort(function(a, b) {
    var aConn = (a.hasExtension && a.isEnabled) ? 0 : 1;
    var bConn = (b.hasExtension && b.isEnabled) ? 0 : 1;
    if (aConn !== bConn) return aConn - bConn;
    return a.name.localeCompare(b.name);
  });

  function getBrowserIcon(b) {
    if (b.iconDataUrl) {
      return '<span class="browser-icon"><img src="' + b.iconDataUrl + '" alt="' + escapeHtml(b.name) + '"></span>';
    }
    return '<span class="browser-icon" style="border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;background:#6B7280;">' + b.name.charAt(0).toUpperCase() + '</span>';
  }

  function getStoreUrl(name) {
    var n = name.toLowerCase();
    if (n.indexOf('firefox') !== -1 || n.indexOf('waterfox') !== -1 || n.indexOf('librewolf') !== -1 || n.indexOf('zen') !== -1 || n.indexOf('floorp') !== -1)
      return 'addons.mozilla.org';
    if (n.indexOf('safari') !== -1 || n.indexOf('orion') !== -1)
      return 'apps.apple.com';
    return 'chromewebstore.google.com';
  }

  function getFullStoreUrl(name) {
    var n = name.toLowerCase();
    if (n.indexOf('firefox') !== -1 || n.indexOf('waterfox') !== -1 || n.indexOf('librewolf') !== -1 || n.indexOf('zen') !== -1 || n.indexOf('floorp') !== -1)
      return 'https://addons.mozilla.org/en-US/firefox/search/?q=intentional';
    if (n.indexOf('safari') !== -1 || n.indexOf('orion') !== -1)
      return 'https://apps.apple.com/search/intentional';
    return 'https://chromewebstore.google.com/search/intentional';
  }

  card.innerHTML = data.browsers.map(function(b) {
    var icon = getBrowserIcon(b);
    var isConnected = b.hasExtension && b.isEnabled;
    var isDisabled = b.hasExtension && !b.isEnabled;
    var rowClass = 'browser-row' + (isConnected ? ' browser-connected' : '');
    var storeHint = getStoreUrl(b.name);
    var fullUrl = getFullStoreUrl(b.name);

    var statusHtml;
    if (isConnected) {
      statusHtml = '<span class="browser-status connected"><span class="browser-status-dot connected"></span>Connected</span>';
    } else if (isDisabled) {
      statusHtml = '<span class="browser-status" style="color: #f59e0b;">Disabled</span>';
    } else {
      statusHtml = '<button class="browser-install-btn" onclick="installExtension(\'' + encodeURIComponent(b.name) + '\', \'' + (b.bundleId || '') + '\')">Install</button>';
    }

    return '<div class="' + rowClass + '">' +
      icon +
      '<span class="browser-name">' + escapeHtml(b.name) + '</span>' +
      '<span class="browser-ext-url" onclick="copyStoreUrl(this, \'' + fullUrl + '\')" title="Click to copy store URL">' + storeHint + '</span>' +
      statusHtml +
    '</div>';
  }).join('');
};

// ===== Account Auth =====
var authPendingEmail = '';

function showAccountState(state) {
  document.getElementById('account-loading').style.display = state === 'loading' ? 'block' : 'none';
  document.getElementById('account-logged-out').style.display = state === 'logged-out' ? 'block' : 'none';
  document.getElementById('account-code-entry').style.display = state === 'code-entry' ? 'block' : 'none';
  document.getElementById('account-signed-in').style.display = state === 'signed-in' ? 'block' : 'none';
}

// ===== Weekly Usage History =====
window._usageHistoryResult = function(data) {
  var container = document.getElementById('weekly-usage');
  if (!container) return;

  if (!data || !data.success || !data.data || data.data.length === 0) {
    container.innerHTML = '<div style="color: var(--text-secondary); font-size: 13px; padding: 16px 0;">No history yet. Check back tomorrow.</div>';
    return;
  }

  // Aggregate by date across platforms
  var byDate = {};
  data.data.forEach(function(row) {
    if (!byDate[row.date]) byDate[row.date] = 0;
    byDate[row.date] += row.minutes_used || 0;
  });

  // Get last 7 days (fill in missing dates with 0)
  var dates = [];
  var today = new Date();
  for (var i = 6; i >= 0; i--) {
    var d = new Date(today);
    d.setDate(d.getDate() - i);
    var key = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0');
    dates.push(key);
  }

  var todayKey = dates[dates.length - 1];
  var maxMin = 1; // Minimum 1 to avoid division by zero
  dates.forEach(function(d) { maxMin = Math.max(maxMin, byDate[d] || 0); });

  var html = '<div class="weekly-bars">';
  dates.forEach(function(date) {
    var mins = Math.round(byDate[date] || 0);
    var pct = (mins / maxMin * 100);
    var dayLabel = new Date(date + 'T12:00:00').toLocaleDateString('en', { weekday: 'short' });
    var isToday = date === todayKey;
    html += '<div class="weekly-bar-col' + (isToday ? ' weekly-bar-today' : '') + '">';
    html += '  <div class="weekly-bar-value">' + (mins > 0 ? mins + 'm' : '') + '</div>';
    html += '  <div class="weekly-bar-track"><div class="weekly-bar-fill" style="height:' + pct + '%"></div></div>';
    html += '  <div class="weekly-bar-label">' + dayLabel + '</div>';
    html += '</div>';
  });
  html += '</div>';
  container.innerHTML = html;
};

window._journalResult = function(data) {
  var container = document.getElementById('journal-entries');
  if (!container) return;

  if (!data || !data.success || !data.sessions || data.sessions.length === 0) {
    container.innerHTML = '<div class="journal-empty">No sessions yet today</div>';
    return;
  }

  var platformIcons = { youtube: '\u25b6\ufe0f', instagram: '\ud83d\udcf7', facebook: '\ud83d\udc64' };
  var html = '';

  data.sessions.forEach(function(s) {
    var startDate = new Date(s.started_at);
    var time = startDate.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
    var icon = platformIcons[s.platform] || '\ud83c\udf10';
    var mins = Math.round(s.duration_seconds / 60);
    var intentText = s.free_browse ? 'Free Browse' : (s.intent || 'No intent set');
    var intentClass = s.free_browse ? 'journal-intent free-browse' : 'journal-intent';

    var durationHtml = mins + ' min';
    if (s.planned_duration_seconds && s.duration_seconds > s.planned_duration_seconds) {
      var planned = Math.round(s.planned_duration_seconds / 60);
      durationHtml += ' <span class="journal-over">(planned: ' + planned + 'm)</span>';
    }

    html += '<div class="journal-entry">';
    html += '<span class="journal-time">' + time + '</span>';
    html += '<span class="journal-platform">' + icon + '</span>';
    html += '<span class="' + intentClass + '">' + intentText + '</span>';
    html += '<span class="journal-duration">' + durationHtml + '</span>';
    html += '</div>';
  });

  container.innerHTML = html;
};

function loadAccountPage() {
  showAccountState('loading');
  sendMessage({ type: 'GET_AUTH_STATE' });
}

window._authStateResult = function(data) {
  if (data.loggedIn) {
    document.getElementById('account-email').textContent = data.email;
    document.getElementById('account-since').textContent = formatAccountDate(data.createdAt);
    document.getElementById('account-devices').textContent = data.deviceCount + ' linked';
    showAccountState('signed-in');
    var delRow = document.getElementById('delete-account-row');
    if (delRow) delRow.style.display = '';
  } else {
    showAccountState('logged-out');
    var delRow = document.getElementById('delete-account-row');
    if (delRow) delRow.style.display = 'none';
  }
};

function authSendCode() {
  var email = document.getElementById('auth-email').value.trim();
  if (!email || email.indexOf('@') === -1) {
    document.getElementById('auth-login-error').textContent = 'Please enter a valid email.';
    document.getElementById('auth-login-error').style.display = 'block';
    return;
  }
  document.getElementById('auth-login-error').style.display = 'none';
  document.getElementById('auth-send-btn').disabled = true;
  document.getElementById('auth-send-btn').textContent = 'Sending...';
  authPendingEmail = email;
  sendMessage({ type: 'AUTH_LOGIN', email: email });
}

window._authLoginResult = function(data) {
  document.getElementById('auth-send-btn').disabled = false;
  document.getElementById('auth-send-btn').textContent = 'Send verification code';
  if (data.success) {
    document.getElementById('auth-code-email').textContent = authPendingEmail;
    document.getElementById('auth-code').value = '';
    document.getElementById('auth-verify-error').style.display = 'none';
    showAccountState('code-entry');
  } else {
    document.getElementById('auth-login-error').textContent = data.message;
    document.getElementById('auth-login-error').style.display = 'block';
  }
};

function authVerifyCode() {
  var code = document.getElementById('auth-code').value.trim();
  if (!code || code.length !== 6) {
    document.getElementById('auth-verify-error').textContent = 'Please enter the 6-digit code.';
    document.getElementById('auth-verify-error').style.display = 'block';
    return;
  }
  document.getElementById('auth-verify-error').style.display = 'none';
  document.getElementById('auth-verify-btn').disabled = true;
  document.getElementById('auth-verify-btn').textContent = 'Verifying...';
  sendMessage({ type: 'AUTH_VERIFY', email: authPendingEmail, code: code });
}

window._authVerifyResult = function(data) {
  document.getElementById('auth-verify-btn').disabled = false;
  document.getElementById('auth-verify-btn').textContent = 'Verify';
  if (data.success) {
    showToast('Signed in successfully');
    loadAccountPage();
  } else {
    document.getElementById('auth-verify-error').textContent = data.message;
    document.getElementById('auth-verify-error').style.display = 'block';
  }
};

function authBackToEmail() {
  document.getElementById('auth-verify-error').style.display = 'none';
  showAccountState('logged-out');
}

function authSignOut() {
  sendMessage({ type: 'AUTH_LOGOUT' });
}

window._authLogoutResult = function(data) {
  showAccountState('logged-out');
  showToast('Signed out');
};

function authDeleteAccount() {
  if (!confirm('Are you sure? A confirmation email will be sent to finalize deletion.')) return;
  document.getElementById('auth-delete-btn').disabled = true;
  document.getElementById('auth-delete-btn').textContent = 'Sending...';
  document.getElementById('auth-delete-msg').style.display = 'none';
  sendMessage({ type: 'AUTH_DELETE' });
}

window._authDeleteResult = function(data) {
  document.getElementById('auth-delete-btn').disabled = false;
  document.getElementById('auth-delete-btn').textContent = 'Delete';
  var msg = document.getElementById('auth-delete-msg');
  msg.textContent = data.message;
  msg.style.color = data.success ? '#34d399' : '#ef4444';
  msg.style.display = 'block';
};

function formatAccountDate(isoString) {
  if (!isoString) return '-';
  var d = new Date(isoString);
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
}

// ===== Focus Plan =====
var focusState = {
  enabled: false,
  profile: '',
  goals: ['', '', ''],
  dailyPlan: '',
  blocks: [],
  hasPlan: false,
  editingBlockId: null
};

var blockFocusData = {};  // { blockId: { focusScore, earnedMinutes, ... } }
var CALENDAR_START_HOUR = 0;
var CALENDAR_END_HOUR = 24;
var CALENDAR_HOUR_HEIGHT = 42;
var calendarZoomLevel = 42;
var calendarDragState = null;
var calendarNowTimer = null;
var calendarViewDate = null; // null = today, otherwise "yyyy-MM-dd"

var focusDirty = false; // tracks unsaved block changes
var goalSaveTimer = null;

function loadFocusState() {
  sendMessage({ type: 'GET_SCHEDULE_STATE' });
}

window._scheduleStateResult = function(data) {
  focusState.enabled = data.enabled || false;
  focusState.hasPlan = data.hasPlan || false;
  focusState.enforcement = data.focusEnforcement || 'block';
  if (data.profile !== undefined) focusState.profile = data.profile;
  if (data.goals) focusState.goals = data.goals;
  if (data.dailyPlan !== undefined) focusState.dailyPlan = data.dailyPlan;
  if (data.blocks) focusState.blocks = data.blocks;
  if (data.calendarZoom) {
    calendarZoomLevel = data.calendarZoom;
    CALENDAR_HOUR_HEIGHT = calendarZoomLevel;
  }
  calendarViewDate = null; // Reset to today view
  focusDirty = false;
  renderFocusPage();
  renderCalendar();
  updateDateNavUI();
  loadFocusScore();
  loadEarnedStatus();

  // Sync enforcement toggle in Settings
  var enfToggle = document.getElementById('focus-enforcement');
  if (enfToggle) enfToggle.checked = focusState.enforcement === 'block';

  // Sync AI model dropdown in Settings
  var modelSelect = document.getElementById('ai-model-select');
  if (modelSelect && data.aiModel) modelSelect.value = data.aiModel;

  // Sync enforcement settings toggles
  if (data.enforcementSettings) {
    populateEnforcementSettingsUI(data.enforcementSettings);
  }
};

window._focusEnabledResult = function(data) {
  if (data.success) showToast(data.enabled ? 'Focus plan enabled' : 'Focus plan disabled');
};

window._focusEnforcementResult = function(data) {
  if (data.success) showToast(data.mode === 'block' ? 'Tab blocking enabled' : 'Nudge-only mode');
};

function onFocusEnforcementChange() {
  var checked = document.getElementById('focus-enforcement').checked;
  sendMessage({ type: 'SET_FOCUS_ENFORCEMENT', mode: checked ? 'block' : 'nudge' });
}

function onAIModelChange() {
  var model = document.getElementById('ai-model-select').value;
  sendMessage({ type: 'SET_AI_MODEL', model: model });
}

window._aiModelResult = function(data) {
  if (data.success) showToast(data.model === 'qwen' ? 'Using Qwen3 4B (MLX)' : 'Using Apple Foundation Models');
};

// ===== Enforcement Settings =====
var enforcementSaveTimer = null;

function readEnforcementSettingsFromUI() {
  return {
    deepWork: {
      nudgeNotifications: document.getElementById('enf-dw-nudge').checked,
      screenRedShift: document.getElementById('enf-dw-redshift').checked,
      autoRedirect: document.getElementById('enf-dw-redirect').checked,
      blockingOverlay: document.getElementById('enf-dw-overlay').checked,
      interventionExercises: document.getElementById('enf-dw-intervention').checked,
      backgroundAudioDetection: document.getElementById('enf-dw-audio').checked
    },
    focusHours: {
      nudgeNotifications: document.getElementById('enf-fh-nudge').checked,
      screenRedShift: document.getElementById('enf-fh-redshift').checked,
      autoRedirect: document.getElementById('enf-fh-redirect').checked,
      blockingOverlay: document.getElementById('enf-fh-overlay').checked,
      interventionExercises: document.getElementById('enf-fh-intervention').checked,
      backgroundAudioDetection: document.getElementById('enf-fh-audio').checked
    }
  };
}

function populateEnforcementSettingsUI(enf) {
  if (!enf) return;
  var dw = enf.deepWork || {};
  var fh = enf.focusHours || {};
  document.getElementById('enf-dw-nudge').checked = dw.nudgeNotifications !== false;
  document.getElementById('enf-dw-redshift').checked = dw.screenRedShift !== false;
  document.getElementById('enf-dw-redirect').checked = dw.autoRedirect !== false;
  document.getElementById('enf-dw-overlay').checked = dw.blockingOverlay !== false;
  document.getElementById('enf-dw-intervention').checked = dw.interventionExercises !== false;
  document.getElementById('enf-dw-audio').checked = dw.backgroundAudioDetection !== false;
  document.getElementById('enf-fh-nudge').checked = fh.nudgeNotifications !== false;
  document.getElementById('enf-fh-redshift').checked = fh.screenRedShift !== false;
  document.getElementById('enf-fh-redirect').checked = fh.autoRedirect !== undefined ? fh.autoRedirect : false;
  document.getElementById('enf-fh-overlay').checked = fh.blockingOverlay !== undefined ? fh.blockingOverlay : false;
  document.getElementById('enf-fh-intervention').checked = fh.interventionExercises !== undefined ? fh.interventionExercises : false;
  document.getElementById('enf-fh-audio').checked = fh.backgroundAudioDetection !== undefined ? fh.backgroundAudioDetection : false;
}

function onEnforcementSettingChange() {
  if (enforcementSaveTimer) clearTimeout(enforcementSaveTimer);
  enforcementSaveTimer = setTimeout(saveEnforcementSettings, 300);
}

function saveEnforcementSettings() {
  var settings = readEnforcementSettingsFromUI();
  sendMessage({ type: 'SET_ENFORCEMENT_SETTINGS', settings: settings });
}

window._enforcementSettingsResult = function(data) {
  if (data.success) {
    showToast('Enforcement settings saved');
  } else {
    showToast(data.error || 'Failed to save enforcement settings');
  }
};

function navigateToEnforcementSection() {
  navigateTo('settings');
  setTimeout(function() {
    var card = document.getElementById('enforcement-settings-card');
    if (card) card.scrollIntoView({ behavior: 'smooth', block: 'start' });
  }, 150);
}

window._profileResult = function(data) {
  if (data.success) showToast('Profile saved');
};

window._scheduleResult = function(data) {
  if (data.success) {
    focusState.hasPlan = true;
    focusDirty = false;
  } else {
    showToast('Failed to save schedule', 'error');
  }
};

function onFocusEnabledChange() {
  var enabled = document.getElementById('focus-enabled').checked;
  focusState.enabled = enabled;
  sendMessage({ type: 'SET_FOCUS_ENABLED', enabled: enabled });
}

function saveProfileInline() {
  var profileText = (document.getElementById('focus-profile').value || '').trim();
  if (!profileText) return;
  focusState.profile = profileText;
  sendMessage({ type: 'SET_PROFILE', profile: profileText });
  var el = document.getElementById('focus-profile-inline');
  if (el) el.style.display = 'none';
}

function renderFocusPage() {
  // Toggle in settings
  var toggle = document.getElementById('focus-enabled');
  if (toggle) toggle.checked = focusState.enabled;

  // Profile inline card
  var profileEl = document.getElementById('focus-profile-inline');
  var hasProfile = focusState.profile && focusState.profile.trim().length > 0;
  if (profileEl) {
    profileEl.style.display = (focusState.enabled && !hasProfile) ? '' : 'none';
    var profileInput = document.getElementById('focus-profile');
    if (profileInput) profileInput.value = focusState.profile || '';
  }

  // Populate goal inputs
  for (var i = 0; i < 3; i++) {
    var el = document.getElementById('focus-goal-' + (i + 1));
    if (el && !el._focusGoalListening) {
      el.value = (focusState.goals && focusState.goals[i]) || '';
      el.addEventListener('blur', onGoalBlur);
      el._focusGoalListening = true;
    } else if (el) {
      el.value = (focusState.goals && focusState.goals[i]) || '';
    }
  }

  // Save button no longer needed (auto-save)
  var saveBtn = document.getElementById('focus-save-schedule-btn');
  if (saveBtn) saveBtn.style.display = 'none';
}

function onGoalBlur() {
  clearTimeout(goalSaveTimer);
  goalSaveTimer = setTimeout(saveGoals, 500);
}

function saveGoals() {
  var newGoals = [
    (document.getElementById('focus-goal-1').value || '').trim(),
    (document.getElementById('focus-goal-2').value || '').trim(),
    (document.getElementById('focus-goal-3').value || '').trim()
  ];
  // Only save if changed
  var changed = newGoals.some(function(g, i) { return g !== (focusState.goals[i] || ''); });
  if (!changed) return;
  focusState.goals = newGoals;

  // Auto-generate blocks if first time setting goals and no blocks yet
  if (focusState.blocks.length === 0 && newGoals.some(function(g) { return g; })) {
    autoGenerateBlocks();
    renderCalendarBlocks();
    markFocusDirty();
  }

  sendMessage({
    type: 'SET_SCHEDULE',
    blocks: focusState.blocks,
    goals: focusState.goals.filter(function(g) { return g; }),
    dailyPlan: focusState.dailyPlan
  });
}

var _autoSaveTimer = null;
function markFocusDirty() {
  focusDirty = true;
  // Auto-save with debounce (300ms) â€” no manual Save button needed
  clearTimeout(_autoSaveTimer);
  _autoSaveTimer = setTimeout(function() {
    autoSaveSchedule();
  }, 300);
}

function autoSaveSchedule() {
  focusState.goals = [
    (document.getElementById('focus-goal-1') || {}).value || '',
    (document.getElementById('focus-goal-2') || {}).value || '',
    (document.getElementById('focus-goal-3') || {}).value || ''
  ].map(function(g) { return g.trim(); });

  focusState.blocks.sort(function(a, b) {
    return (a.startHour * 60 + a.startMinute) - (b.startHour * 60 + b.startMinute);
  });

  sendMessage({
    type: 'SET_SCHEDULE',
    blocks: focusState.blocks,
    goals: focusState.goals.filter(function(g) { return g; }),
    dailyPlan: focusState.dailyPlan
  });
  focusDirty = false;
}

function autoGenerateBlocks() {
  var startMin = 9 * 60;
  var lunchStart = 12 * 60;
  var lunchEnd = 13 * 60;
  var lunchInserted = false;
  var activeGoals = focusState.goals.filter(function(g) { return g; });

  activeGoals.forEach(function(goal) {
    // Insert lunch break before this goal if it would overlap noon
    if (!lunchInserted && startMin + 90 > lunchStart && startMin < lunchEnd) {
      focusState.blocks.push({
        id: generateFocusUUID(), title: 'Lunch',
        startHour: Math.floor(startMin / 60), startMinute: startMin % 60,
        endHour: Math.floor((startMin + 60) / 60), endMinute: (startMin + 60) % 60,
        blockType: 'freeTime', isFree: true
      });
      startMin = startMin + 60 + 15;
      lunchInserted = true;
    }
    var endMin = startMin + 90;
    focusState.blocks.push({
      id: generateFocusUUID(), title: goal,
      startHour: Math.floor(startMin / 60), startMinute: startMin % 60,
      endHour: Math.floor(endMin / 60), endMinute: endMin % 60,
      blockType: 'focusHours', isFree: false
    });
    startMin = endMin + 15;
  });

  // Add lunch at end if it wasn't inserted mid-schedule
  if (!lunchInserted && activeGoals.length > 0) {
    focusState.blocks.push({
      id: generateFocusUUID(), title: 'Lunch',
      startHour: Math.floor(startMin / 60), startMinute: startMin % 60,
      endHour: Math.floor((startMin + 60) / 60), endMinute: (startMin + 60) % 60,
      blockType: 'freeTime', isFree: true
    });
  }
}

function generateFocusUUID() {
  return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
    var r = Math.random() * 16 | 0;
    return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
  });
}

// ---- Calendar Rendering ----

function renderCalendar() {
  var container = document.getElementById('calendar-container');
  if (!container) return;

  var gridHeight = (CALENDAR_END_HOUR - CALENDAR_START_HOUR) * CALENDAR_HOUR_HEIGHT;
  var html = '<div class="calendar-zoom-wrapper">' +
    '<span class="calendar-zoom-icon">-</span>' +
    '<input type="range" class="calendar-zoom-slider" id="calendar-zoom-slider" min="42" max="140" value="' + calendarZoomLevel + '">' +
    '<span class="calendar-zoom-icon">+</span>' +
    '<div class="calendar-focus-stats">' +
    '<span><span id="score-focused-time">--</span> focused</span>' +
    '<span><span id="score-offtask-time">--</span> off-task</span>' +
    '<span><span id="score-break-time">--</span> free</span>' +
    '</div>' +
    '</div>';
  html += '<div class="calendar-grid" id="calendar-grid" style="height:' + gridHeight + 'px;">';
  for (var h = CALENDAR_START_HOUR; h < CALENDAR_END_HOUR; h++) {
    var top = (h - CALENDAR_START_HOUR) * CALENDAR_HOUR_HEIGHT;
    html += '<div class="calendar-hour-row" style="top:' + top + 'px;">' +
      '<div class="calendar-hour-label">' + formatHourLabel(h) + '</div>' +
      '<div class="calendar-hour-track" data-hour="' + h + '" onclick="onCalendarHourClick(event,' + h + ')"></div>' +
      '</div>';
  }
  html += '</div>';
  container.innerHTML = html;

  initCalendarZoom();
  renderCalendarBlocks();
  renderNowLine();
  scrollCalendarToTime();

  if (calendarNowTimer) clearInterval(calendarNowTimer);
  calendarNowTimer = setInterval(renderNowLine, 60000);
}

function isBlockPast(block) {
  var now = new Date();
  var minuteOfDay = now.getHours() * 60 + now.getMinutes();
  var blockEnd = block.endHour * 60 + block.endMinute;
  return blockEnd <= minuteOfDay;
}

function isBlockActive(block) {
  var now = new Date();
  var minuteOfDay = now.getHours() * 60 + now.getMinutes();
  var blockStart = block.startHour * 60 + block.startMinute;
  var blockEnd = block.endHour * 60 + block.endMinute;
  return minuteOfDay >= blockStart && minuteOfDay < blockEnd;
}

function isBlockFuture(block) {
  return !isBlockPast(block) && !isBlockActive(block);
}

function renderCalendarBlocks() {
  var grid = document.getElementById('calendar-grid');
  if (!grid) return;
  grid.querySelectorAll('.calendar-block').forEach(function(el) { el.remove(); });

  focusState.blocks.forEach(function(block) {
    var startMin = block.startHour * 60 + block.startMinute;
    var endMin = block.endHour * 60 + block.endMinute;
    var dur = endMin - startMin;
    var top = ((startMin - CALENDAR_START_HOUR * 60) / 60) * CALENDAR_HOUR_HEIGHT;
    var height = (dur / 60) * CALENDAR_HOUR_HEIGHT;

    var el = document.createElement('div');
    var bt = block.blockType || (block.isFree ? 'freeTime' : 'focusHours');
    var blockClass = bt === 'deepWork' ? 'deep-work' : bt === 'freeTime' ? 'free-time' : 'focus-hours';
    el.className = 'calendar-block ' + blockClass;
    el.dataset.blockId = block.id;
    el.style.top = top + 'px';
    el.style.height = Math.max(height, 24) + 'px';

    if (isBlockPast(block)) {
      el.classList.add('past');
    } else if (isBlockActive(block)) {
      el.classList.add('active');
    }

    var timeStr = formatFocusTime(block.startHour, block.startMinute) + ' \u2013 ' +
                  formatFocusTime(block.endHour, block.endMinute);
    el.innerHTML = '<div class="calendar-block-title">' + escapeHtml(block.title || 'Untitled') + '</div>' +
      (height >= 40 ? '<div class="calendar-block-time">' + timeStr + '</div>' : '') +
      (bt === 'freeTime' ? '<div class="calendar-block-badge badge-free">free</div>' : '') +
      '<div class="calendar-block-resize top"></div>' +
      '<div class="calendar-block-resize bottom"></div>';

    el.addEventListener('click', function(e) {
      if (!e.target.classList.contains('calendar-block-resize') && !blockDragState) openBlockEditor(block.id, e);
    });
    el.addEventListener('mousedown', function(e) {
      if (e.target.classList.contains('calendar-block-resize')) return;
      startBlockDrag(block.id, e);
    });
    el.querySelector('.calendar-block-resize.top').addEventListener('mousedown', function(e) {
      e.stopPropagation(); startBlockResize(block.id, 'top', e);
    });
    el.querySelector('.calendar-block-resize.bottom').addEventListener('mousedown', function(e) {
      e.stopPropagation(); startBlockResize(block.id, 'bottom', e);
    });

    grid.appendChild(el);
  });
  updateBlockRings();
  renderEmptyState();
}

function updateBlockRings() {
  document.querySelectorAll('.calendar-block.deep-work, .calendar-block.focus-hours').forEach(function(el) {
    var blockId = el.dataset.blockId;
    var data = blockFocusData[blockId];
    var block = focusState.blocks.find(function(b) { return b.id === blockId; });
    if (!data || data.totalTicks === 0) {
      var existing = el.querySelector('.calendar-block-ring, .calendar-block-score-badge, .calendar-block-ring-pending');
      if (existing) existing.remove();
      // Show placeholder spinner for active blocks waiting for first tick
      if (block && isBlockActive(block)) {
        var height = parseFloat(el.style.height);
        if (height >= 30) {
          var pending = document.createElement('div');
          pending.className = 'calendar-block-ring-pending';
          pending.innerHTML = '<svg viewBox="0 0 42 42"><circle cx="21" cy="21" r="16" class="ring-bg"/></svg>' +
            '<div class="ring-text" style="color:rgba(255,255,255,0.3)">\u00b7\u00b7\u00b7</div>';
          el.appendChild(pending);
        }
      }
      return;
    }

    var score = data.focusScore || 0;
    var earned = data.earnedMinutes || 0;
    var nudges = data.nudgeCount || 0;
    var color = score >= 80 ? '#34d399' : score >= 50 ? '#f59e0b' : '#ef4444';
    var height = parseFloat(el.style.height);

    el.querySelectorAll('.calendar-block-ring, .calendar-block-score-badge, .calendar-block-ring-pending').forEach(function(x) { x.remove(); });

    var circumference = 100.53;
    var offset = circumference * (1 - score / 100);
    var ring = document.createElement('div');
    ring.className = 'calendar-block-ring';
    ring.innerHTML = '<svg viewBox="0 0 42 42">' +
      '<circle cx="21" cy="21" r="16" class="ring-bg"/>' +
      '<circle cx="21" cy="21" r="16" class="ring-fill" style="stroke:' + color + ';stroke-dashoffset:' + offset + '"/>' +
      '</svg>' +
      '<div class="ring-text" style="color:' + color + '">' + score + '%</div>' +
      (earned >= 0.1 ? '<div class="ring-earned">+' + earned.toFixed(1) + 'm</div>' : '');
    // Nudge badge removed
    ring.addEventListener('click', (function(bid) { return function(e) { e.stopPropagation(); openBlockAssessments(bid, e); }; })(blockId));
    el.appendChild(ring);
  });
}

// ---- Block Assessment Popover ----

var activeBlockPopover = null;

var KNOWN_BROWSERS = ['Google Chrome', 'Google Chrome Canary', 'Safari',
    'Microsoft Edge', 'Brave Browser', 'Arc', 'Firefox', 'Opera', 'Vivaldi'];

function aggregateAssessments(entries) {
  var map = {};
  // First pass: count enforcement events per key
  var eventCounts = {};
  entries.forEach(function(e) {
    if (e.isEvent) {
      var isBrowser = KNOWN_BROWSERS.indexOf(e.appName) !== -1;
      var key = (isBrowser && e.title && e.title !== e.appName) ? e.title : (e.appName || e.title || 'Unknown');
      if (!eventCounts[key]) eventCounts[key] = { nudge: 0, blocked: 0 };
      if (e.action === 'nudge') eventCounts[key].nudge++;
      else if (e.action === 'blocked') eventCounts[key].blocked++;
      return; // Skip events from time tick counting
    }
    var isBrowser = KNOWN_BROWSERS.indexOf(e.appName) !== -1;
    var key = (isBrowser && e.title && e.title !== e.appName) ? e.title : (e.appName || e.title || 'Unknown');
    if (!map[key]) {
      map[key] = { title: key, appName: isBrowser ? e.appName : '', ticks: 0, reason: e.reason || '', confidence: e.confidence || 0, _rel: 0, _irrel: 0, _neutral: 0, nudgeCount: 0, blockCount: 0 };
    }
    map[key].ticks++;
    if (e.reason) map[key].reason = e.reason;
    if (e.neutral) { map[key]._neutral++; }
    else if (e.relevant) { map[key]._rel++; }
    else { map[key]._irrel++; }
  });
  // Merge event counts into groups
  Object.keys(eventCounts).forEach(function(key) {
    if (map[key]) {
      map[key].nudgeCount += eventCounts[key].nudge;
      map[key].blockCount += eventCounts[key].blocked;
    }
  });
  var groups = Object.values(map);
  groups.forEach(function(g) {
    // Neutral if majority of ticks are neutral
    if (g._neutral > g._rel && g._neutral > g._irrel) {
      g.state = 'neutral';
    } else {
      g.state = g._rel >= g._irrel ? 'relevant' : 'irrelevant';
    }
    g.relevant = g.state === 'relevant';
    g.seconds = g.ticks * 10;
    delete g._rel; delete g._irrel; delete g._neutral;
  });
  groups.sort(function(a, b) { return b.ticks - a.ticks; });
  var totalTicks = groups.reduce(function(s, g) { return s + g.ticks; }, 0);
  groups.forEach(function(g) { g.pct = totalTicks > 0 ? Math.round(g.ticks / totalTicks * 100) : 0; });
  return { groups: groups, totalTicks: totalTicks };
}

function formatDuration(seconds) {
  if (seconds < 60) return seconds + 's';
  var m = Math.floor(seconds / 60);
  var s = seconds % 60;
  return s > 0 ? m + 'm ' + s + 's' : m + 'm';
}

function openBlockAssessments(blockId, event) {
  closeBlockAssessments();

  var block = focusState.blocks.find(function(b) { return b.id === blockId; });
  if (!block) return;

  var today = new Date();
  today.setHours(0, 0, 0, 0);
  var startTime = today.getTime() + (block.startHour * 60 + block.startMinute) * 60000;
  var endTime = today.getTime() + (block.endHour * 60 + block.endMinute) * 60000;

  var popover = document.createElement('div');
  popover.className = 'block-assessment-popover';
  popover.id = 'block-assessment-popover';

  var stats = blockFocusData[blockId];
  var score = stats ? stats.focusScore : 0;
  var color = score >= 80 ? '#34d399' : score >= 50 ? '#f59e0b' : '#ef4444';

  popover.innerHTML =
    '<div class="ba-header">' +
      '<div class="ba-header-title">' + escapeHtml(block.title || 'Untitled') + '</div>' +
      '<div class="ba-header-score" style="color:' + color + '">' + score + '%</div>' +
      '<button class="ba-header-close" onclick="closeBlockAssessments()">\u2715</button>' +
    '</div>' +
    '<div class="ba-summary" id="ba-summary">Loading...</div>' +
    '<div class="ba-timeline-content" id="ba-view-timeline">' +
      '<div class="ba-empty">Loading assessments...</div>' +
    '</div>';

  document.body.appendChild(popover);

  // Store block times for timeline rendering
  popover._blockStartTime = startTime;
  popover._blockEndTime = endTime;

  var calGrid = document.getElementById('calendar-grid');
  var calRect = calGrid ? calGrid.getBoundingClientRect() : { right: 400 };
  var popLeft = Math.min(calRect.right + 12, window.innerWidth - 340);
  var popTop = Math.min(event.clientY - 60, window.innerHeight - 460);
  popover.style.left = popLeft + 'px';
  popover.style.top = Math.max(60, popTop) + 'px';

  activeBlockPopover = popover;

  setTimeout(function() {
    document.addEventListener('mousedown', closeBlockAssessmentsOutside);
  }, 10);

  sendMessage({ type: 'GET_BLOCK_ASSESSMENTS', blockId: blockId, startTime: startTime, endTime: endTime });
}

function closeBlockAssessments() {
  var el = document.getElementById('block-assessment-popover');
  if (el) {
    if (el._loupeEls) el._loupeEls.forEach(function(e) { e.remove(); });
    el.remove();
  }
  activeBlockPopover = null;
  document.removeEventListener('mousedown', closeBlockAssessmentsOutside);
}

function closeBlockAssessmentsOutside(e) {
  var popover = document.getElementById('block-assessment-popover');
  if (popover && !popover.contains(e.target)) {
    closeBlockAssessments();
  }
}

function toggleBaReason(id) {
  var el = document.getElementById(id);
  var btn = document.getElementById(id + '-btn');
  if (!el) return;
  el.classList.toggle('visible');
  if (btn) btn.classList.toggle('open');
}

function buildChronologicalSegments(entries) {
  // Filter out events, sort by timestamp
  var ticks = entries.filter(function(e) { return !e.isEvent; });
  ticks.sort(function(a, b) { return a.timestamp - b.timestamp; });
  if (!ticks.length) return [];

  var segments = [];
  var cur = null;

  ticks.forEach(function(e) {
    var isBrowser = KNOWN_BROWSERS.indexOf(e.appName) !== -1;
    var key = (isBrowser && e.hostname) ? e.hostname : (e.appName || e.title || 'Unknown');

    if (!cur || cur.key !== key) {
      // Close previous segment
      if (cur) {
        cur.endMs = e.timestamp;
        cur.durationMs = cur.endMs - cur.startMs;
        segments.push(cur);
      }
      cur = {
        key: key,
        appName: e.appName || '',
        hostname: (isBrowser && e.hostname) ? e.hostname : '',
        startMs: e.timestamp,
        endMs: e.timestamp + 10000, // default 10s tick
        durationMs: 10000,
        titles: [],
        _rel: 0, _irrel: 0, _neutral: 0
      };
    } else {
      cur.endMs = e.timestamp + 10000;
      cur.durationMs = cur.endMs - cur.startMs;
    }

    // Collect unique titles
    if (e.title && cur.titles.indexOf(e.title) === -1 && e.title !== e.appName) {
      cur.titles.push(e.title);
    }
    if (e.neutral) cur._neutral++;
    else if (e.relevant) cur._rel++;
    else cur._irrel++;
  });

  // Push last segment
  if (cur) {
    segments.push(cur);
  }

  // Determine state for each segment
  segments.forEach(function(s) {
    if (s._neutral > s._rel && s._neutral > s._irrel) {
      s.state = 'neutral';
    } else {
      s.state = s._rel >= s._irrel ? 'relevant' : 'irrelevant';
    }
    delete s._rel; delete s._irrel; delete s._neutral;
  });

  // Merge segments shorter than 30s into their neighbor
  var MIN_DURATION_MS = 30000;
  var merged = [];
  segments.forEach(function(s) {
    if (merged.length && s.durationMs < MIN_DURATION_MS) {
      // Absorb into previous segment
      var prev = merged[merged.length - 1];
      prev.endMs = s.endMs;
      prev.durationMs = prev.endMs - prev.startMs;
      s.titles.forEach(function(t) {
        if (prev.titles.indexOf(t) === -1) prev.titles.push(t);
      });
    } else if (s.durationMs < MIN_DURATION_MS && !merged.length) {
      // First segment and it's short â€” still push it, next segment will absorb or it stays
      merged.push(s);
    } else {
      // Check if previous was short and should merge forward into this one
      if (merged.length && merged[merged.length - 1].durationMs < MIN_DURATION_MS) {
        var prev = merged[merged.length - 1];
        s.startMs = prev.startMs;
        s.durationMs = s.endMs - s.startMs;
        prev.titles.forEach(function(t) {
          if (s.titles.indexOf(t) === -1) s.titles.push(t);
        });
        merged[merged.length - 1] = s;
      } else {
        merged.push(s);
      }
    }
  });

  return merged;
}

function formatTimeShort(ms) {
  var d = new Date(ms);
  var h = d.getHours();
  var m = d.getMinutes();
  var ampm = h >= 12 ? 'PM' : 'AM';
  h = h % 12 || 12;
  return h + ':' + (m < 10 ? '0' : '') + m + ' ' + ampm;
}

function renderTimelineView(entries, segments, blockStartMs, blockEndMs) {
  var view = document.getElementById('ba-view-timeline');
  if (!view) return;
  if (!segments.length) {
    view.innerHTML = '<div class="ba-empty">No timeline data</div>';
    return;
  }

  var totalDurationMs = blockEndMs - blockStartMs;
  if (totalDurationMs <= 0) totalDurationMs = segments[segments.length - 1].endMs - segments[0].startMs;
  var midMs = blockStartMs + totalDurationMs / 2;

  // Build bar segments HTML
  var barHtml = '';
  segments.forEach(function(s, i) {
    var pct = Math.max(0.5, (s.durationMs / totalDurationMs) * 100);
    barHtml += '<div class="ba-timeline-seg ' + s.state + '" data-seg-idx="' + i + '" style="width:' + pct + '%"></div>';
  });

  // Build loupe inner (4x magnified copy of the bar)
  var loupeInnerHtml = '';
  segments.forEach(function(s) {
    var pct = Math.max(0.5, (s.durationMs / totalDurationMs) * 100);
    loupeInnerHtml += '<div class="ba-loupe-seg ' + s.state + '" style="width:' + pct + '%"></div>';
  });

  // Build axis
  var axisHtml = '<div class="ba-timeline-axis">' +
    '<span>' + formatTimeShort(blockStartMs) + '</span>' +
    '<span>' + formatTimeShort(midMs) + '</span>' +
    '<span>' + formatTimeShort(blockEndMs) + '</span>' +
  '</div>';

  // Build legend: aggregate by key, sorted by total time
  // Also pull reason + nudge/block counts from raw entries
  var legendMap = {};
  segments.forEach(function(s) {
    if (!legendMap[s.key]) {
      legendMap[s.key] = { key: s.key, appName: s.appName, hostname: s.hostname, totalMs: 0, state: s.state, reason: '', nudgeCount: 0, blockCount: 0, _rel: 0, _irrel: 0, _neutral: 0 };
    }
    legendMap[s.key].totalMs += s.durationMs;
    if (s.state === 'relevant') legendMap[s.key]._rel++;
    else if (s.state === 'irrelevant') legendMap[s.key]._irrel++;
    else legendMap[s.key]._neutral++;
  });
  entries.forEach(function(e) {
    var isBrowser = KNOWN_BROWSERS.indexOf(e.appName) !== -1;
    var key = (isBrowser && e.hostname) ? e.hostname : (e.appName || e.title || 'Unknown');
    if (!legendMap[key]) return;
    if (e.isEvent) {
      if (e.action === 'nudge') legendMap[key].nudgeCount++;
      else if (e.action === 'blocked') legendMap[key].blockCount++;
    } else if (e.reason && e.reason !== 'unchanged tab' && e.reason !== 'unchanged tab (irrelevant)' && e.reason !== 'Always-allowed app' && e.reason !== 'Neutral app') {
      legendMap[key].reason = e.reason;
    }
  });
  var legendItems = Object.values(legendMap);
  legendItems.forEach(function(l) {
    if (l._neutral > l._rel && l._neutral > l._irrel) l.state = 'neutral';
    else l.state = l._rel >= l._irrel ? 'relevant' : 'irrelevant';
    delete l._rel; delete l._irrel; delete l._neutral;
  });
  legendItems.sort(function(a, b) { return b.totalMs - a.totalMs; });
  var totalSegMs = legendItems.reduce(function(s, l) { return s + l.totalMs; }, 0);

  var legendHtml = '<div class="ba-timeline-legend">';
  legendItems.forEach(function(l, i) {
    var pct = totalSegMs > 0 ? Math.round(l.totalMs / totalSegMs * 100) : 0;
    var displayName = l.hostname || l.key;
    var rid = 'ba-tl-reason-' + i;
    legendHtml += '<div class="ba-timeline-legend-row" data-legend-key="' + escapeHtml(l.key) + '">' +
      '<div class="ba-dot ' + l.state + '"></div>' +
      '<div class="ba-timeline-legend-name">' + escapeHtml(displayName) + '</div>' +
      '<div class="ba-timeline-legend-time">' + formatDuration(Math.round(l.totalMs / 1000)) + '</div>' +
      '<div class="ba-timeline-legend-pct">' + pct + '%</div>' +
      (l.reason ? '<button class="ba-info-btn" id="' + rid + '-btn" onclick="toggleBaReason(\'' + rid + '\')" title="AI reasoning">\u2139</button>' : '') +
    '</div>' +
    (l.reason ? '<div class="ba-reason" id="' + rid + '" style="padding:0 14px 4px 29px">' + escapeHtml(l.reason) + '</div>' : '');
  });
  legendHtml += '</div>';

  // Assemble: bar wrapper (bar only) + detail strip + axis + legend
  view.innerHTML =
    '<div class="ba-timeline-bar-wrap" id="ba-timeline-bar-wrap">' +
      '<div class="ba-timeline-bar" id="ba-timeline-bar">' + barHtml + '</div>' +
    '</div>' +
    '<div class="ba-detail-strip" id="ba-detail-strip"></div>' +
    axisHtml + legendHtml;

  var bar = document.getElementById('ba-timeline-bar');
  var detailStrip = document.getElementById('ba-detail-strip');
  var activeDetailIdx = -1;

  // Create loupe as fixed-position element on body (escapes overflow clipping)
  var loupe = document.createElement('div');
  loupe.className = 'ba-loupe';
  loupe.style.display = 'none';
  loupe.innerHTML = '<div class="ba-loupe-inner" id="ba-loupe-inner">' + loupeInnerHtml + '</div>' +
    '<div class="ba-loupe-label" id="ba-loupe-label"></div>';
  document.body.appendChild(loupe);
  var loupeInner = loupe.querySelector('.ba-loupe-inner');
  var loupeLabel = loupe.querySelector('.ba-loupe-label');

  var loupeLine = document.createElement('div');
  loupeLine.className = 'ba-loupe-line';
  loupeLine.style.display = 'none';
  document.body.appendChild(loupeLine);

  // Store refs for cleanup on popover close
  var popover = document.getElementById('block-assessment-popover');
  if (popover) {
    popover._loupeEls = [loupe, loupeLine];
  }

  // Set loupe inner width to 4x the bar width for magnification
  var zoom = 4;
  loupeInner.style.width = (zoom * 100) + '%';

  // Magnifying loupe on hover â€” positioned below the bar
  bar.addEventListener('mousemove', function(ev) {
    var rect = bar.getBoundingClientRect();
    var x = ev.clientX - rect.left;
    var pct = x / rect.width;

    loupe.style.display = 'block';
    loupeLine.style.display = 'block';

    var loupeW = 120;
    var loupeScreenLeft = Math.max(rect.left, Math.min(ev.clientX - loupeW / 2, rect.right - loupeW));
    loupe.style.left = loupeScreenLeft + 'px';
    loupe.style.top = (rect.bottom + 4) + 'px';

    loupeLine.style.left = ev.clientX + 'px';
    loupeLine.style.top = rect.bottom + 'px';
    loupeLine.style.height = '4px';

    // Scroll inner content to center on cursor position
    var innerWidth = loupeInner.offsetWidth;
    var offset = -(pct * innerWidth - loupeW / 2);
    loupeInner.style.transform = 'translateX(' + offset + 'px)';

    // Show name of hovered segment
    var seg = ev.target.closest('.ba-timeline-seg');
    if (seg) {
      var idx = parseInt(seg.getAttribute('data-seg-idx'));
      var s = segments[idx];
      if (s) {
        var name = s.hostname || s.key;
        var durSec = Math.round(s.durationMs / 1000);
        loupeLabel.textContent = name + ' \u00b7 ' + formatDuration(durSec);
      }
    } else {
      loupeLabel.textContent = '';
    }
  });
  bar.addEventListener('mouseleave', function() {
    loupe.style.display = 'none';
    loupeLine.style.display = 'none';
  });

  // Click segment to expand detail strip
  bar.addEventListener('click', function(ev) {
    var seg = ev.target.closest('.ba-timeline-seg');
    if (!seg) return;
    var idx = parseInt(seg.getAttribute('data-seg-idx'));
    if (isNaN(idx)) return;

    // Toggle off if clicking same segment
    if (activeDetailIdx === idx) {
      detailStrip.classList.remove('open');
      activeDetailIdx = -1;
      return;
    }
    activeDetailIdx = idx;

    // Show context: previous, clicked, and next segments
    var range = [];
    for (var i = Math.max(0, idx - 1); i <= Math.min(segments.length - 1, idx + 2); i++) {
      range.push({ seg: segments[i], isFocused: i === idx });
    }

    var html = range.map(function(r) {
      var s = r.seg;
      var displayName = s.hostname || s.key;
      var titleStr = s.titles.length ? ' \u2014 ' + escapeHtml(s.titles[0]) : '';
      return '<div class="ba-detail-item" style="' + (r.isFocused ? 'color:rgba(255,255,255,0.9);font-weight:500' : '') + '">' +
        '<span class="ba-detail-time">' + formatTimeShort(s.startMs) + '</span>' +
        '<div class="ba-detail-dot ' + s.state + '"></div>' +
        '<span class="ba-detail-name">' + escapeHtml(displayName) + titleStr + ' (' + formatDuration(Math.round(s.durationMs / 1000)) + ')</span>' +
      '</div>';
    }).join('');

    detailStrip.innerHTML = html;
    detailStrip.classList.add('open');
  });

  // Legend row hover: highlight matching segments in bar
  view.querySelectorAll('.ba-timeline-legend-row').forEach(function(row) {
    var legendKey = row.getAttribute('data-legend-key');
    row.addEventListener('mouseenter', function() {
      bar.querySelectorAll('.ba-timeline-seg').forEach(function(seg) {
        var idx = parseInt(seg.getAttribute('data-seg-idx'));
        if (segments[idx] && segments[idx].key === legendKey) {
          seg.classList.add('highlight');
        } else {
          seg.classList.add('dimmed');
        }
      });
    });
    row.addEventListener('mouseleave', function() {
      bar.querySelectorAll('.ba-timeline-seg').forEach(function(seg) {
        seg.classList.remove('highlight', 'dimmed');
      });
    });
  });
}

window._blockAssessmentsResult = function(entries) {
  var timelineView = document.getElementById('ba-view-timeline');
  var summary = document.getElementById('ba-summary');
  if (!timelineView) return;

  if (!entries || !entries.length) {
    timelineView.innerHTML = '<div class="ba-empty">No assessments recorded for this block</div>';
    if (summary) summary.textContent = 'No data yet';
    return;
  }

  var data = aggregateAssessments(entries);

  var relCount = data.groups.filter(function(g) { return g.state === 'relevant'; }).length;
  var irrelCount = data.groups.filter(function(g) { return g.state === 'irrelevant'; }).length;
  var neutralCount = data.groups.filter(function(g) { return g.state === 'neutral'; }).length;
  var totalTime = formatDuration(data.totalTicks * 10);
  if (summary) {
    var parts = data.groups.length + ' apps \u00b7 ' + relCount + ' relevant \u00b7 ' + irrelCount + ' irrelevant';
    if (neutralCount > 0) parts += ' \u00b7 ' + neutralCount + ' neutral';
    parts += ' \u00b7 ' + totalTime + ' tracked';
    summary.textContent = parts;
  }

  var popover = document.getElementById('block-assessment-popover');
  var blockStartMs = popover ? popover._blockStartTime : entries[0].timestamp;
  var blockEndMs = popover ? popover._blockEndTime : entries[entries.length - 1].timestamp;
  var segments = buildChronologicalSegments(entries);
  renderTimelineView(entries, segments, blockStartMs, blockEndMs);
};

function renderNowLine() {
  var grid = document.getElementById('calendar-grid');
  if (!grid) return;
  var existing = grid.querySelector('.calendar-now-line');
  if (existing) existing.remove();

  // Don't show now-line when viewing past days
  if (!isViewingToday()) return;

  var now = new Date();
  var minuteOfDay = now.getHours() * 60 + now.getMinutes();
  var calStart = CALENDAR_START_HOUR * 60;
  var calEnd = CALENDAR_END_HOUR * 60;
  if (minuteOfDay >= calStart && minuteOfDay < calEnd) {
    var top = ((minuteOfDay - calStart) / 60) * CALENDAR_HOUR_HEIGHT;
    var line = document.createElement('div');
    line.className = 'calendar-now-line';
    line.style.top = top + 'px';
    grid.appendChild(line);
  }

  // Update block past/active classes in real-time
  updateBlockTemporalClasses();
}

function updateBlockTemporalClasses() {
  focusState.blocks.forEach(function(block) {
    var el = document.querySelector('[data-block-id="' + block.id + '"]');
    if (!el) return;
    var wasPast = el.classList.contains('past');
    var wasActive = el.classList.contains('active');
    var nowPast = isBlockPast(block);
    var nowActive = isBlockActive(block);

    if (nowPast && !wasPast) {
      el.classList.remove('active');
      el.classList.add('past');
    } else if (nowActive && !wasActive) {
      el.classList.remove('past');
      el.classList.add('active');
    } else if (!nowPast && !nowActive) {
      el.classList.remove('past', 'active');
    }
  });
}

function scrollCalendarToTime() {
  var container = document.getElementById('calendar-container');
  if (!container) return;
  var now = new Date();
  var targetHour = Math.max(now.getHours() - 1, 0);
  container.scrollTop = Math.max(0, (targetHour - CALENDAR_START_HOUR) * CALENDAR_HOUR_HEIGHT);
}

// ---- Calendar Interactions ----

function onCalendarHourClick(event, hour) {
  if (!isViewingToday()) return;
  if (event.target.closest('.calendar-block')) return;
  var track = event.currentTarget;
  var rect = track.getBoundingClientRect();
  var yOffset = event.clientY - rect.top;
  var minuteInHour = Math.round((yOffset / CALENDAR_HOUR_HEIGHT) * 60 / 15) * 15;
  var startMin = hour * 60 + minuteInHour;
  var endMin = Math.min(startMin + 60, CALENDAR_END_HOUR * 60);
  if (endMin - startMin < 15) return;
  if (hasBlockOverlap(startMin, endMin, null)) return;

  var newBlock = {
    id: generateFocusUUID(), title: '',
    startHour: Math.floor(startMin / 60), startMinute: startMin % 60,
    endHour: Math.floor(endMin / 60), endMinute: endMin % 60,
    blockType: 'focusHours'
  };
  focusState.blocks.push(newBlock);
  markFocusDirty();
  renderCalendarBlocks();
  openBlockEditor(newBlock.id, event);
}

function hasBlockOverlap(startMin, endMin, excludeId) {
  return focusState.blocks.some(function(b) {
    if (b.id === excludeId) return false;
    var bStart = b.startHour * 60 + b.startMinute;
    var bEnd = b.endHour * 60 + b.endMinute;
    return startMin < bEnd && endMin > bStart;
  });
}

function addFocusBlock(blockType) {
  blockType = blockType || 'focusHours';
  var now = new Date();
  var currentMin = now.getHours() * 60 + now.getMinutes();
  var startMin = Math.ceil(currentMin / 15) * 15;
  var endMin = startMin + 60;

  // Find next available slot
  for (var attempt = 0; attempt < 48; attempt++) {
    if (!hasBlockOverlap(startMin, endMin, null)) break;
    startMin += 15;
    endMin = Math.min(startMin + 60, CALENDAR_END_HOUR * 60);
  }

  if (startMin >= CALENDAR_END_HOUR * 60 || endMin - startMin < 15) {
    showToast('No available time slots', 'error');
    return;
  }

  var defaultTitle = blockType === 'freeTime' ? 'Break' : '';
  var newBlock = {
    id: generateFocusUUID(),
    title: defaultTitle,
    description: '',
    startHour: Math.floor(startMin / 60), startMinute: startMin % 60,
    endHour: Math.floor(endMin / 60), endMinute: endMin % 60,
    blockType: blockType,
    isFree: blockType === 'freeTime'
  };
  focusState.blocks.push(newBlock);
  markFocusDirty();
  renderCalendarBlocks();
  if (blockType !== 'freeTime') openBlockEditor(newBlock.id, { clientY: 300, clientX: 500 });
}

// ---- Block Editor Popover ----

function openBlockEditor(blockId, event) {
  closeBlockEditor();
  var block = focusState.blocks.find(function(b) { return b.id === blockId; });
  if (!block) return;
  focusState.editingBlockId = blockId;

  var editorBlockType = block.blockType || (block.isFree ? 'freeTime' : 'focusHours');

  var editor = document.createElement('div');
  editor.className = 'block-editor';
  editor.id = 'block-editor';
  editor.innerHTML =
    '<div class="block-editor-row">' +
    '<label>Title</label>' +
    '<input class="block-editor-input" id="editor-title" value="' + escapeHtml(block.title) + '" placeholder="What are you working on?">' +
    '</div>' +
    '<div class="block-editor-row">' +
    '<label>Description <span style="color:rgba(255,255,255,0.25);font-weight:normal;">(helps AI understand your task)</span></label>' +
    '<textarea class="block-editor-input" id="editor-desc" rows="2" placeholder="e.g. Watching coding tutorials on React" style="resize:vertical;min-height:36px;">' + escapeHtml(block.description || '') + '</textarea>' +
    '</div>' +
    '<div class="block-editor-row">' +
    '<label>Time</label>' +
    '<div class="block-editor-time-row">' +
    '<input type="time" class="block-editor-input block-editor-time-input" id="editor-start" value="' + padFocusTime(block.startHour, block.startMinute) + '">' +
    '<span style="color:rgba(255,255,255,0.3);">to</span>' +
    '<input type="time" class="block-editor-input block-editor-time-input" id="editor-end" value="' + padFocusTime(block.endHour, block.endMinute) + '">' +
    '</div></div>' +
    '<div class="block-editor-row">' +
    '<label style="color:rgba(255,255,255,0.5);font-size:12px;margin-bottom:4px;">Block Type</label>' +
    '<div class="block-type-selector" id="editor-block-type">' +
    '<button class="block-type-btn' + (editorBlockType === 'deepWork' ? ' selected type-deep' : '') + '" data-type="deepWork" onclick="selectBlockType(this)">Deep Work</button>' +
    '<button class="block-type-btn' + (editorBlockType === 'focusHours' ? ' selected' : '') + '" data-type="focusHours" onclick="selectBlockType(this)">Focus Hours</button>' +
    '<button class="block-type-btn' + (editorBlockType === 'freeTime' ? ' selected type-free' : '') + '" data-type="freeTime" onclick="selectBlockType(this)">Free Time</button>' +
    '</div>' +
    '</div>' +
    '<div class="block-editor-actions">' +
    '<button class="btn-small" onclick="saveBlockEdit()">Done</button>' +
    '<button class="btn-small block-editor-delete" onclick="deleteFocusBlock(\'' + blockId + '\')">Delete</button>' +
    '</div>';

  document.body.appendChild(editor);

  // Disable inputs for past/active blocks
  var past = isBlockPast(block);
  var active = isBlockActive(block);
  if (past) {
    document.getElementById('editor-start').disabled = true;
    document.getElementById('editor-end').disabled = true;
    document.querySelectorAll('#editor-block-type .block-type-btn').forEach(function(b) { b.disabled = true; b.style.pointerEvents = 'none'; });
    var delBtn = editor.querySelector('.block-editor-delete');
    if (delBtn) delBtn.style.display = 'none';
  } else if (active) {
    document.getElementById('editor-start').disabled = true;
    document.querySelectorAll('#editor-block-type .block-type-btn').forEach(function(b) { b.disabled = true; b.style.pointerEvents = 'none'; });
    var delBtn = editor.querySelector('.block-editor-delete');
    if (delBtn) delBtn.style.display = 'none';
  }

  var calRect = document.getElementById('calendar-container').getBoundingClientRect();
  editor.style.top = Math.min(event.clientY || 300, window.innerHeight - 300) + 'px';
  editor.style.left = Math.min(calRect.right + 8, window.innerWidth - 300) + 'px';

  document.getElementById('editor-title').focus();
  setTimeout(function() {
    document.addEventListener('mousedown', closeBlockEditorOutside);
  }, 50);
}

function closeBlockEditorOutside(e) {
  var editor = document.getElementById('block-editor');
  if (editor && !editor.contains(e.target) && !e.target.closest('.calendar-block')) saveBlockEdit();
}

function closeBlockEditor() {
  var editor = document.getElementById('block-editor');
  if (editor) editor.remove();
  focusState.editingBlockId = null;
  document.removeEventListener('mousedown', closeBlockEditorOutside);
}

function saveBlockEdit() {
  var blockId = focusState.editingBlockId;
  if (!blockId) { closeBlockEditor(); return; }
  var block = focusState.blocks.find(function(b) { return b.id === blockId; });
  if (!block) { closeBlockEditor(); return; }

  var titleEl = document.getElementById('editor-title');
  var descEl = document.getElementById('editor-desc');
  var startEl = document.getElementById('editor-start');
  var endEl = document.getElementById('editor-end');

  if (titleEl) block.title = titleEl.value.trim() || 'Untitled';
  if (descEl) block.description = descEl.value.trim();

  // Parse proposed start/end times
  var newStartHour = block.startHour, newStartMinute = block.startMinute;
  var newEndHour = block.endHour, newEndMinute = block.endMinute;

  if (startEl && startEl.value && !startEl.disabled) {
    var sp = startEl.value.split(':');
    newStartHour = parseInt(sp[0]) || 0;
    newStartMinute = parseInt(sp[1]) || 0;
  }
  if (endEl && endEl.value && !endEl.disabled) {
    var ep = endEl.value.split(':');
    newEndHour = parseInt(ep[0]) || 0;
    newEndMinute = parseInt(ep[1]) || 0;
  }

  var newStartMin = newStartHour * 60 + newStartMinute;
  var newEndMin = newEndHour * 60 + newEndMinute;

  // Validate end > start
  if (newEndMin <= newStartMin) {
    showToast('End time must be after start time', 'error');
    return;
  }

  // Enforce 15-minute minimum duration
  if (newEndMin - newStartMin < 15) {
    showToast('Block must be at least 15 minutes', 'error');
    return;
  }

  // Check for overlap with other blocks
  var timeChanged = newStartHour !== block.startHour || newStartMinute !== block.startMinute ||
                    newEndHour !== block.endHour || newEndMinute !== block.endMinute;
  if (timeChanged && hasBlockOverlap(newStartMin, newEndMin, blockId)) {
    showToast('Overlaps with another block', 'error');
    return;
  }

  // Apply time changes
  if (timeChanged) {
    block.startHour = newStartHour;
    block.startMinute = newStartMinute;
    block.endHour = newEndHour;
    block.endMinute = newEndMinute;
  }

  // Read block type from segmented control
  var selectedBtn = document.querySelector('#editor-block-type .block-type-btn.selected');
  if (selectedBtn && !selectedBtn.disabled) {
    block.blockType = selectedBtn.dataset.type;
    block.isFree = block.blockType === 'freeTime';
  }

  closeBlockEditor();
  markFocusDirty();
  renderCalendarBlocks();
}

function selectBlockType(btn) {
  var container = btn.closest('.block-type-selector');
  container.querySelectorAll('.block-type-btn').forEach(function(b) {
    b.classList.remove('selected', 'type-free', 'type-deep');
  });
  btn.classList.add('selected');
  if (btn.dataset.type === 'freeTime') btn.classList.add('type-free');
  if (btn.dataset.type === 'deepWork') btn.classList.add('type-deep');
}

function deleteFocusBlock(blockId) {
  var block = focusState.blocks.find(function(b) { return b.id === blockId; });
  if (block && (isBlockPast(block) || isBlockActive(block))) return;
  focusState.blocks = focusState.blocks.filter(function(b) { return b.id !== blockId; });
  closeBlockEditor();
  markFocusDirty();
  renderCalendarBlocks();
}

// ---- Calendar Zoom ----

function initCalendarZoom() {
  var slider = document.getElementById('calendar-zoom-slider');
  if (!slider) return;
  slider.addEventListener('input', function() {
    calendarZoomLevel = parseInt(this.value);
    applyCalendarZoom();
  });
  slider.addEventListener('change', function() {
    sendMessage({ type: 'SET_CALENDAR_ZOOM', zoom: calendarZoomLevel });
  });

  // Pinch-to-zoom on trackpad (WKWebView translates pinch to ctrl+wheel)
  var container = document.getElementById('calendar-container');
  container.addEventListener('wheel', function(e) {
    if (!e.ctrlKey) return;
    e.preventDefault();
    calendarZoomLevel = Math.max(42, Math.min(140, calendarZoomLevel + (e.deltaY < 0 ? 4 : -4)));
    var s = document.getElementById('calendar-zoom-slider');
    if (s) s.value = calendarZoomLevel;
    applyCalendarZoom();
    clearTimeout(container._zoomPersistTimer);
    container._zoomPersistTimer = setTimeout(function() {
      sendMessage({ type: 'SET_CALENDAR_ZOOM', zoom: calendarZoomLevel });
    }, 500);
  }, { passive: false });
}

function applyCalendarZoom() {
  CALENDAR_HOUR_HEIGHT = calendarZoomLevel;
  var grid = document.getElementById('calendar-grid');
  if (!grid) return;
  var gridHeight = (CALENDAR_END_HOUR - CALENDAR_START_HOUR) * CALENDAR_HOUR_HEIGHT;
  grid.style.height = gridHeight + 'px';
  // Reposition hour rows
  grid.querySelectorAll('.calendar-hour-row').forEach(function(row) {
    var hour = parseInt(row.querySelector('.calendar-hour-track').dataset.hour);
    row.style.top = ((hour - CALENDAR_START_HOUR) * CALENDAR_HOUR_HEIGHT) + 'px';
    row.style.height = CALENDAR_HOUR_HEIGHT + 'px';
  });
  renderCalendarBlocks();
  renderNowLine();
}

// ---- Date Navigation ----

function navigateScheduleDate(offset) {
  var today = getTodayString();
  var current = calendarViewDate || today;
  var parts = current.split('-');
  var d = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  d.setDate(d.getDate() + offset);
  var newDate = formatDateISO(d);

  // Can't go past today
  if (newDate > today) return;

  if (newDate === today) {
    calendarViewDate = null;
    loadFocusState(); // Reload today's live state
  } else {
    calendarViewDate = newDate;
    sendMessage({ type: 'GET_SCHEDULE_FOR_DATE', date: newDate });
  }
  updateDateNavUI();
}

window._scheduleForDateResult = function(data) {
  focusState.blocks = data.blocks || [];
  renderCalendar();
  // Mark all blocks as past when viewing history
  if (calendarViewDate) {
    document.querySelectorAll('.calendar-block').forEach(function(el) {
      el.classList.add('past');
    });
  }
  updateDateNavUI();
};

function updateDateNavUI() {
  var label = document.getElementById('calendar-date-label');
  var nextBtn = document.getElementById('calendar-nav-next');
  var addBtns = document.getElementById('calendar-add-buttons');
  var saveBtn = document.getElementById('focus-save-schedule-btn');
  var isToday = !calendarViewDate;

  if (label) label.textContent = isToday ? 'Today' : formatDateLabel(calendarViewDate);
  if (nextBtn) nextBtn.style.visibility = isToday ? 'hidden' : 'visible';
  if (addBtns) addBtns.style.display = isToday ? '' : 'none';
  if (saveBtn && !isToday) saveBtn.style.display = 'none';
}

function formatDateLabel(dateStr) {
  var today = getTodayString();
  var parts = today.split('-');
  var todayDate = new Date(parseInt(parts[0]), parseInt(parts[1]) - 1, parseInt(parts[2]));
  var yesterday = new Date(todayDate);
  yesterday.setDate(yesterday.getDate() - 1);
  if (dateStr === formatDateISO(yesterday)) return 'Yesterday';
  var dp = dateStr.split('-');
  var d = new Date(parseInt(dp[0]), parseInt(dp[1]) - 1, parseInt(dp[2]));
  var days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
  var months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
  return days[d.getDay()] + ', ' + months[d.getMonth()] + ' ' + d.getDate();
}

function getTodayString() {
  return formatDateISO(new Date());
}

function formatDateISO(d) {
  var y = d.getFullYear();
  var m = String(d.getMonth() + 1).padStart(2, '0');
  var day = String(d.getDate()).padStart(2, '0');
  return y + '-' + m + '-' + day;
}

function isViewingToday() {
  return !calendarViewDate;
}

// ---- Empty State ----

function renderEmptyState() {
  var grid = document.getElementById('calendar-grid');
  if (!grid) return;
  var existing = grid.querySelector('.calendar-empty-state');
  if (existing) existing.remove();

  if (focusState.blocks.length > 0) return;

  var empty = document.createElement('div');
  empty.className = 'calendar-empty-state';
  if (isViewingToday()) {
    empty.innerHTML = '<div class="calendar-empty-text">No blocks scheduled</div>' +
      '<button class="calendar-empty-btn" onclick="onPlanYourDay()">Plan Your Day</button>';
  } else {
    empty.innerHTML = '<div class="calendar-empty-text">No schedule for this day</div>';
  }
  grid.appendChild(empty);
}

function onPlanYourDay() {
  scrollCalendarToTime();
  addFocusBlock('focusHours');
}

// ---- Block Resize ----

function startBlockResize(blockId, edge, event) {
  event.preventDefault();
  var block = focusState.blocks.find(function(b) { return b.id === blockId; });
  if (!block) return;
  if (isBlockPast(block)) return;
  if (isBlockActive(block) && edge === 'top') return;

  var container = document.getElementById('calendar-container');
  calendarDragState = { blockId: blockId, edge: edge, containerScrollTop: container.scrollTop };

  document.addEventListener('mousemove', onBlockResizeMove);
  document.addEventListener('mouseup', onBlockResizeEnd);
}

function onBlockResizeMove(event) {
  if (!calendarDragState) return;
  var block = focusState.blocks.find(function(b) { return b.id === calendarDragState.blockId; });
  if (!block) return;

  var container = document.getElementById('calendar-container');
  var grid = document.getElementById('calendar-grid');
  var gridRect = grid.getBoundingClientRect();
  var y = event.clientY - gridRect.top + container.scrollTop;

  var minutes = CALENDAR_START_HOUR * 60 + (y / CALENDAR_HOUR_HEIGHT) * 60;
  minutes = Math.round(minutes / 15) * 15;
  minutes = Math.max(CALENDAR_START_HOUR * 60, Math.min(CALENDAR_END_HOUR * 60, minutes));

  if (calendarDragState.edge === 'top') {
    var endMin = block.endHour * 60 + block.endMinute;
    if (minutes < endMin - 15 && !hasBlockOverlap(minutes, endMin, block.id)) {
      block.startHour = Math.floor(minutes / 60);
      block.startMinute = minutes % 60;
    }
  } else {
    var startMin = block.startHour * 60 + block.startMinute;
    if (minutes > startMin + 15 && !hasBlockOverlap(startMin, minutes, block.id)) {
      block.endHour = Math.floor(minutes / 60);
      block.endMinute = minutes % 60;
    }
  }
  renderCalendarBlocks();
}

function onBlockResizeEnd() {
  calendarDragState = null;
  markFocusDirty();
  document.removeEventListener('mousemove', onBlockResizeMove);
  document.removeEventListener('mouseup', onBlockResizeEnd);
}

// ---- Block Drag (move) ----

var blockDragState = null; // { blockId, offsetMin, durationMin, didMove }

function startBlockDrag(blockId, event) {
  event.preventDefault();
  var block = focusState.blocks.find(function(b) { return b.id === blockId; });
  if (!block) return;
  if (isBlockPast(block) || isBlockActive(block)) return;

  var container = document.getElementById('calendar-container');
  var grid = document.getElementById('calendar-grid');
  var gridRect = grid.getBoundingClientRect();
  var y = event.clientY - gridRect.top + container.scrollTop;
  var mouseMin = CALENDAR_START_HOUR * 60 + (y / CALENDAR_HOUR_HEIGHT) * 60;
  var blockStartMin = block.startHour * 60 + block.startMinute;
  var blockEndMin = block.endHour * 60 + block.endMinute;

  blockDragState = {
    blockId: blockId,
    offsetMin: mouseMin - blockStartMin,
    durationMin: blockEndMin - blockStartMin,
    didMove: false
  };

  var el = document.querySelector('[data-block-id="' + blockId + '"]');
  if (el) el.classList.add('dragging');

  document.addEventListener('mousemove', onBlockDragMove);
  document.addEventListener('mouseup', onBlockDragEnd);
}

function onBlockDragMove(event) {
  if (!blockDragState) return;
  var block = focusState.blocks.find(function(b) { return b.id === blockDragState.blockId; });
  if (!block) return;

  var container = document.getElementById('calendar-container');
  var grid = document.getElementById('calendar-grid');
  var gridRect = grid.getBoundingClientRect();
  var y = event.clientY - gridRect.top + container.scrollTop;
  var mouseMin = CALENDAR_START_HOUR * 60 + (y / CALENDAR_HOUR_HEIGHT) * 60;

  var newStartMin = mouseMin - blockDragState.offsetMin;
  newStartMin = Math.round(newStartMin / 15) * 15;
  var newEndMin = newStartMin + blockDragState.durationMin;

  // Clamp to calendar bounds
  if (newStartMin < CALENDAR_START_HOUR * 60) {
    newStartMin = CALENDAR_START_HOUR * 60;
    newEndMin = newStartMin + blockDragState.durationMin;
  }
  if (newEndMin > CALENDAR_END_HOUR * 60) {
    newEndMin = CALENDAR_END_HOUR * 60;
    newStartMin = newEndMin - blockDragState.durationMin;
  }

  // Check overlap
  if (hasBlockOverlap(newStartMin, newEndMin, block.id)) return;

  block.startHour = Math.floor(newStartMin / 60);
  block.startMinute = newStartMin % 60;
  block.endHour = Math.floor(newEndMin / 60);
  block.endMinute = newEndMin % 60;
  blockDragState.didMove = true;

  renderCalendarBlocks();
  // Re-add dragging class after re-render
  var el = document.querySelector('[data-block-id="' + block.id + '"]');
  if (el) el.classList.add('dragging');
}

function onBlockDragEnd() {
  if (blockDragState && blockDragState.didMove) {
    markFocusDirty();
  }
  blockDragState = null;
  document.querySelectorAll('.calendar-block.dragging').forEach(function(el) { el.classList.remove('dragging'); });
  document.removeEventListener('mousemove', onBlockDragMove);
  document.removeEventListener('mouseup', onBlockDragEnd);
}

// ---- Save Schedule ----

function saveAndStartDay() {
  var btn = document.getElementById('focus-save-schedule-btn');
  if (btn) { btn.textContent = 'Saving...'; btn.disabled = true; }

  // Collect latest goals from inputs
  focusState.goals = [
    (document.getElementById('focus-goal-1').value || '').trim(),
    (document.getElementById('focus-goal-2').value || '').trim(),
    (document.getElementById('focus-goal-3').value || '').trim()
  ];

  focusState.blocks.sort(function(a, b) {
    return (a.startHour * 60 + a.startMinute) - (b.startHour * 60 + b.startMinute);
  });

  sendMessage({
    type: 'SET_SCHEDULE',
    blocks: focusState.blocks,
    goals: focusState.goals.filter(function(g) { return g; }),
    dailyPlan: focusState.dailyPlan
  });
}

// ---- Focus Score ----

function loadFocusScore() {
  sendMessage({ type: 'GET_FOCUS_SCORE' });
}

window._focusScoreResult = function(data) {
  var el;
  el = document.getElementById('score-focused-time');
  if (el) el.textContent = formatFocusDuration(data.focusedMinutes || 0);
  el = document.getElementById('score-offtask-time');
  if (el) el.textContent = formatFocusDuration(data.offTaskMinutes || 0);
  el = document.getElementById('score-break-time');
  if (el) el.textContent = formatFocusDuration(data.breakMinutes || 0);

  var breakdown = document.getElementById('score-block-breakdown');
  if (breakdown) {
    var bhtml = '';
    (data.blocks || []).forEach(function(b) {
      var s = b.score || 0;
      var color = s >= 80 ? '#34d399' : s >= 50 ? '#f59e0b' : '#ef4444';
      bhtml += '<div class="setting-row">' +
        '<div style="flex:1;">' +
        '<div class="setting-label">' + (b.blockType === 'freeTime' ? '\u2600 ' : b.blockType === 'deepWork' ? '\uD83D\uDD12 ' : '') + escapeHtml(b.title) + '</div>' +
        '<div class="setting-desc">' + formatFocusTime(b.startHour, b.startMinute) + ' \u2013 ' + formatFocusTime(b.endHour, b.endMinute) +
        (b.blockType === 'freeTime' ? ' (free)' : b.blockType === 'deepWork' ? ' (deep work)' : '') + '</div>' +
        '</div>' +
        (b.blockType === 'freeTime' ? '' : '<div style="width:80px;display:flex;align-items:center;gap:8px;">' +
        '<div style="flex:1;height:4px;background:rgba(255,255,255,0.1);border-radius:2px;overflow:hidden;">' +
        '<div style="height:100%;width:' + s + '%;background:' + color + ';border-radius:2px;"></div></div>' +
        '<span style="font-size:12px;color:rgba(255,255,255,0.5);">' + s + '%</span></div>') +
        '</div>';
    });
    breakdown.innerHTML = bhtml || '<div class="setting-row"><div class="setting-desc">No blocks completed yet</div></div>';
  }
};

// ---- Earned Browse ----

function updateEarnedBrowseBar(earned, used, available, effectiveTime) {
  var availPct = earned > 0 ? Math.min(100, (available / earned) * 100) : 0;
  var usedPct = earned > 0 ? Math.min(100, (used / earned) * 100) : 0;

  var barAvail = document.getElementById('eb4-bar-avail');
  if (barAvail) barAvail.style.width = (earned > 0 ? availPct : 0) + '%';
  var barUsed = document.getElementById('eb4-bar-used');
  if (barUsed) barUsed.style.width = (earned > 0 ? usedPct : 0) + '%';
  var availLabel = document.getElementById('eb4-avail-label');
  if (availLabel) availLabel.textContent = Math.round(effectiveTime) + ' min available';
  var usedLabel = document.getElementById('eb4-used-label');
  if (usedLabel) usedLabel.textContent = Math.round(used) + ' min used';
}

function loadEarnedStatus() {
  sendMessage({ type: 'GET_EARNED_STATUS' });
}

window._earnedStatusResult = function(data) {
  var widget = document.getElementById('earned-browse-widget');
  if (!widget) return;

  var earned = data.earnedMinutes || 0;
  var used = data.usedMinutes || 0;
  var available = Math.max(0, data.availableMinutes || 0);
  var effectiveTime = data.effectiveBrowseTime != null ? Math.max(0, data.effectiveBrowseTime) : available;

  updateEarnedBrowseBar(earned, used, available, effectiveTime);

  // Cost multiplier indicator
  var costEl = document.getElementById('earned-cost-indicator');
  if (costEl) {
    if (data.isWorkBlock && data.costMultiplier > 1) {
      costEl.textContent = data.costMultiplier + 'x cost active';
      costEl.style.color = '#f59e0b';
    } else {
      costEl.textContent = '';
    }
  }

  // Deep work indicator
  var deepEl = document.getElementById('earned-deep-work');
  if (deepEl) deepEl.style.display = data.isDeepWork ? '' : 'none';

  // Visit count
  var visitsEl = document.getElementById('earned-visits');
  if (visitsEl) {
    visitsEl.textContent = data.visitCount > 0
      ? data.visitCount + ' visit' + (data.visitCount > 1 ? 's' : '') + ' this block'
      : '';
  }

  // Store block focus data for calendar ring rendering
  if (data.blockFocusStats) {
    data.blockFocusStats.forEach(function(b) {
      blockFocusData[b.blockId] = b;
    });
    updateBlockRings();
  }

  // Extra time link: always show inline, disable when no partner
  var extraSection = document.getElementById('earned-extra-time-section');
  if (extraSection) {
    extraSection.style.display = '';
    var extraBtn = document.getElementById('earned-extra-time-btn');
    extraSection.dataset.hasPartner = data.hasPartner ? '1' : '0';
    extraSection.dataset.partnerName = data.partnerName || 'your partner';
    if (extraBtn) {
      extraBtn.textContent = 'Request Extra Time';
      if (data.hasPartner) {
        extraBtn.disabled = false;
        extraBtn.style.opacity = '';
        extraBtn.style.cursor = '';
      } else {
        extraBtn.disabled = false;
        extraBtn.style.opacity = '0.5';
        extraBtn.style.cursor = 'pointer';
      }
    }
  }
};

// ---- Extra Time Request Flow ----

var extraTimeState = { step: null, selectedMinutes: null, requestId: null, partnerName: '' };

function updateExtraTimeRemaining(verifiedToday, remainingToday) {
  var el = document.getElementById('extra-time-remaining');
  if (!el) return;
  if (remainingToday <= 0) {
    el.textContent = 'Maximum 2 completed requests per day (limit reached)';
    el.style.color = 'rgba(239, 68, 68, 0.7)';
  } else {
    el.textContent = remainingToday + ' of 2 extra time requests remaining today';
    el.style.color = 'rgba(255, 255, 255, 0.35)';
  }
}

function initExtraTimeFlow() {
  var btn = document.getElementById('earned-extra-time-btn');
  if (!btn) return;

  btn.addEventListener('click', function() {
    var section = document.getElementById('earned-extra-time-section');
    var hasPartner = section && section.dataset.hasPartner === '1';
    if (!hasPartner) {
      // Briefly show message, then revert
      var origText = btn.textContent;
      btn.textContent = 'Only available with an accountability partner';
      btn.style.opacity = '1';
      btn.style.color = 'rgba(255, 140, 140, 0.8)';
      setTimeout(function() {
        btn.textContent = origText;
        btn.style.opacity = '0.5';
        btn.style.color = '';
      }, 3000);
      return;
    }
    if (btn.disabled) return;
    extraTimeState.partnerName = (section && section.dataset.partnerName) || 'your partner';
    showExtraTimeStep('amount');
  });

  // Amount pills â†’ enable Send Request
  document.querySelectorAll('.extra-time-pill').forEach(function(pill) {
    pill.addEventListener('click', function() {
      document.querySelectorAll('.extra-time-pill').forEach(function(p) { p.classList.remove('selected'); });
      pill.classList.add('selected');
      extraTimeState.selectedMinutes = parseInt(pill.dataset.minutes, 10);
      var sendBtn = document.getElementById('extra-time-send');
      if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'Send Request'; }
      var err = document.getElementById('extra-time-send-error');
      if (err) { err.style.display = 'none'; }
    });
  });

  // Send request (directly from amount step)
  var sendBtn = document.getElementById('extra-time-send');
  if (sendBtn) sendBtn.addEventListener('click', function() {
    if (!extraTimeState.selectedMinutes) return;
    sendBtn.disabled = true;
    sendBtn.textContent = 'Sending...';
    sendMessage({ type: 'REQUEST_EXTRA_TIME', minutes: extraTimeState.selectedMinutes });
  });

  // Code cell input handling
  var cells = document.querySelectorAll('.extra-time-code-cell');
  var verifyBtn = document.getElementById('extra-time-verify');
  cells.forEach(function(cell, idx) {
    cell.addEventListener('input', function(e) {
      var val = e.target.value.replace(/[^0-9]/g, '');
      e.target.value = val.slice(0, 1);
      if (val && idx < cells.length - 1) cells[idx + 1].focus();
      checkCodeComplete();
    });
    cell.addEventListener('keydown', function(e) {
      if (e.key === 'Backspace' && !e.target.value && idx > 0) cells[idx - 1].focus();
    });
    cell.addEventListener('paste', function(e) {
      e.preventDefault();
      var pasted = (e.clipboardData.getData('text') || '').replace(/[^0-9]/g, '').slice(0, 6);
      for (var i = 0; i < pasted.length && i + idx < cells.length; i++) cells[i + idx].value = pasted[i];
      cells[Math.min(idx + pasted.length, cells.length - 1)].focus();
      checkCodeComplete();
    });
  });

  function checkCodeComplete() {
    var code = getCodeValue();
    if (verifyBtn) verifyBtn.disabled = code.length !== 6;
  }

  function getCodeValue() {
    var code = '';
    cells.forEach(function(c) { code += c.value; });
    return code;
  }

  // Verify
  if (verifyBtn) verifyBtn.addEventListener('click', function() {
    var code = getCodeValue();
    if (code.length !== 6) return;
    verifyBtn.disabled = true;
    verifyBtn.textContent = 'Verifying...';
    sendMessage({ type: 'VERIFY_EXTRA_TIME_CODE', code: code, requestId: extraTimeState.requestId });
  });

  // Cancel buttons
  document.querySelectorAll('.extra-time-cancel-btn').forEach(function(btn) {
    btn.addEventListener('click', function() { resetExtraTimeFlow(); });
  });
}

function showExtraTimeStep(step) {
  extraTimeState.step = step;
  var flow = document.getElementById('earned-extra-time-flow');
  var section = document.getElementById('earned-extra-time-section');
  if (flow) flow.style.display = '';
  if (section) section.style.display = 'none';

  ['amount', 'code', 'success'].forEach(function(s) {
    var el = document.getElementById('extra-time-step-' + s);
    if (el) el.style.display = s === step ? '' : 'none';
  });

  if (step === 'amount') {
    extraTimeState.selectedMinutes = null;
    document.querySelectorAll('.extra-time-pill').forEach(function(p) { p.classList.remove('selected'); });
    var sendBtn = document.getElementById('extra-time-send');
    if (sendBtn) { sendBtn.disabled = true; sendBtn.textContent = 'Send Request'; }
    var err = document.getElementById('extra-time-send-error');
    if (err) { err.style.display = 'none'; }
  }
  if (step === 'code') {
    var cells = document.querySelectorAll('.extra-time-code-cell');
    cells.forEach(function(c) { c.value = ''; });
    var verifyBtn = document.getElementById('extra-time-verify');
    if (verifyBtn) { verifyBtn.disabled = true; verifyBtn.textContent = 'Verify'; }
    var err = document.getElementById('extra-time-code-error');
    if (err) { err.style.display = 'none'; err.textContent = ''; }
    if (cells[0]) setTimeout(function() { cells[0].focus(); }, 50);
    var codeMsg = document.getElementById('extra-time-code-msg');
    if (codeMsg) codeMsg.textContent = 'Ask ' + extraTimeState.partnerName + ' for the 6-digit code we just emailed them.';
  }
}

function resetExtraTimeFlow() {
  extraTimeState.step = null;
  extraTimeState.selectedMinutes = null;
  extraTimeState.requestId = null;
  var flow = document.getElementById('earned-extra-time-flow');
  var section = document.getElementById('earned-extra-time-section');
  if (flow) flow.style.display = 'none';
  if (section) section.style.display = '';
  var btn = document.getElementById('earned-extra-time-btn');
  if (btn) {
    btn.textContent = 'Request Extra Time';
    btn.disabled = false;
    btn.style.opacity = (section && section.dataset.hasPartner === '1') ? '' : '0.5';
  }
}

// Callbacks from Swift
window._extraTimeRequestResult = function(data) {
  var sendBtn = document.getElementById('extra-time-send');
  // Update remaining count if provided
  if (data.remainingToday != null) {
    updateExtraTimeRemaining(data.verifiedToday || 0, data.remainingToday);
  }
  if (data.success) {
    extraTimeState.requestId = data.requestId;
    extraTimeState.partnerName = data.partnerName || extraTimeState.partnerName;
    showExtraTimeStep('code');
  } else {
    if (sendBtn) { sendBtn.disabled = false; sendBtn.textContent = 'Send Request'; }
    var err = document.getElementById('extra-time-send-error');
    if (err) { err.textContent = data.message || 'Could not send request.'; err.style.display = ''; }
  }
};

window._extraTimeVerifyResult = function(data) {
  // Update remaining count if provided
  if (data.remainingToday != null) {
    updateExtraTimeRemaining(data.verifiedToday || 0, data.remainingToday);
  }
  if (data.success) {
    var msg = document.getElementById('extra-time-success-msg');
    if (msg) msg.textContent = (data.addedMinutes || extraTimeState.selectedMinutes) + ' Minutes Added!';
    showExtraTimeStep('success');
    setTimeout(function() {
      resetExtraTimeFlow();
      loadEarnedStatus();
    }, 2000);
  } else {
    var verifyBtn = document.getElementById('extra-time-verify');
    if (verifyBtn) { verifyBtn.disabled = true; verifyBtn.textContent = 'Verify'; }
    var cells = document.querySelectorAll('.extra-time-code-cell');
    cells.forEach(function(c) { c.value = ''; });
    if (cells[0]) cells[0].focus();
    var err = document.getElementById('extra-time-code-error');
    if (err) { err.textContent = data.message || 'Invalid code. Please try again.'; err.style.display = ''; }
  }
};

// ---- Relevance Log ----

var relevanceLogTimer = null;

window._relevanceLogResult = function(entries) {
  var container = document.getElementById('relevance-log');
  if (!container) return;
  if (!entries || !entries.length) {
    container.innerHTML = '<div class="setting-row"><div class="setting-desc">No assessments yet</div></div>';
    return;
  }
  var html = '';
  entries.slice().reverse().forEach(function(e) {
    var time = new Date(e.timestamp);
    var timeStr = time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0') + ':' + String(time.getSeconds()).padStart(2, '0');
    var dotClass = e.relevant ? 'relevant' : 'irrelevant';
    var actionHtml = '';
    if (e.action === 'nudge') actionHtml = '<div class="relevance-action nudged">nudged</div>';
    else if (e.action === 'blocked') actionHtml = '<div class="relevance-action blocked">blocked</div>';
    else if (e.action === 'grayscale_on') actionHtml = '<div class="relevance-action blocked">grayscale on</div>';
    else if (e.action === 'grayscale_off') actionHtml = '<div class="relevance-action">grayscale off</div>';
    html += '<div class="relevance-entry">' +
      '<div class="relevance-dot ' + dotClass + '"></div>' +
      '<div class="relevance-time">' + timeStr + '</div>' +
      '<div style="flex:1;">' +
      '<div class="relevance-title">' + escapeHtml(e.title) + '</div>' +
      '<div class="relevance-reason">' + escapeHtml(e.reason) + '</div>' +
      actionHtml +
      '</div></div>';
  });
  container.innerHTML = html;
};

var _lastRelevanceEntries = null;
var _origRelevanceLogResult = window._relevanceLogResult;
window._relevanceLogResult = function(entries) {
  _lastRelevanceEntries = entries;
  _origRelevanceLogResult(entries);
};

function copyAssessments() {
  var entries = _lastRelevanceEntries;
  if (!entries || !entries.length) return;
  var lines = entries.slice().reverse().map(function(e) {
    var time = new Date(e.timestamp);
    var timeStr = time.getHours() + ':' + String(time.getMinutes()).padStart(2, '0') + ':' + String(time.getSeconds()).padStart(2, '0');
    var dot = e.relevant ? 'RELEVANT' : 'IRRELEVANT';
    var action = e.action === 'blocked' ? ' [BLOCKED]' : (e.action === 'nudge' ? ' [NUDGED]' : (e.action === 'grayscale_on' ? ' [GRAYSCALE ON]' : (e.action === 'grayscale_off' ? ' [GRAYSCALE OFF]' : '')));
    return timeStr + '  ' + dot + '  ' + e.title + action + (e.reason ? '\n    ' + e.reason : '');
  });
  var text = lines.join('\n');
  navigator.clipboard.writeText(text).then(function() {
    var btn = document.getElementById('copyAssessmentsBtn');
    btn.textContent = 'Copied!';
    setTimeout(function() { btn.textContent = 'Copy'; }, 1500);
  });
}

// ---- Focus Helpers ----

function formatHourLabel(h) {
  if (h === 0) return '12 AM';
  if (h === 12) return '12 PM';
  return (h > 12 ? h - 12 : h) + (h < 12 ? ' AM' : ' PM');
}

function formatFocusTime(h, m) {
  var period = h >= 12 ? 'PM' : 'AM';
  var dh = h > 12 ? h - 12 : (h === 0 ? 12 : h);
  return dh + ':' + String(m).padStart(2, '0') + ' ' + period;
}

function padFocusTime(h, m) {
  return String(h).padStart(2, '0') + ':' + String(m).padStart(2, '0');
}

function formatFocusDuration(minutes) {
  if (minutes < 60) return minutes + 'm';
  return Math.floor(minutes / 60) + 'h ' + (minutes % 60) + 'm';
}

// ===== Init =====
sendMessage({ type: 'GET_SETTINGS' });
sendMessage({ type: 'GET_PARTNER_STATUS' });
refresh();
loadFocusState();
sendMessage({ type: 'GET_RELEVANCE_LOG' });
relevanceLogTimer = setInterval(function() {
  sendMessage({ type: 'GET_RELEVANCE_LOG' });
}, 5000);
setInterval(refresh, 5000);
</script>

<!-- Lock Confirmation Modal -->
<div id="lock-confirm-modal" class="lock-confirm-overlay" style="display:none">
  <div class="lock-confirm-box">
    <div class="lock-confirm-icon">ðŸ”’</div>
    <h3 id="lock-confirm-title">Enable setting?</h3>
    <p id="lock-confirm-desc">Description of the setting.</p>
    <p class="lock-confirm-warning" id="lock-confirm-warning">This setting will stay enabled until your profile is unlocked.</p>
    <div class="lock-confirm-actions">
      <button class="lock-confirm-cancel" onclick="closeLockConfirm(false)">Cancel</button>
      <button class="lock-confirm-enable" onclick="closeLockConfirm(true)" id="lock-confirm-btn">Confirm</button>
    </div>
  </div>
</div>

</body>
</html>
