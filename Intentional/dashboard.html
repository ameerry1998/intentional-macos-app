<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intentional ‚Äî Dashboard</title>
<style>
*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, sans-serif;
  background: #0a0a0a;
  color: #ffffff;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  user-select: none;
  -webkit-user-select: none;
  display: flex;
}

/* ===== Sidebar ===== */
.sidebar {
  width: 220px;
  min-height: 100vh;
  background: rgba(255, 255, 255, 0.02);
  border-right: 1px solid rgba(255, 255, 255, 0.08);
  padding: 20px 0;
  flex-shrink: 0;
}

.sidebar-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 20px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  margin-bottom: 12px;
}

.logo-ring {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(139, 92, 246, 0.2) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.sidebar-title {
  font-size: 16px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.sidebar-divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.06);
  margin: 8px 20px;
}

.sidebar-label {
  padding: 8px 20px 4px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.25);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.5);
  cursor: pointer;
  transition: all 0.15s ease;
  border-left: 3px solid transparent;
}

.sidebar-item:hover {
  color: rgba(255, 255, 255, 0.8);
  background: rgba(255, 255, 255, 0.03);
}

.sidebar-item.active {
  color: #ffffff;
  background: rgba(99, 102, 241, 0.1);
  border-left-color: #6366f1;
}

.sidebar-item-icon {
  font-size: 16px;
  width: 20px;
  text-align: center;
}

/* ===== Main Content ===== */
.main {
  flex: 1;
  overflow-y: auto;
  max-height: 100vh;
}

/* ===== Header ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 20px 32px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #34d399;
}

.status-text {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.5);
}

/* ===== Pages ===== */
.page {
  display: none;
  max-width: 720px;
  margin: 0 auto;
  padding: 32px;
}

.page.active {
  display: block;
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.4);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
}

/* ===== Usage Cards ===== */
.usage-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  margin-bottom: 32px;
}

.usage-card {
  padding: 24px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  transition: all 0.3s ease;
}

.usage-card:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.12);
}

.usage-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.usage-card-icon { font-size: 20px; }
.usage-card-platform { font-size: 15px; font-weight: 600; }

.usage-card-time {
  display: flex;
  align-items: baseline;
  gap: 6px;
  margin-bottom: 12px;
}

.usage-minutes {
  font-size: 40px;
  font-weight: 700;
  line-height: 1;
}

.usage-minutes.youtube { color: #ef4444; }
.usage-minutes.instagram { color: #e879f9; }
.usage-minutes.facebook { color: #60a5fa; }

.usage-unit {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.4);
}

.usage-budget {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
}

.usage-bar {
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  margin-top: 12px;
  overflow: hidden;
}

.usage-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s ease;
}

.usage-bar-fill.youtube { background: #ef4444; }
.usage-bar-fill.instagram { background: #e879f9; }
.usage-bar-fill.facebook { background: #60a5fa; }

/* ===== Settings Card ===== */
.settings-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 20px;
}

.settings-card-title {
  padding: 16px 20px 8px;
  font-size: 13px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.4);
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.setting-row {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  gap: 14px;
}

.setting-row + .setting-row {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.setting-label {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
}

.setting-desc {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.35);
  margin-top: 2px;
}

.setting-value {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.5);
  min-width: 50px;
  text-align: right;
}

/* Toggle Switch */
.toggle {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-track {
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

.toggle-track::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: #ffffff;
  border-radius: 50%;
  transition: transform 0.2s;
}

.toggle input:checked + .toggle-track {
  background: #6366f1;
}

.toggle input:checked + .toggle-track::after {
  transform: translateX(20px);
}

/* Range Slider */
.setting-range {
  -webkit-appearance: none;
  appearance: none;
  width: 120px;
  height: 4px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 2px;
  outline: none;
}

.setting-range::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  background: #6366f1;
  border-radius: 50%;
  cursor: pointer;
}

/* Select Dropdown */
.setting-select {
  padding: 6px 12px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 13px;
  outline: none;
  cursor: pointer;
}

.setting-select option {
  background: #1a1a2e;
  color: #ffffff;
}

/* Number Input */
.setting-number {
  width: 70px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 14px;
  text-align: center;
  outline: none;
}

.setting-number:focus {
  border-color: #6366f1;
}

/* ===== Browser Status ===== */
.browser-section { margin-bottom: 32px; }

.browser-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  overflow: hidden;
}

.browser-row {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  gap: 14px;
}

.browser-row + .browser-row {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.browser-icon { font-size: 20px; width: 28px; height: 28px; text-align: center; flex-shrink: 0; border-radius: 6px; overflow: hidden; }
.browser-icon img { width: 100%; height: 100%; object-fit: contain; }
.browser-name { width: 110px; flex-shrink: 0; font-size: 14px; font-weight: 500; }

.browser-status {
  font-size: 12px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.browser-status.connected { color: #34d399; }
.browser-status.disconnected { color: rgba(255, 255, 255, 0.3); }

.browser-status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.browser-status-dot.connected { background: #34d399; }
.browser-status-dot.disconnected { background: rgba(255, 255, 255, 0.2); }

.browser-row.browser-connected {
  background: rgba(52, 211, 153, 0.06);
}

.browser-ext-url {
  flex: 1;
  font-size: 11px;
  color: rgba(255, 255, 255, 0.35);
  font-family: "SF Mono", Menlo, monospace;
  padding: 3px 8px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.browser-ext-url:hover {
  color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.1);
}

.browser-ext-url.copied {
  color: #34d399;
}

.browser-install-btn {
  padding: 5px 14px;
  font-size: 12px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  background: #6366f1;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  font-family: inherit;
}

.browser-install-btn:hover {
  background: #5558e6;
  transform: translateY(-1px);
}

/* ===== Empty State ===== */
.empty-state {
  text-align: center;
  padding: 48px 20px;
  color: rgba(255, 255, 255, 0.4);
}

.empty-state-icon { font-size: 48px; margin-bottom: 16px; }
.empty-state-text { font-size: 15px; line-height: 1.5; }

/* ===== Lock / Accountability ===== */
.lock-container {
  padding: 0;
}

/* Lock mode radio selector */
.lock-mode-option {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  gap: 14px;
  cursor: pointer;
  transition: background 0.15s;
}

.lock-mode-option + .lock-mode-option {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.lock-mode-option:hover {
  background: rgba(255, 255, 255, 0.03);
}

.lock-mode-option.selected {
  background: rgba(99, 102, 241, 0.06);
}

.lock-mode-radio {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.2);
  flex-shrink: 0;
  position: relative;
  transition: border-color 0.15s;
}

.lock-mode-option.selected .lock-mode-radio {
  border-color: #6366f1;
}

.lock-mode-option.selected .lock-mode-radio::after {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #6366f1;
}

/* Status badges */
.status-badge {
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-badge::before {
  content: '';
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-badge.locked { color: #ef4444; }
.status-badge.locked::before { background: #ef4444; }
.status-badge.unlocked { color: #34d399; }
.status-badge.unlocked::before { background: #34d399; }
.status-badge.pending { color: #f59e0b; }
.status-badge.pending::before { background: #f59e0b; }
.status-badge.declined { color: #ef4444; }
.status-badge.declined::before { background: #ef4444; }
.status-badge.expired { color: #f59e0b; }
.status-badge.expired::before { background: #f59e0b; }
.status-badge.confirmed { color: #34d399; }
.status-badge.confirmed::before { background: #34d399; }

/* Setting input (inline in setting-row) */
.setting-input {
  flex: 1;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 14px;
  outline: none;
  font-family: inherit;
  min-width: 0;
}

.setting-input:focus {
  border-color: #6366f1;
}

.setting-input::placeholder {
  color: rgba(255, 255, 255, 0.3);
}

/* Full-width button rows */
.lock-btn-row {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.lock-btn-row .btn-primary,
.lock-btn-row .btn-secondary,
.lock-btn-row .btn-danger {
  flex: 1;
  text-align: center;
  margin-top: 0;
}

/* Helper text between cards */
.lock-helper-text {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
  padding: 12px 4px;
  line-height: 1.5;
}

/* Unlock code input */
.unlock-code-input {
  width: 200px;
  padding: 16px 24px;
  background: rgba(255, 255, 255, 0.06);
  border: 2px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  color: #ffffff;
  font-size: 28px;
  font-weight: 700;
  text-align: center;
  letter-spacing: 8px;
  outline: none;
  transition: border-color 0.2s;
}

.unlock-code-input:focus {
  border-color: #6366f1;
}

.unlock-code-input::placeholder {
  color: rgba(255, 255, 255, 0.2);
  letter-spacing: 4px;
  font-size: 18px;
}

/* Countdown timer */
.countdown-display {
  font-size: 48px;
  font-weight: 700;
  color: #f59e0b;
  font-variant-numeric: tabular-nums;
  margin: 16px 0;
}

/* Temporarily unlocked banner */
.unlock-timer-bar {
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  margin: 16px auto;
  max-width: 300px;
  overflow: hidden;
}

.unlock-timer-fill {
  height: 100%;
  background: #34d399;
  border-radius: 2px;
  transition: width 1s linear;
}

.btn-primary {
  padding: 12px 32px;
  background: #6366f1;
  border: none;
  border-radius: 10px;
  color: #ffffff;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-primary:hover {
  background: #5558e6;
  transform: translateY(-1px);
}

.btn-primary:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  padding: 12px 32px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 10px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
}

.btn-danger {
  padding: 12px 32px;
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 10px;
  color: #ef4444;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-danger:hover {
  background: rgba(239, 68, 68, 0.25);
}

/* ===== Advanced Page ===== */
.info-row {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  gap: 14px;
}

.info-row + .info-row {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.info-label {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
  min-width: 120px;
}

.info-value {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
  font-family: "SF Mono", Menlo, monospace;
  word-break: break-all;
}

/* ===== Toast ===== */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  padding: 12px 24px;
  background: #6366f1;
  color: #ffffff;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 500;
  z-index: 1000;
  transition: transform 0.3s ease;
  pointer-events: none;
}

.toast.visible {
  transform: translateX(-50%) translateY(0);
}

.toast.error {
  background: #ef4444;
}

.toast.warning {
  background: #f59e0b;
  color: #000000;
}

/* ===== Locked Settings ===== */
.setting-row.locked {
  opacity: 0.4;
  pointer-events: none;
  position: relative;
}

.locked-banner {
  padding: 12px 20px;
  background: rgba(239, 68, 68, 0.08);
  border: 1px solid rgba(239, 68, 68, 0.2);
  border-radius: 10px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.6);
}

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 3px; }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-header">
    <div class="logo-ring">üéØ</div>
    <span class="sidebar-title">Intentional</span>
  </div>
  <div class="sidebar-item active" data-page="usage" onclick="navigateTo('usage')">
    <span class="sidebar-item-icon">üìä</span> Usage
  </div>
  <div class="sidebar-divider"></div>
  <div class="sidebar-label">Platforms</div>
  <div class="sidebar-item" data-page="youtube" onclick="navigateTo('youtube')">
    <span class="sidebar-item-icon">‚ñ∂Ô∏è</span> YouTube
  </div>
  <div class="sidebar-item" data-page="instagram" onclick="navigateTo('instagram')">
    <span class="sidebar-item-icon">üì∑</span> Instagram
  </div>
  <div class="sidebar-item" data-page="facebook" onclick="navigateTo('facebook')">
    <span class="sidebar-item-icon">üë§</span> Facebook
  </div>
  <div class="sidebar-divider"></div>
  <div class="sidebar-item" data-page="lock" onclick="navigateTo('lock')">
    <span class="sidebar-item-icon">üîí</span> Accountability
  </div>
  <div class="sidebar-item" data-page="browsers" onclick="navigateTo('browsers')">
    <span class="sidebar-item-icon">üåê</span> Browsers
  </div>
  <div class="sidebar-item" data-page="advanced" onclick="navigateTo('advanced')">
    <span class="sidebar-item-icon">‚öôÔ∏è</span> Advanced
  </div>
</div>

<!-- Main -->
<div class="main">

  <!-- Header -->
  <div class="header">
    <div class="header-right">
      <span class="status-dot"></span>
      <span class="status-text">Monitoring active</span>
    </div>
  </div>

  <!-- Page: Usage -->
  <div class="page active" id="page-usage">
    <div class="section-title">Today</div>
    <div class="usage-grid">
      <div class="usage-card">
        <div class="usage-card-header">
          <span class="usage-card-icon">‚ñ∂Ô∏è</span>
          <span class="usage-card-platform">YouTube</span>
        </div>
        <div class="usage-card-time">
          <span class="usage-minutes youtube" id="yt-minutes">0</span>
          <span class="usage-unit">min</span>
        </div>
        <div class="usage-budget" id="yt-budget">/ 30 min budget</div>
        <div class="usage-bar">
          <div class="usage-bar-fill youtube" id="yt-bar" style="width: 0%"></div>
        </div>
      </div>

      <div class="usage-card">
        <div class="usage-card-header">
          <span class="usage-card-icon">üì∑</span>
          <span class="usage-card-platform">Instagram</span>
        </div>
        <div class="usage-card-time">
          <span class="usage-minutes instagram" id="ig-minutes">0</span>
          <span class="usage-unit">min</span>
        </div>
        <div class="usage-budget" id="ig-budget">/ 30 min budget</div>
        <div class="usage-bar">
          <div class="usage-bar-fill instagram" id="ig-bar" style="width: 0%"></div>
        </div>
      </div>

      <div class="usage-card">
        <div class="usage-card-header">
          <span class="usage-card-icon">üë§</span>
          <span class="usage-card-platform">Facebook</span>
        </div>
        <div class="usage-card-time">
          <span class="usage-minutes facebook" id="fb-minutes">0</span>
          <span class="usage-unit">min</span>
        </div>
        <div class="usage-budget" id="fb-budget">/ 30 min budget</div>
        <div class="usage-bar">
          <div class="usage-bar-fill facebook" id="fb-bar" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page: YouTube Settings -->
  <div class="page" id="page-youtube">
    <div class="section-title">YouTube Settings</div>

    <div class="settings-card">
      <div class="settings-card-title">General</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable YouTube filtering</div>
          <div class="setting-desc">Filter content based on your stated intent</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="yt-enabled" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Daily budget</div>
          <div class="setting-desc">Maximum minutes per day</div>
        </div>
        <input type="number" class="setting-number" id="yt-budget-input" value="30" min="1" max="480" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Filtering</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Relevance threshold</div>
          <div class="setting-desc">Higher = stricter filtering</div>
        </div>
        <input type="range" class="setting-range" id="yt-threshold" min="1" max="100" value="35" oninput="document.getElementById('yt-threshold-val').textContent = this.value + '%'; onSettingChange()">
        <span class="setting-value" id="yt-threshold-val">35%</span>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block mode</div>
          <div class="setting-desc">How to handle irrelevant videos</div>
        </div>
        <select class="setting-select" id="yt-block-mode" onchange="onSettingChange()">
          <option value="hide">Hide</option>
          <option value="blur">Blur</option>
        </select>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Content Blocking</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Shorts</div>
          <div class="setting-desc">Remove YouTube Shorts from feed</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="yt-block-shorts" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Hide sponsored content</div>
          <div class="setting-desc">Remove ads and sponsored videos</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="yt-hide-sponsored" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Zen Loading Screen</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Zen duration</div>
          <div class="setting-desc">Calming transition before browsing</div>
        </div>
        <input type="range" class="setting-range" id="yt-zen-duration" min="5" max="20" value="10" oninput="document.getElementById('yt-zen-val').textContent = this.value + 's'; onSettingChange()">
        <span class="setting-value" id="yt-zen-val">10s</span>
      </div>
    </div>
  </div>

  <!-- Page: Instagram Settings -->
  <div class="page" id="page-instagram">
    <div class="section-title">Instagram Settings</div>

    <div class="settings-card">
      <div class="settings-card-title">General</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable Instagram filtering</div>
          <div class="setting-desc">Filter content on Instagram</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-enabled" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Daily budget</div>
          <div class="setting-desc">Maximum minutes per day</div>
        </div>
        <input type="number" class="setting-number" id="ig-budget-input" value="30" min="1" max="480" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Content Blocking</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Reels</div>
          <div class="setting-desc">Remove video posts from feed and block /reels/</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-block-reels" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Explore page</div>
          <div class="setting-desc">Block access to /explore/</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-block-explore" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">NSFW filter</div>
          <div class="setting-desc">Block adult content using image classification</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-nsfw-filter" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Hide sponsored posts</div>
          <div class="setting-desc">Remove ads from feed</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-hide-ads" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Filtering</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Relevance threshold</div>
          <div class="setting-desc">Higher = stricter filtering</div>
        </div>
        <input type="range" class="setting-range" id="ig-threshold" min="1" max="100" value="35" oninput="document.getElementById('ig-threshold-val').textContent = this.value + '%'; onSettingChange()">
        <span class="setting-value" id="ig-threshold-val">35%</span>
      </div>
    </div>
  </div>

  <!-- Page: Facebook Settings -->
  <div class="page" id="page-facebook">
    <div class="section-title">Facebook Settings</div>

    <div class="settings-card">
      <div class="settings-card-title">General</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable Facebook filtering</div>
          <div class="setting-desc">Filter content on Facebook</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-enabled" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Daily budget</div>
          <div class="setting-desc">Maximum minutes per day</div>
        </div>
        <input type="number" class="setting-number" id="fb-budget-input" value="30" min="1" max="480" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Content Blocking</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Watch videos</div>
          <div class="setting-desc">Block access to Facebook Watch</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-watch" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Reels</div>
          <div class="setting-desc">Block Facebook Reels</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-reels" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Marketplace</div>
          <div class="setting-desc">Block Facebook Marketplace</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-marketplace" onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Hide sponsored posts</div>
          <div class="setting-desc">Remove ads from feed</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-hide-ads" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>
  </div>

  <!-- Page: Accountability / Lock -->
  <div class="page" id="page-lock">
    <div class="section-title">Accountability Partner</div>
    <div class="lock-container" id="lock-content">
      <div class="lock-icon">üîì</div>
      <div class="lock-title">Loading...</div>
    </div>
  </div>

  <!-- Page: Browsers -->
  <div class="page" id="page-browsers">
    <div class="section-title">Browsers</div>
    <div class="browser-card" id="browser-card">
      <div class="empty-state" id="browser-empty">
        <div class="empty-state-icon">üåê</div>
        <div class="empty-state-text">Loading browser status...</div>
      </div>
    </div>
  </div>

  <!-- Page: Advanced -->
  <div class="page" id="page-advanced">
    <div class="section-title">Advanced Settings</div>

    <div class="settings-card">
      <div class="settings-card-title">Time Limits</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Per-period limit</div>
          <div class="setting-desc">Max time within a rolling period</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="adv-period-enabled" onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Period minutes</div>
          <div class="setting-desc">Max minutes per period</div>
        </div>
        <input type="number" class="setting-number" id="adv-period-minutes" value="20" min="1" max="120" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Period length</div>
          <div class="setting-desc">Rolling period in hours</div>
        </div>
        <input type="number" class="setting-number" id="adv-period-hours" value="1" min="1" max="24" onchange="onSettingChange()">
        <span class="setting-value">hr</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Device Info</div>
      <div class="info-row">
        <span class="info-label">Device ID</span>
        <span class="info-value" id="adv-device-id">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">Backend URL</span>
        <span class="info-value">api.intentional.social</span>
      </div>
      <div class="info-row">
        <span class="info-label">App Version</span>
        <span class="info-value">1.0</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Danger Zone</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Reset all settings</div>
          <div class="setting-desc">Clear all settings and return to onboarding</div>
        </div>
        <button class="btn-danger" onclick="confirmReset()">Reset</button>
      </div>
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ===== Bridge =====
function sendMessage(payload) {
  if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.intentional) {
    window.webkit.messageHandlers.intentional.postMessage(payload);
  }
}

// ===== Settings State =====
var settings = {
  lockMode: 'none',
  partnerEmail: '',
  partnerName: '',
  consentStatus: 'none',
  maxPerPeriod: { enabled: false, minutes: 20, periodHours: 1 },
  temporaryUnlockUntil: null,
  selfUnlockAvailableAt: null,
  unlockRequested: false,
  youtube: {},
  instagram: {},
  facebook: {},
  deviceId: ''
};

var settingSaveTimer = null;

// ===== Toast =====
var toastTimer = null;
function showToast(msg, type) {
  var el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast visible' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() {
    el.className = 'toast';
  }, type === 'error' ? 4000 : 3000);
}

// ===== Navigation =====
function navigateTo(pageId) {
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.sidebar-item').forEach(function(s) { s.classList.remove('active'); });
  var page = document.getElementById('page-' + pageId);
  if (page) page.classList.add('active');
  var nav = document.querySelector('[data-page="' + pageId + '"]');
  if (nav) nav.classList.add('active');

  // Poll consent status when viewing accountability page with pending consent
  if (pageId === 'lock' && settings.consentStatus === 'pending') {
    sendMessage({ type: 'GET_PARTNER_STATUS' });
    startConsentPolling();
  } else {
    stopConsentPolling();
  }
}

// ===== Refresh Data =====
function refresh() {
  sendMessage({ type: 'GET_DASHBOARD_DATA' });
  sendMessage({ type: 'GET_EXTENSION_STATUS' });
}

// ===== HTML Escape =====
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ===== Button Loading States =====
function setButtonLoading(btnId, loadingText) {
  var btn = document.getElementById(btnId);
  if (!btn) return;
  btn._originalText = btn.textContent;
  btn.textContent = loadingText || 'Loading...';
  btn.disabled = true;
  btn.style.opacity = '0.6';
}

function clearButtonLoading(btnId) {
  var btn = document.getElementById(btnId);
  if (!btn) return;
  btn.textContent = btn._originalText || btn.textContent;
  btn.disabled = false;
  btn.style.opacity = '';
}

// ===== Setting Change Handler (debounced save) =====
function onSettingChange() {
  clearTimeout(settingSaveTimer);
  settingSaveTimer = setTimeout(saveAllSettings, 800);
}

function saveAllSettings() {
  var ytSettings = {
    enabled: document.getElementById('yt-enabled').checked,
    budget: parseInt(document.getElementById('yt-budget-input').value) || 30,
    threshold: parseInt(document.getElementById('yt-threshold').value) || 35,
    blockShorts: document.getElementById('yt-block-shorts').checked,
    hideSponsored: document.getElementById('yt-hide-sponsored').checked,
    blockMode: document.getElementById('yt-block-mode').value,
    zenDuration: parseInt(document.getElementById('yt-zen-duration').value) || 10
  };

  var igSettings = {
    enabled: document.getElementById('ig-enabled').checked,
    budget: parseInt(document.getElementById('ig-budget-input').value) || 30,
    threshold: parseInt(document.getElementById('ig-threshold').value) || 35,
    blockReels: document.getElementById('ig-block-reels').checked,
    blockExplore: document.getElementById('ig-block-explore').checked,
    nsfwFilter: document.getElementById('ig-nsfw-filter').checked,
    hideAds: document.getElementById('ig-hide-ads').checked
  };

  var fbSettings = {
    enabled: document.getElementById('fb-enabled').checked,
    budget: parseInt(document.getElementById('fb-budget-input').value) || 30,
    blockWatch: document.getElementById('fb-block-watch').checked,
    blockReels: document.getElementById('fb-block-reels').checked,
    blockMarketplace: document.getElementById('fb-block-marketplace').checked,
    hideAds: document.getElementById('fb-hide-ads').checked
  };

  var maxPerPeriod = {
    enabled: document.getElementById('adv-period-enabled').checked,
    minutes: parseInt(document.getElementById('adv-period-minutes').value) || 20,
    periodHours: parseInt(document.getElementById('adv-period-hours').value) || 1
  };

  sendMessage({
    type: 'SAVE_SETTINGS',
    settings: {
      youtube: ytSettings,
      instagram: igSettings,
      facebook: fbSettings,
      lockMode: settings.lockMode,
      partnerEmail: settings.partnerEmail,
      partnerName: settings.partnerName,
      maxPerPeriod: maxPerPeriod
    }
  });
}

// Populate settings UI from loaded data
function populateSettingsUI(data) {
  if (data.youtube) {
    var yt = data.youtube;
    document.getElementById('yt-enabled').checked = yt.enabled !== false;
    document.getElementById('yt-budget-input').value = yt.budget || 30;
    document.getElementById('yt-threshold').value = yt.threshold || 35;
    document.getElementById('yt-threshold-val').textContent = (yt.threshold || 35) + '%';
    document.getElementById('yt-block-shorts').checked = yt.blockShorts !== false;
    document.getElementById('yt-hide-sponsored').checked = yt.hideSponsored !== false;
    document.getElementById('yt-block-mode').value = yt.blockMode || 'hide';
    document.getElementById('yt-zen-duration').value = yt.zenDuration || 10;
    document.getElementById('yt-zen-val').textContent = (yt.zenDuration || 10) + 's';
  }

  if (data.instagram) {
    var ig = data.instagram;
    document.getElementById('ig-enabled').checked = ig.enabled !== false;
    document.getElementById('ig-budget-input').value = ig.budget || 30;
    document.getElementById('ig-threshold').value = ig.threshold || 35;
    document.getElementById('ig-threshold-val').textContent = (ig.threshold || 35) + '%';
    document.getElementById('ig-block-reels').checked = ig.blockReels !== false;
    document.getElementById('ig-block-explore').checked = ig.blockExplore !== false;
    document.getElementById('ig-nsfw-filter').checked = ig.nsfwFilter !== false;
    document.getElementById('ig-hide-ads').checked = ig.hideAds !== false;
  }

  if (data.facebook) {
    var fb = data.facebook;
    document.getElementById('fb-enabled').checked = fb.enabled !== false;
    document.getElementById('fb-budget-input').value = fb.budget || 30;
    document.getElementById('fb-block-watch').checked = fb.blockWatch !== false;
    document.getElementById('fb-block-reels').checked = fb.blockReels !== false;
    document.getElementById('fb-block-marketplace').checked = fb.blockMarketplace === true;
    document.getElementById('fb-hide-ads').checked = fb.hideAds !== false;
  }

  if (data.maxPerPeriod) {
    var mpp = data.maxPerPeriod;
    document.getElementById('adv-period-enabled').checked = mpp.enabled === true;
    document.getElementById('adv-period-minutes').value = mpp.minutes || 20;
    document.getElementById('adv-period-hours').value = mpp.periodHours || 1;
  }

  if (data.deviceId) {
    document.getElementById('adv-device-id').textContent = data.deviceId;
  }
}

// ===== Lock State Machine =====
function getLockState() {
  var mode = settings.lockMode || 'none';
  var consent = settings.consentStatus || 'none';
  var hasPartner = settings.partnerEmail && settings.partnerEmail !== '';

  // Check unlock state (permanent or temporary)
  if (settings.settingsUnlocked) return 'unlocked';
  if (settings.temporaryUnlockUntil) {
    var unlockEnd = new Date(settings.temporaryUnlockUntil).getTime();
    if (unlockEnd > Date.now()) {
      // Far-future sentinel (year 9000+) = permanently unlocked
      if (new Date(settings.temporaryUnlockUntil).getFullYear() >= 9000) return 'unlocked';
      return 'temporarily_unlocked';
    }
  }

  // Check self-lock countdown
  if (mode === 'self' && settings.selfUnlockAvailableAt) {
    var availAt = new Date(settings.selfUnlockAvailableAt).getTime();
    if (availAt > Date.now()) return 'self_countdown';
  }

  // Check if we're waiting for unlock code entry
  if (mode !== 'none' && settings.unlockRequested) return 'unlock_code_entry';

  // Consent states take priority over "locked" ‚Äî if partner hasn't confirmed yet,
  // showing "locked" is wrong. Only show locked when consent is confirmed (or for self mode).
  if (hasPartner && consent === 'pending') return 'pending';
  if (hasPartner && consent === 'declined') return 'declined';
  if (hasPartner && consent === 'expired') return 'expired';

  // Now check actual lock state
  if (mode !== 'none') return 'locked';

  // Partner confirmed but no lock mode chosen yet
  if (hasPartner && consent === 'confirmed') return 'confirmed';

  return 'setup';
}

var selectedLockMode = 'none';

function selectLockMode(mode) {
  selectedLockMode = mode;
  document.querySelectorAll('.lock-mode-option').forEach(function(opt) {
    opt.classList.toggle('selected', opt.getAttribute('data-mode') === mode);
  });
  var partnerCard = document.getElementById('partner-fields-card');
  if (partnerCard) {
    partnerCard.style.display = (mode === 'none') ? 'none' : '';
  }
}

var countdownInterval = null;

function renderLockState() {
  var el = document.getElementById('lock-content');
  var state = getLockState();
  var email = escapeHtml(settings.partnerEmail || '');
  var name = escapeHtml(settings.partnerName || '');
  var partnerDisplay = name ? name + ' (' + email + ')' : email;

  // Clear any running countdown
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }

  switch (state) {
    case 'pending':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Invitation</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge pending">Pending</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Sent to</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">Your partner needs to click the confirmation link in their email before lock mode can be activated.</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="resend-invite-btn" onclick="resendInvite()">Resend Invitation</button>' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
        '</div>';
      startConsentPolling();
      break;

    case 'confirmed':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Status</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge confirmed">Confirmed</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">Your partner is ready. Choose how to lock your settings:</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="enable-partner-btn" onclick="enableLockMode(\'partner\')">Enable Partner Lock</button>' +
          '<button class="btn-secondary" id="enable-self-btn" onclick="enableLockMode(\'self\')">Enable 24-Hour Delay</button>' +
        '</div>' +
        '<div class="lock-btn-row" style="margin-top:8px;">' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
          '<button class="btn-danger" id="remove-partner-btn" onclick="removePartner()">Remove Partner</button>' +
        '</div>';
      stopConsentPolling();
      break;

    case 'locked':
      var mode = settings.lockMode || 'partner';
      var modeLabel = mode === 'partner' ? 'Partner Lock' : '24-Hour Delay';
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Lock Status</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge locked">Locked</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Mode</div>' +
            '<span class="setting-value">' + modeLabel + '</span>' +
          '</div>' +
          (partnerDisplay ?
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' : '') +
        '</div>' +
        '<div class="settings-card">' +
          '<div class="settings-card-title">Protected Settings</div>' +
          '<div class="setting-row"><div class="setting-label">Platform toggles (YouTube, Instagram, Facebook)</div></div>' +
          '<div class="setting-row"><div class="setting-label">Relevance thresholds</div></div>' +
          '<div class="setting-row"><div class="setting-label">Content blocking (Shorts, Reels, Watch)</div></div>' +
          '<div class="setting-row"><div class="setting-label">Blocked categories</div></div>' +
        '</div>' +
        '<button class="btn-primary" id="request-unlock-btn" onclick="requestUnlock()" style="width:100%;margin-top:16px;">Request Unlock Code</button>';
      stopConsentPolling();
      break;

    case 'unlock_code_entry':
      var codeMode = settings.lockMode || 'partner';
      var codeMsg = codeMode === 'partner'
        ? 'A 6-digit code has been sent to your partner. Enter it below to temporarily unlock settings.'
        : 'Enter the 6-digit code you received to temporarily unlock settings.';
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Enter Unlock Code</div>' +
          '<div style="padding:24px 20px;text-align:center;">' +
            '<div class="lock-helper-text" style="padding:0;margin-bottom:20px;">' + codeMsg + '</div>' +
            '<input type="text" class="unlock-code-input" id="unlock-code" maxlength="6" placeholder="000000" oninput="onCodeInput(this)">' +
          '</div>' +
        '</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="verify-code-btn" onclick="verifyUnlockCode()" disabled>Verify Code</button>' +
          '<button class="btn-secondary" onclick="cancelUnlock()">Cancel</button>' +
        '</div>';
      setTimeout(function() {
        var inp = document.getElementById('unlock-code');
        if (inp) inp.focus();
      }, 100);
      stopConsentPolling();
      break;

    case 'self_countdown':
      var availAt = new Date(settings.selfUnlockAvailableAt).getTime();
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Unlock Request</div>' +
          '<div style="text-align:center;padding:24px 20px;">' +
            '<div style="font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:8px;">Time remaining</div>' +
            '<div class="countdown-display" id="countdown-timer" style="margin:12px 0;">--:--:--</div>' +
            '<div class="unlock-timer-bar"><div class="unlock-timer-fill" id="countdown-bar" style="width:100%;background:#f59e0b;"></div></div>' +
            '<div class="lock-helper-text" style="padding:0;margin-top:12px;">The unlock code will be sent to your email when the countdown reaches zero.</div>' +
          '</div>' +
        '</div>' +
        '<button class="btn-secondary" onclick="cancelUnlock()" style="width:100%;margin-top:16px;">Cancel Request</button>';
      updateCountdown(availAt);
      countdownInterval = setInterval(function() {
        updateCountdown(availAt);
      }, 1000);
      stopConsentPolling();
      break;

    case 'unlocked':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Lock Status</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge unlocked">Unlocked</span>' +
          '</div>' +
          (partnerDisplay ?
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' : '') +
        '</div>' +
        '<div class="lock-helper-text">Settings are unlocked. Make your changes, then re-lock when done.</div>' +
        '<button class="btn-primary" onclick="relockSettings()" style="width:100%;">Re-lock Settings</button>' +
        '<div class="lock-btn-row" style="margin-top:8px;">' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
          '<button class="btn-danger" id="remove-partner-btn" onclick="removePartner()">Remove Partner</button>' +
        '</div>';
      stopConsentPolling();
      break;

    case 'temporarily_unlocked':
      var unlockEnd = new Date(settings.temporaryUnlockUntil).getTime();
      var totalMs = 5 * 60 * 1000;
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Temporary Unlock</div>' +
          '<div style="text-align:center;padding:24px 20px;">' +
            '<div style="font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:8px;">Time remaining</div>' +
            '<div class="countdown-display" id="unlock-countdown" style="color:#34d399;margin:12px 0;">--:--</div>' +
            '<div class="unlock-timer-bar"><div class="unlock-timer-fill" id="unlock-bar"></div></div>' +
            '<div class="lock-helper-text" style="padding:0;margin-top:12px;">Make your changes now. Lock re-engages when timer expires.</div>' +
          '</div>' +
        '</div>';
      updateUnlockCountdown(unlockEnd, totalMs);
      countdownInterval = setInterval(function() {
        updateUnlockCountdown(unlockEnd, totalMs);
      }, 1000);
      stopConsentPolling();
      break;

    case 'declined':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Invitation</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge declined">Declined</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">' + (name || email) + ' declined the accountability request. You can try a different partner.</div>' +
        '<div class="settings-card">' +
          '<div class="settings-card-title">New Partner</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Name</div>' +
            '<input class="setting-input" id="lock-partner-name" placeholder="Optional">' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Email</div>' +
            '<input class="setting-input" id="lock-partner-email" placeholder="partner@email.com" type="email">' +
          '</div>' +
        '</div>' +
        '<button class="btn-primary" id="save-lock-btn" onclick="saveLockSettings()" style="width:100%;margin-top:16px;">Save Lock Settings</button>';
      stopConsentPolling();
      break;

    case 'expired':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Invitation</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge expired">Expired</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Sent to</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">The invitation expired after 7 days without a response.</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="resend-invite-btn" onclick="resendInvite()">Resend Invitation</button>' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
        '</div>';
      stopConsentPolling();
      break;

    default: // 'setup'
      var noneSelected = selectedLockMode === 'none' || !selectedLockMode ? ' selected' : '';
      var partnerSelected = selectedLockMode === 'partner' ? ' selected' : '';
      var selfSelected = selectedLockMode === 'self' ? ' selected' : '';
      var showPartner = (selectedLockMode && selectedLockMode !== 'none') ? '' : ' style="display:none"';
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Lock Mode</div>' +
          '<div class="lock-mode-option' + noneSelected + '" data-mode="none" onclick="selectLockMode(\'none\')">' +
            '<div class="lock-mode-radio"></div>' +
            '<div>' +
              '<div class="setting-label">Unlocked</div>' +
              '<div class="setting-desc">Anyone can change settings freely</div>' +
            '</div>' +
          '</div>' +
          '<div class="lock-mode-option' + partnerSelected + '" data-mode="partner" onclick="selectLockMode(\'partner\')">' +
            '<div class="lock-mode-radio"></div>' +
            '<div>' +
              '<div class="setting-label">Partner Lock</div>' +
              '<div class="setting-desc">Partner receives unlock codes via email</div>' +
            '</div>' +
          '</div>' +
          '<div class="lock-mode-option' + selfSelected + '" data-mode="self" onclick="selectLockMode(\'self\')">' +
            '<div class="lock-mode-radio"></div>' +
            '<div>' +
              '<div class="setting-label">24-Hour Delay</div>' +
              '<div class="setting-desc">24-hour cooling period before settings can change</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="settings-card" id="partner-fields-card"' + showPartner + '>' +
          '<div class="settings-card-title">Accountability Partner</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Name</div>' +
            '<input class="setting-input" id="lock-partner-name" placeholder="Optional" value="' + name + '">' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Email</div>' +
            '<input class="setting-input" id="lock-partner-email" placeholder="partner@email.com" type="email" value="' + email + '">' +
          '</div>' +
        '</div>' +
        '<button class="btn-primary" id="save-lock-btn" onclick="saveLockSettings()" style="width:100%;margin-top:16px;">Save Lock Settings</button>';
      stopConsentPolling();
  }

  // Enforce lock on platform settings pages
  enforceLockMode();
}

// ===== Lock Enforcement on Settings Pages =====
var LOCKED_INPUT_IDS = [
  'yt-enabled', 'ig-enabled', 'fb-enabled',
  'yt-threshold', 'ig-threshold',
  'yt-block-shorts', 'ig-block-reels',
  'fb-block-watch', 'fb-block-reels'
];

function isSettingsLocked() {
  var state = getLockState();
  return state === 'locked' || state === 'unlock_code_entry' || state === 'self_countdown';
}

function enforceLockMode() {
  var locked = isSettingsLocked();

  // Add/remove locked class on specific setting rows
  LOCKED_INPUT_IDS.forEach(function(id) {
    var input = document.getElementById(id);
    if (!input) return;
    var row = input.closest('.setting-row');
    if (!row) return;
    if (locked) {
      row.classList.add('locked');
    } else {
      row.classList.remove('locked');
    }
  });

  // Add/remove locked banners on platform pages
  ['page-youtube', 'page-instagram', 'page-facebook'].forEach(function(pageId) {
    var page = document.getElementById(pageId);
    if (!page) return;
    var existingBanner = page.querySelector('.locked-banner');
    if (locked) {
      if (!existingBanner) {
        var banner = document.createElement('div');
        banner.className = 'locked-banner';
        banner.innerHTML = '<span>üîí</span> Settings are locked by your accountability partner. <a href="#" onclick="navigateTo(\'lock\'); return false;" style="color:#6366f1; text-decoration:underline;">Request unlock</a>';
        var firstCard = page.querySelector('.settings-card');
        if (firstCard) page.insertBefore(banner, firstCard);
      }
    } else {
      if (existingBanner) existingBanner.remove();
    }
  });
}

// ===== Countdown Helpers =====
function updateCountdown(targetMs) {
  var el = document.getElementById('countdown-timer');
  if (!el) return;
  var diff = targetMs - Date.now();
  if (diff <= 0) {
    el.textContent = '00:00:00';
    // Countdown done - refresh state
    settings.selfUnlockAvailableAt = null;
    settings.unlockRequested = true;
    renderLockState();
    return;
  }
  var hours = Math.floor(diff / 3600000);
  var mins = Math.floor((diff % 3600000) / 60000);
  var secs = Math.floor((diff % 60000) / 1000);
  el.textContent = pad(hours) + ':' + pad(mins) + ':' + pad(secs);
  // Update progress bar
  var bar = document.getElementById('countdown-bar');
  if (bar) {
    var totalMs = 24 * 3600000;
    bar.style.width = Math.max(0, (diff / totalMs) * 100) + '%';
  }
}

function updateUnlockCountdown(endMs, totalMs) {
  var countdownEl = document.getElementById('unlock-countdown');
  var barEl = document.getElementById('unlock-bar');
  if (!countdownEl) return;
  var diff = endMs - Date.now();
  if (diff <= 0) {
    countdownEl.textContent = '0:00';
    if (barEl) barEl.style.width = '0%';
    // Unlock window expired - go back to locked
    settings.temporaryUnlockUntil = null;
    renderLockState();
    return;
  }
  var mins = Math.floor(diff / 60000);
  var secs = Math.floor((diff % 60000) / 1000);
  countdownEl.textContent = mins + ':' + pad(secs);
  if (barEl) barEl.style.width = ((diff / totalMs) * 100) + '%';
}

function pad(n) { return n < 10 ? '0' + n : '' + n; }

// ===== Unlock Code Input =====
function onCodeInput(el) {
  el.value = el.value.replace(/[^0-9]/g, '');
  var btn = document.getElementById('verify-code-btn');
  if (btn) btn.disabled = el.value.length < 6;
}

function verifyUnlockCode() {
  var code = (document.getElementById('unlock-code') || {}).value || '';
  if (code.length < 6) return;
  setButtonLoading('verify-code-btn', 'Verifying...');
  sendMessage({ type: 'VERIFY_UNLOCK', code: code });
}

function cancelUnlock() {
  settings.unlockRequested = false;
  settings.selfUnlockAvailableAt = null;
  renderLockState();
}

function relockSettings() {
  settings.settingsUnlocked = false;
  settings.temporaryUnlockUntil = null;
  settings.unlockRequested = false;
  settings.selfUnlockAvailableAt = null;
  sendMessage({ type: 'RELOCK_SETTINGS' });
  showToast('Settings re-locked');
  renderLockState();
}

// ===== Lock Actions =====
function saveLockSettings() {
  var email = (document.getElementById('lock-partner-email') || {}).value || '';
  var name = (document.getElementById('lock-partner-name') || {}).value || '';

  if (selectedLockMode !== 'none' && !email) {
    showToast('Partner email is required for lock mode', 'error');
    return;
  }

  setButtonLoading('save-lock-btn', 'Saving...');
  settings.partnerEmail = email;
  settings.partnerName = name;

  sendMessage({
    type: 'SAVE_LOCK_SETTINGS',
    lockMode: selectedLockMode,
    partnerEmail: email,
    partnerName: name
  });
}

function enableLockMode(mode) {
  var btnId = mode === 'partner' ? 'enable-partner-btn' : 'enable-self-btn';
  setButtonLoading(btnId, 'Enabling...');
  sendMessage({
    type: 'SAVE_LOCK_SETTINGS',
    lockMode: mode,
    partnerEmail: settings.partnerEmail,
    partnerName: settings.partnerName
  });
}

function removePartner() {
  if (!confirm('Remove your accountability partner? This will also disable the lock.')) return;
  setButtonLoading('remove-partner-btn', 'Removing...');
  sendMessage({ type: 'REMOVE_PARTNER' });
}

function resendInvite() {
  setButtonLoading('resend-invite-btn', 'Sending...');
  sendMessage({ type: 'RESEND_PARTNER_INVITE' });
}

function changePartner() {
  settings.partnerEmail = '';
  settings.partnerName = '';
  settings.consentStatus = 'none';
  // Persist the clear to Swift so it survives app restart
  sendMessage({
    type: 'SAVE_LOCK_SETTINGS',
    lockMode: settings.lockMode || 'none',
    partnerEmail: '',
    partnerName: ''
  });
  stopConsentPolling();
  renderLockState();
}

function requestUnlock() {
  setButtonLoading('request-unlock-btn', 'Requesting...');
  sendMessage({ type: 'REQUEST_UNLOCK' });
}

function confirmReset() {
  if (confirm('Reset all settings and return to onboarding? This cannot be undone.')) {
    sendMessage({ type: 'RESET_SETTINGS' });
  }
}

function copyStoreUrl(el, url) {
  navigator.clipboard.writeText(url).then(function() {
    var original = el.textContent;
    el.textContent = 'Copied!';
    el.classList.add('copied');
    setTimeout(function() {
      el.textContent = original;
      el.classList.remove('copied');
    }, 1500);
  });
}

function installExtension(browserName, bundleId) {
  var name = decodeURIComponent(browserName).toLowerCase();
  var storeUrl;
  if (name.indexOf('firefox') !== -1 || name.indexOf('waterfox') !== -1 || name.indexOf('librewolf') !== -1 || name.indexOf('zen') !== -1 || name.indexOf('floorp') !== -1) {
    storeUrl = 'https://addons.mozilla.org/en-US/firefox/search/?q=intentional';
  } else if (name.indexOf('safari') !== -1 || name.indexOf('orion') !== -1) {
    storeUrl = 'https://apps.apple.com/search/intentional';
  } else {
    storeUrl = 'https://chromewebstore.google.com/search/intentional';
  }
  sendMessage({ type: 'OPEN_EXTENSIONS_PAGE', url: storeUrl, bundleId: bundleId || null });
}

// ===== Consent Polling =====
var consentPollTimer = null;

function startConsentPolling() {
  if (consentPollTimer) return;
  consentPollTimer = setInterval(function() {
    sendMessage({ type: 'GET_PARTNER_STATUS' });
  }, 10000);
}

function stopConsentPolling() {
  if (consentPollTimer) {
    clearInterval(consentPollTimer);
    consentPollTimer = null;
  }
}

// ===== Callbacks from Swift =====

// Settings loaded
window._settingsResult = function(data) {
  if (data.lockMode !== undefined) settings.lockMode = data.lockMode;
  if (data.partnerEmail !== undefined) settings.partnerEmail = data.partnerEmail || '';
  if (data.partnerName !== undefined) settings.partnerName = data.partnerName || '';
  if (data.consentStatus !== undefined) settings.consentStatus = data.consentStatus;
  if (data.temporaryUnlockUntil !== undefined) settings.temporaryUnlockUntil = data.temporaryUnlockUntil;
  if (data.selfUnlockAvailableAt !== undefined) settings.selfUnlockAvailableAt = data.selfUnlockAvailableAt;
  if (data.deviceId !== undefined) settings.deviceId = data.deviceId;

  populateSettingsUI(data);
  renderLockState();
};

// Save settings result
window._saveSettingsResult = function(data) {
  if (data.success) {
    showToast('Settings saved');
  } else {
    showToast(data.message || 'Failed to save settings', 'error');
  }
};

// Lock settings saved
window._lockSettingsResult = function(data) {
  clearButtonLoading('save-lock-btn');
  settings.lockMode = data.lockMode || 'none';
  if (data.consentStatus) settings.consentStatus = data.consentStatus;
  if (data.partnerEmail !== undefined) settings.partnerEmail = data.partnerEmail || '';
  if (data.partnerName !== undefined) settings.partnerName = data.partnerName || '';

  renderLockState();

  if (data.success) {
    showToast(data.message || 'Lock settings saved');
  } else if (data.consentStatus === 'pending') {
    showToast('Partner invitation sent! Waiting for acceptance.', 'warning');
  } else {
    showToast(data.message || 'Failed to set lock mode', 'error');
  }
};

// Partner status (from polling)
window._partnerStatusResult = function(data) {
  if (!data.success) return;

  var changed = false;
  if (data.consentStatus && data.consentStatus !== settings.consentStatus) {
    settings.consentStatus = data.consentStatus;
    changed = true;
  }
  if (data.partnerEmail !== undefined && (data.partnerEmail || '') !== settings.partnerEmail) {
    settings.partnerEmail = data.partnerEmail || '';
    changed = true;
  }
  if (data.partnerName !== undefined && (data.partnerName || '') !== settings.partnerName) {
    settings.partnerName = data.partnerName || '';
    changed = true;
  }

  if (changed) {
    renderLockState();
  }
};

// Remove partner result
window._removePartnerResult = function(data) {
  if (data.success) {
    settings.partnerEmail = '';
    settings.partnerName = '';
    settings.consentStatus = 'none';
    settings.lockMode = 'none';
    settings.temporaryUnlockUntil = null;
    settings.selfUnlockAvailableAt = null;
    settings.unlockRequested = false;
    settings.settingsUnlocked = false;
    showToast('Partner removed');
  } else {
    showToast('Failed to remove partner', 'error');
  }
  renderLockState();
};

// Resend invite result
window._resendInviteResult = function(data) {
  clearButtonLoading('resend-invite-btn');
  if (data.success) {
    showToast(data.message || 'Invitation resent!');
  } else {
    showToast(data.message || 'Failed to resend invitation', 'error');
  }
};

// Unlock result
window._unlockResult = function(data) {
  if (data.success) {
    showToast(data.message || 'Unlock code sent!');
    // Transition to code entry or countdown state
    if (settings.lockMode === 'self') {
      settings.selfUnlockAvailableAt = data.availableAt || new Date(Date.now() + 24 * 3600000).toISOString();
    } else {
      settings.unlockRequested = true;
    }
    renderLockState();
  } else {
    clearButtonLoading('request-unlock-btn');
    showToast(data.message || 'Unlock request failed', 'error');
    if (data.message && data.message.indexOf('not locked') !== -1) {
      settings.lockMode = 'none';
      renderLockState();
    }
  }
};

// Verify unlock result
window._verifyUnlockResult = function(data) {
  if (data.success) {
    if (data.auto_relock === false) {
      showToast('Settings unlocked!');
      settings.settingsUnlocked = true;
      settings.temporaryUnlockUntil = null;
    } else {
      showToast('Settings unlocked for 5 minutes!');
      settings.temporaryUnlockUntil = data.unlockUntil || new Date(Date.now() + 5 * 60000).toISOString();
    }
    settings.unlockRequested = false;
    settings.selfUnlockAvailableAt = null;
    renderLockState();
  } else {
    clearButtonLoading('verify-code-btn');
    showToast(data.message || 'Invalid code', 'error');
  }
};

// Dashboard data
window._dashboardDataResult = function(data) {
  if (data.youtube) {
    document.getElementById('yt-minutes').textContent = data.youtube.minutesUsed || 0;
    document.getElementById('yt-budget').textContent = '/ ' + (data.youtube.budget || 30) + ' min budget';
    var pct = Math.min(100, ((data.youtube.minutesUsed || 0) / (data.youtube.budget || 30)) * 100);
    document.getElementById('yt-bar').style.width = pct + '%';
  }
  if (data.instagram) {
    document.getElementById('ig-minutes').textContent = data.instagram.minutesUsed || 0;
    document.getElementById('ig-budget').textContent = '/ ' + (data.instagram.budget || 30) + ' min budget';
    var pct2 = Math.min(100, ((data.instagram.minutesUsed || 0) / (data.instagram.budget || 30)) * 100);
    document.getElementById('ig-bar').style.width = pct2 + '%';
  }
  if (data.facebook) {
    document.getElementById('fb-minutes').textContent = data.facebook.minutesUsed || 0;
    document.getElementById('fb-budget').textContent = '/ ' + (data.facebook.budget || 30) + ' min budget';
    var pct3 = Math.min(100, ((data.facebook.minutesUsed || 0) / (data.facebook.budget || 30)) * 100);
    document.getElementById('fb-bar').style.width = pct3 + '%';
  }
};

// Browser status
window._extensionStatusResult = function(data) {
  var card = document.getElementById('browser-card');
  var empty = document.getElementById('browser-empty');

  if (!data.browsers || data.browsers.length === 0) {
    if (empty) {
      empty.innerHTML =
        '<div class="empty-state-icon">üåê</div>' +
        '<div class="empty-state-text">No browsers detected</div>';
    }
    return;
  }

  if (empty) empty.remove();

  // Sort: connected first, then alphabetical
  data.browsers.sort(function(a, b) {
    var aConn = (a.hasExtension && a.isEnabled) ? 0 : 1;
    var bConn = (b.hasExtension && b.isEnabled) ? 0 : 1;
    if (aConn !== bConn) return aConn - bConn;
    return a.name.localeCompare(b.name);
  });

  function getBrowserIcon(b) {
    if (b.iconDataUrl) {
      return '<span class="browser-icon"><img src="' + b.iconDataUrl + '" alt="' + escapeHtml(b.name) + '"></span>';
    }
    return '<span class="browser-icon" style="border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;background:#6B7280;">' + b.name.charAt(0).toUpperCase() + '</span>';
  }

  function getStoreUrl(name) {
    var n = name.toLowerCase();
    if (n.indexOf('firefox') !== -1 || n.indexOf('waterfox') !== -1 || n.indexOf('librewolf') !== -1 || n.indexOf('zen') !== -1 || n.indexOf('floorp') !== -1)
      return 'addons.mozilla.org';
    if (n.indexOf('safari') !== -1 || n.indexOf('orion') !== -1)
      return 'apps.apple.com';
    return 'chromewebstore.google.com';
  }

  function getFullStoreUrl(name) {
    var n = name.toLowerCase();
    if (n.indexOf('firefox') !== -1 || n.indexOf('waterfox') !== -1 || n.indexOf('librewolf') !== -1 || n.indexOf('zen') !== -1 || n.indexOf('floorp') !== -1)
      return 'https://addons.mozilla.org/en-US/firefox/search/?q=intentional';
    if (n.indexOf('safari') !== -1 || n.indexOf('orion') !== -1)
      return 'https://apps.apple.com/search/intentional';
    return 'https://chromewebstore.google.com/search/intentional';
  }

  card.innerHTML = data.browsers.map(function(b) {
    var icon = getBrowserIcon(b);
    var isConnected = b.hasExtension && b.isEnabled;
    var isDisabled = b.hasExtension && !b.isEnabled;
    var rowClass = 'browser-row' + (isConnected ? ' browser-connected' : '');
    var storeHint = getStoreUrl(b.name);
    var fullUrl = getFullStoreUrl(b.name);

    var statusHtml;
    if (isConnected) {
      statusHtml = '<span class="browser-status connected"><span class="browser-status-dot connected"></span>Connected</span>';
    } else if (isDisabled) {
      statusHtml = '<span class="browser-status" style="color: #f59e0b;">Disabled</span>';
    } else {
      statusHtml = '<button class="browser-install-btn" onclick="installExtension(\'' + encodeURIComponent(b.name) + '\', \'' + (b.bundleId || '') + '\')">Install</button>';
    }

    return '<div class="' + rowClass + '">' +
      icon +
      '<span class="browser-name">' + escapeHtml(b.name) + '</span>' +
      '<span class="browser-ext-url" onclick="copyStoreUrl(this, \'' + fullUrl + '\')" title="Click to copy store URL">' + storeHint + '</span>' +
      statusHtml +
    '</div>';
  }).join('');
};

// ===== Init =====
sendMessage({ type: 'GET_SETTINGS' });
sendMessage({ type: 'GET_PARTNER_STATUS' });
refresh();
setInterval(refresh, 5000);
</script>

</body>
</html>
