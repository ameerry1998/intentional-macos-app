<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Intentional ‚Äî Dashboard</title>
<style>
*, *::before, *::after {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen, sans-serif;
  background: #0a0a0a;
  color: #ffffff;
  min-height: 100vh;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  user-select: none;
  -webkit-user-select: none;
  display: flex;
}

/* ===== Sidebar ===== */
.sidebar {
  width: 220px;
  min-height: 100vh;
  background: rgba(255, 255, 255, 0.02);
  border-right: 1px solid rgba(255, 255, 255, 0.08);
  padding: 20px 0;
  flex-shrink: 0;
}

.sidebar-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 0 20px 20px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.06);
  margin-bottom: 12px;
}

.logo-ring {
  width: 32px;
  height: 32px;
  background: linear-gradient(135deg, rgba(99, 102, 241, 0.3) 0%, rgba(139, 92, 246, 0.2) 100%);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
}

.sidebar-title {
  font-size: 16px;
  font-weight: 600;
  letter-spacing: -0.3px;
}

.sidebar-divider {
  height: 1px;
  background: rgba(255, 255, 255, 0.06);
  margin: 8px 20px;
}

.sidebar-label {
  padding: 8px 20px 4px;
  font-size: 11px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.25);
  text-transform: uppercase;
  letter-spacing: 0.8px;
}

.sidebar-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 20px;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.5);
  cursor: pointer;
  transition: all 0.15s ease;
  border-left: 3px solid transparent;
}

.sidebar-item:hover {
  color: rgba(255, 255, 255, 0.8);
  background: rgba(255, 255, 255, 0.03);
}

.sidebar-item.active {
  color: #ffffff;
  background: rgba(99, 102, 241, 0.1);
  border-left-color: #6366f1;
}

.sidebar-item-icon {
  font-size: 16px;
  width: 20px;
  text-align: center;
}

/* ===== Main Content ===== */
.main {
  flex: 1;
  overflow-y: auto;
  max-height: 100vh;
}

/* ===== Header ===== */
.header {
  display: flex;
  align-items: center;
  justify-content: flex-end;
  padding: 20px 32px;
  border-bottom: 1px solid rgba(255, 255, 255, 0.08);
}

.header-right {
  display: flex;
  align-items: center;
  gap: 12px;
}

.status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #34d399;
}

.status-text {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.5);
}

/* ===== Pages ===== */
.page {
  display: none;
  max-width: 720px;
  margin: 0 auto;
  padding: 32px;
}

.page.active {
  display: block;
}

.section-title {
  font-size: 14px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.4);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 16px;
}

/* ===== Usage Cards ===== */
.usage-grid {
  display: grid;
  grid-template-columns: 1fr 1fr 1fr;
  gap: 16px;
  margin-bottom: 32px;
}

.usage-card {
  padding: 24px;
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  transition: all 0.3s ease;
}

.usage-card:hover {
  background: rgba(255, 255, 255, 0.05);
  border-color: rgba(255, 255, 255, 0.12);
}

.usage-card-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
}

.usage-card-icon { font-size: 20px; }
.usage-card-platform { font-size: 15px; font-weight: 600; }

.usage-card-time {
  display: flex;
  align-items: baseline;
  gap: 6px;
  margin-bottom: 12px;
}

.usage-minutes {
  font-size: 40px;
  font-weight: 700;
  line-height: 1;
}

.usage-minutes.youtube { color: #ef4444; }
.usage-minutes.instagram { color: #e879f9; }
.usage-minutes.facebook { color: #60a5fa; }

.usage-unit {
  font-size: 16px;
  color: rgba(255, 255, 255, 0.4);
}

.usage-budget {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
}

.usage-bar {
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  margin-top: 12px;
  overflow: hidden;
}

.usage-bar-fill {
  height: 100%;
  border-radius: 2px;
  transition: width 0.5s ease;
}

.usage-bar-fill.youtube { background: #ef4444; }
.usage-bar-fill.instagram { background: #e879f9; }
.usage-bar-fill.facebook { background: #60a5fa; }
.usage-bar-fill.free-browse { background: #f59e0b; }

.usage-session {
  display: flex;
  align-items: center;
  gap: 6px;
  margin-bottom: 10px;
}

.usage-session-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
  background: #34d399;
  animation: session-pulse 2s ease-in-out infinite;
}

@keyframes session-pulse {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.4; }
}

.usage-session-label {
  font-size: 11px;
  font-weight: 600;
  color: #34d399;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.usage-session-intent {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.55);
  font-style: italic;
  margin-top: 8px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.04);
  border-radius: 8px;
  border-left: 2px solid rgba(52, 211, 153, 0.4);
}

.usage-card.has-session {
  border-color: rgba(52, 211, 153, 0.2);
}

.usage-free-browse {
  font-size: 11px;
  color: rgba(245, 158, 11, 0.7);
  margin-top: 6px;
  display: none;
}

/* ===== Settings Card ===== */
.settings-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  overflow: hidden;
  margin-bottom: 20px;
}

.settings-card-title {
  padding: 16px 20px 8px;
  font-size: 13px;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.4);
  text-transform: uppercase;
  letter-spacing: 0.4px;
}

.setting-row {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  gap: 14px;
}

.setting-row + .setting-row {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.setting-label {
  flex: 1;
  font-size: 14px;
  font-weight: 500;
}

.setting-desc {
  font-size: 12px;
  color: rgba(255, 255, 255, 0.35);
  margin-top: 2px;
}

.setting-value {
  font-size: 14px;
  color: rgba(255, 255, 255, 0.5);
  min-width: 50px;
  text-align: right;
}

/* Toggle Switch */
.toggle {
  position: relative;
  width: 44px;
  height: 24px;
  flex-shrink: 0;
}

.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
}

.toggle-track {
  position: absolute;
  inset: 0;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  cursor: pointer;
  transition: background 0.2s;
}

.toggle-track::after {
  content: '';
  position: absolute;
  top: 2px;
  left: 2px;
  width: 20px;
  height: 20px;
  background: #ffffff;
  border-radius: 50%;
  transition: transform 0.2s;
}

.toggle input:checked + .toggle-track {
  background: #6366f1;
}

.toggle input:checked + .toggle-track::after {
  transform: translateX(20px);
}

/* Range Slider */
.setting-range {
  -webkit-appearance: none;
  appearance: none;
  width: 120px;
  height: 4px;
  background: rgba(255, 255, 255, 0.15);
  border-radius: 2px;
  outline: none;
}

.setting-range::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 16px;
  height: 16px;
  background: #6366f1;
  border-radius: 50%;
  cursor: pointer;
}

/* Select Dropdown */
.setting-select {
  padding: 6px 12px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 13px;
  outline: none;
  cursor: pointer;
}

.setting-select option {
  background: #1a1a2e;
  color: #ffffff;
}

/* Number Input */
.setting-number {
  width: 70px;
  padding: 6px 10px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 14px;
  text-align: center;
  outline: none;
}

.setting-number:focus {
  border-color: #6366f1;
}

/* ===== Browser Status ===== */
.browser-section { margin-bottom: 32px; }

.browser-card {
  background: rgba(255, 255, 255, 0.03);
  border: 1px solid rgba(255, 255, 255, 0.08);
  border-radius: 16px;
  overflow: hidden;
}

.browser-row {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  gap: 14px;
}

.browser-row + .browser-row {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.browser-icon { font-size: 20px; width: 28px; height: 28px; text-align: center; flex-shrink: 0; border-radius: 6px; overflow: hidden; }
.browser-icon img { width: 100%; height: 100%; object-fit: contain; }
.browser-name { width: 110px; flex-shrink: 0; font-size: 14px; font-weight: 500; }

.browser-status {
  font-size: 12px;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 6px;
}

.browser-status.connected { color: #34d399; }
.browser-status.disconnected { color: rgba(255, 255, 255, 0.3); }

.browser-status-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
}

.browser-status-dot.connected { background: #34d399; }
.browser-status-dot.disconnected { background: rgba(255, 255, 255, 0.2); }

.browser-row.browser-connected {
  background: rgba(52, 211, 153, 0.06);
}

.browser-ext-url {
  flex: 1;
  font-size: 11px;
  color: rgba(255, 255, 255, 0.35);
  font-family: "SF Mono", Menlo, monospace;
  padding: 3px 8px;
  background: rgba(255, 255, 255, 0.05);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.browser-ext-url:hover {
  color: rgba(255, 255, 255, 0.6);
  background: rgba(255, 255, 255, 0.1);
}

.browser-ext-url.copied {
  color: #34d399;
}

.browser-install-btn {
  padding: 5px 14px;
  font-size: 12px;
  font-weight: 600;
  border: none;
  border-radius: 8px;
  background: #6366f1;
  color: white;
  cursor: pointer;
  transition: all 0.2s;
  flex-shrink: 0;
  font-family: inherit;
}

.browser-install-btn:hover {
  background: #5558e6;
  transform: translateY(-1px);
}

/* ===== Empty State ===== */
.empty-state {
  text-align: center;
  padding: 48px 20px;
  color: rgba(255, 255, 255, 0.4);
}

.empty-state-icon { font-size: 48px; margin-bottom: 16px; }
.empty-state-text { font-size: 15px; line-height: 1.5; }

/* ===== Lock / Accountability ===== */
.lock-container {
  padding: 0;
}

/* Lock mode radio selector */
.lock-mode-option {
  display: flex;
  align-items: center;
  padding: 14px 20px;
  gap: 14px;
  cursor: pointer;
  transition: background 0.15s;
}

.lock-mode-option + .lock-mode-option {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.lock-mode-option:hover {
  background: rgba(255, 255, 255, 0.03);
}

.lock-mode-option.selected {
  background: rgba(99, 102, 241, 0.06);
}

.lock-mode-radio {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  border: 2px solid rgba(255, 255, 255, 0.2);
  flex-shrink: 0;
  position: relative;
  transition: border-color 0.15s;
}

.lock-mode-option.selected .lock-mode-radio {
  border-color: #6366f1;
}

.lock-mode-option.selected .lock-mode-radio::after {
  content: '';
  position: absolute;
  top: 3px;
  left: 3px;
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #6366f1;
}

/* Status badges */
.status-badge {
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 6px;
}

.status-badge::before {
  content: '';
  width: 8px;
  height: 8px;
  border-radius: 50%;
  flex-shrink: 0;
}

.status-badge.locked { color: #ef4444; }
.status-badge.locked::before { background: #ef4444; }
.status-badge.unlocked { color: #34d399; }
.status-badge.unlocked::before { background: #34d399; }
.status-badge.pending { color: #f59e0b; }
.status-badge.pending::before { background: #f59e0b; }
.status-badge.declined { color: #ef4444; }
.status-badge.declined::before { background: #ef4444; }
.status-badge.expired { color: #f59e0b; }
.status-badge.expired::before { background: #f59e0b; }
.status-badge.confirmed { color: #34d399; }
.status-badge.confirmed::before { background: #34d399; }

/* Setting input (inline in setting-row) */
.setting-input {
  flex: 1;
  padding: 8px 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 14px;
  outline: none;
  font-family: inherit;
  min-width: 0;
}

.setting-input:focus {
  border-color: #6366f1;
}

.setting-input::placeholder {
  color: rgba(255, 255, 255, 0.3);
}

/* Chip/Tag Input */
.chip-container {
  padding: 12px 20px 16px;
}
.chip-list {
  display: flex;
  flex-wrap: wrap;
  gap: 8px;
  margin-bottom: 10px;
  min-height: 24px;
}
.chip-list:empty::before {
  content: attr(data-empty);
  color: rgba(255, 255, 255, 0.25);
  font-size: 13px;
  font-style: italic;
}
.chip {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  background: rgba(99, 102, 241, 0.15);
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: 20px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.85);
}
.chip-remove {
  cursor: pointer;
  opacity: 0.5;
  font-size: 14px;
  line-height: 1;
  transition: opacity 0.15s;
}
.chip-remove:hover {
  opacity: 1;
}
.chip-input-row {
  display: flex;
  gap: 8px;
}
.chip-input-row input {
  flex: 1;
  padding: 6px 12px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 8px;
  color: #ffffff;
  font-size: 13px;
  outline: none;
  font-family: inherit;
}
.chip-input-row input:focus {
  border-color: #6366f1;
}
.chip-input-row input::placeholder {
  color: rgba(255, 255, 255, 0.3);
}
.chip-input-row button {
  padding: 6px 14px;
  background: rgba(99, 102, 241, 0.2);
  border: 1px solid rgba(99, 102, 241, 0.3);
  border-radius: 8px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 13px;
  cursor: pointer;
  font-family: inherit;
  transition: background 0.15s;
}
.chip-input-row button:hover {
  background: rgba(99, 102, 241, 0.35);
}

/* Full-width button rows */
.lock-btn-row {
  display: flex;
  gap: 10px;
  margin-top: 16px;
}

.lock-btn-row .btn-primary,
.lock-btn-row .btn-secondary,
.lock-btn-row .btn-danger {
  flex: 1;
  text-align: center;
  margin-top: 0;
}

/* Helper text between cards */
.lock-helper-text {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
  padding: 12px 4px;
  line-height: 1.5;
}

/* Unlock code input */
.unlock-code-input {
  width: 200px;
  padding: 16px 24px;
  background: rgba(255, 255, 255, 0.06);
  border: 2px solid rgba(255, 255, 255, 0.15);
  border-radius: 12px;
  color: #ffffff;
  font-size: 28px;
  font-weight: 700;
  text-align: center;
  letter-spacing: 8px;
  outline: none;
  transition: border-color 0.2s;
}

.unlock-code-input:focus {
  border-color: #6366f1;
}

.unlock-code-input::placeholder {
  color: rgba(255, 255, 255, 0.2);
  letter-spacing: 4px;
  font-size: 18px;
}

/* Countdown timer */
.countdown-display {
  font-size: 48px;
  font-weight: 700;
  color: #f59e0b;
  font-variant-numeric: tabular-nums;
  margin: 16px 0;
}

/* Temporarily unlocked banner */
.unlock-timer-bar {
  height: 4px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 2px;
  margin: 16px auto;
  max-width: 300px;
  overflow: hidden;
}

.unlock-timer-fill {
  height: 100%;
  background: #34d399;
  border-radius: 2px;
  transition: width 1s linear;
}

.btn-primary {
  padding: 12px 32px;
  background: #6366f1;
  border: none;
  border-radius: 10px;
  color: #ffffff;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-primary:hover {
  background: #5558e6;
  transform: translateY(-1px);
}

.btn-primary:disabled {
  opacity: 0.4;
  cursor: not-allowed;
  transform: none;
}

.btn-secondary {
  padding: 12px 32px;
  background: rgba(255, 255, 255, 0.06);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 10px;
  color: rgba(255, 255, 255, 0.8);
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-secondary:hover {
  background: rgba(255, 255, 255, 0.1);
}

.btn-danger {
  padding: 12px 32px;
  background: rgba(239, 68, 68, 0.15);
  border: 1px solid rgba(239, 68, 68, 0.3);
  border-radius: 10px;
  color: #ef4444;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
  margin-top: 8px;
}

.btn-danger:hover {
  background: rgba(239, 68, 68, 0.25);
}

/* ===== Advanced Page ===== */
.info-row {
  display: flex;
  align-items: center;
  padding: 12px 20px;
  gap: 14px;
}

.info-row + .info-row {
  border-top: 1px solid rgba(255, 255, 255, 0.06);
}

.info-label {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.4);
  min-width: 120px;
}

.info-value {
  font-size: 13px;
  color: rgba(255, 255, 255, 0.7);
  font-family: "SF Mono", Menlo, monospace;
  word-break: break-all;
}

/* ===== Toast ===== */
.toast {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%) translateY(100px);
  padding: 12px 24px;
  background: #6366f1;
  color: #ffffff;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 500;
  z-index: 1000;
  transition: transform 0.3s ease;
  pointer-events: none;
}

.toast.visible {
  transform: translateX(-50%) translateY(0);
}

.toast.error {
  background: #ef4444;
}

.toast.warning {
  background: #f59e0b;
  color: #000000;
}

/* ===== Locked Settings ===== */
.setting-row.locked {
  opacity: 0.4;
  pointer-events: none;
  position: relative;
}

.locked-banner {
  padding: 12px 20px;
  background: rgba(239, 68, 68, 0.08);
  border: 1px solid rgba(239, 68, 68, 0.2);
  border-radius: 10px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  font-size: 13px;
  color: rgba(255, 255, 255, 0.6);
}

/* Lock-confirmable: OFF toggle that can be enabled with confirmation */
.setting-row.lock-confirmable {
  position: relative;
}
.setting-row.lock-confirmable::after {
  content: 'üîí';
  position: absolute;
  right: 8px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  opacity: 0.35;
}

/* Lock Confirmation Modal */
.lock-confirm-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0, 0, 0, 0.6);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 10000;
  backdrop-filter: blur(4px);
}
.lock-confirm-box {
  background: #1e1e2e;
  border: 1px solid rgba(255, 255, 255, 0.12);
  border-radius: 16px;
  padding: 28px 32px;
  max-width: 400px;
  width: 90%;
  text-align: center;
}
.lock-confirm-icon {
  font-size: 32px;
  margin-bottom: 12px;
}
.lock-confirm-box h3 {
  margin: 0 0 8px;
  font-size: 17px;
  font-weight: 600;
  color: #fff;
}
.lock-confirm-box p {
  margin: 0 0 8px;
  font-size: 14px;
  color: rgba(255, 255, 255, 0.6);
  line-height: 1.5;
}
.lock-confirm-warning {
  color: rgba(251, 191, 36, 0.8) !important;
  font-size: 13px !important;
  margin-top: 12px !important;
  margin-bottom: 20px !important;
}
.lock-confirm-actions {
  display: flex;
  gap: 10px;
  justify-content: center;
}
.lock-confirm-cancel {
  padding: 8px 20px;
  background: rgba(255, 255, 255, 0.08);
  border: 1px solid rgba(255, 255, 255, 0.15);
  border-radius: 8px;
  color: rgba(255, 255, 255, 0.7);
  font-size: 14px;
  cursor: pointer;
  font-family: inherit;
}
.lock-confirm-cancel:hover {
  background: rgba(255, 255, 255, 0.12);
}
.lock-confirm-enable {
  padding: 8px 20px;
  background: rgba(99, 102, 241, 0.3);
  border: 1px solid rgba(99, 102, 241, 0.5);
  border-radius: 8px;
  color: #fff;
  font-size: 14px;
  cursor: pointer;
  font-family: inherit;
  font-weight: 500;
}
.lock-confirm-enable:hover {
  background: rgba(99, 102, 241, 0.45);
}

/* ===== Scrollbar ===== */
::-webkit-scrollbar { width: 6px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.15); border-radius: 3px; }
</style>
</head>
<body>

<!-- Sidebar -->
<div class="sidebar">
  <div class="sidebar-header">
    <div class="logo-ring">üéØ</div>
    <span class="sidebar-title">Intentional</span>
  </div>
  <div class="sidebar-item active" data-page="usage" onclick="navigateTo('usage')">
    <span class="sidebar-item-icon">üìä</span> Usage
  </div>
  <div class="sidebar-divider"></div>
  <div class="sidebar-label">Platforms</div>
  <div class="sidebar-item" data-page="youtube" onclick="navigateTo('youtube')">
    <span class="sidebar-item-icon">‚ñ∂Ô∏è</span> YouTube
  </div>
  <div class="sidebar-item" data-page="instagram" onclick="navigateTo('instagram')">
    <span class="sidebar-item-icon">üì∑</span> Instagram
  </div>
  <div class="sidebar-item" data-page="facebook" onclick="navigateTo('facebook')">
    <span class="sidebar-item-icon">üë§</span> Facebook
  </div>
  <div class="sidebar-divider"></div>
  <div class="sidebar-item" data-page="lock" onclick="navigateTo('lock')">
    <span class="sidebar-item-icon">üîí</span> Accountability
  </div>
  <div class="sidebar-item" data-page="settings" onclick="navigateTo('settings')">
    <span class="sidebar-item-icon">‚öôÔ∏è</span> Settings
  </div>
</div>

<!-- Main -->
<div class="main">

  <!-- Header -->
  <div class="header">
    <div class="header-right">
      <span class="status-dot"></span>
      <span class="status-text">Monitoring active</span>
    </div>
  </div>

  <!-- Page: Usage -->
  <div class="page active" id="page-usage">
    <div class="section-title">Today</div>
    <div class="usage-grid">
      <div class="usage-card" id="yt-usage-card">
        <div class="usage-card-header">
          <span class="usage-card-icon">‚ñ∂Ô∏è</span>
          <span class="usage-card-platform">YouTube</span>
        </div>
        <div class="usage-session" id="yt-session" style="display: none;">
          <div class="usage-session-dot"></div>
          <span class="usage-session-label" id="yt-session-label">Active</span>
        </div>
        <div class="usage-card-time">
          <span class="usage-minutes youtube" id="yt-minutes">0</span>
          <span class="usage-unit">min</span>
        </div>
        <div class="usage-budget" id="yt-budget">/ 30 min budget</div>
        <div class="usage-bar">
          <div class="usage-bar-fill youtube" id="yt-bar" style="width: 0%"></div>
        </div>
        <div class="usage-session-intent" id="yt-session-intent" style="display: none;"></div>
        <div class="usage-free-browse" id="yt-free-browse">
          Free browse: <span id="yt-fb-minutes">0</span> min used
        </div>
        <div class="usage-bar" id="yt-fb-bar-container" style="display: none;">
          <div class="usage-bar-fill free-browse" id="yt-fb-bar" style="width: 0%"></div>
        </div>
      </div>

      <div class="usage-card" id="ig-usage-card">
        <div class="usage-card-header">
          <span class="usage-card-icon">üì∑</span>
          <span class="usage-card-platform">Instagram</span>
        </div>
        <div class="usage-session" id="ig-session" style="display: none;">
          <div class="usage-session-dot"></div>
          <span class="usage-session-label" id="ig-session-label">Active</span>
        </div>
        <div class="usage-card-time">
          <span class="usage-minutes instagram" id="ig-minutes">0</span>
          <span class="usage-unit">min</span>
        </div>
        <div class="usage-budget" id="ig-budget">/ 30 min budget</div>
        <div class="usage-bar">
          <div class="usage-bar-fill instagram" id="ig-bar" style="width: 0%"></div>
        </div>
        <div class="usage-session-intent" id="ig-session-intent" style="display: none;"></div>
        <div class="usage-free-browse" id="ig-free-browse">
          Free browse: <span id="ig-fb-minutes">0</span> min used
        </div>
        <div class="usage-bar" id="ig-fb-bar-container" style="display: none;">
          <div class="usage-bar-fill free-browse" id="ig-fb-bar" style="width: 0%"></div>
        </div>
      </div>

      <div class="usage-card" id="fb-usage-card">
        <div class="usage-card-header">
          <span class="usage-card-icon">üë§</span>
          <span class="usage-card-platform">Facebook</span>
        </div>
        <div class="usage-session" id="fb-session" style="display: none;">
          <div class="usage-session-dot"></div>
          <span class="usage-session-label" id="fb-session-label">Active</span>
        </div>
        <div class="usage-card-time">
          <span class="usage-minutes facebook" id="fb-minutes">0</span>
          <span class="usage-unit">min</span>
        </div>
        <div class="usage-budget" id="fb-budget">/ 30 min budget</div>
        <div class="usage-bar">
          <div class="usage-bar-fill facebook" id="fb-bar" style="width: 0%"></div>
        </div>
        <div class="usage-session-intent" id="fb-session-intent" style="display: none;"></div>
        <div class="usage-free-browse" id="fb-free-browse">
          Free browse: <span id="fb-fb-minutes">0</span> min used
        </div>
        <div class="usage-bar" id="fb-fb-bar-container" style="display: none;">
          <div class="usage-bar-fill free-browse" id="fb-fb-bar" style="width: 0%"></div>
        </div>
      </div>
    </div>
  </div>

  <!-- Page: YouTube Settings -->
  <div class="page" id="page-youtube">
    <div class="section-title">YouTube Settings</div>

    <div class="settings-card">
      <div class="settings-card-title">General</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable YouTube filtering</div>
          <div class="setting-desc">Filter content based on your stated intent</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="yt-enabled" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Daily budget</div>
          <div class="setting-desc">Maximum minutes per day</div>
        </div>
        <input type="number" class="setting-number" id="yt-budget-input" value="30" min="1" max="480" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Free browse budget</div>
          <div class="setting-desc">Minutes for unfiltered browsing (0 = off)</div>
        </div>
        <input type="number" class="setting-number" id="yt-free-browse-input" value="0" min="0" max="480" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Filtering</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Relevance threshold</div>
          <div class="setting-desc">Higher = stricter filtering</div>
        </div>
        <input type="range" class="setting-range" id="yt-threshold" min="1" max="100" value="35" oninput="document.getElementById('yt-threshold-val').textContent = this.value + '%'; onSettingChange()">
        <span class="setting-value" id="yt-threshold-val">35%</span>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block mode</div>
          <div class="setting-desc">How to handle irrelevant videos</div>
        </div>
        <select class="setting-select" id="yt-block-mode" onchange="onSettingChange()">
          <option value="hide">Hide</option>
          <option value="blur">Blur</option>
        </select>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Content Blocking</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Shorts</div>
          <div class="setting-desc">Remove YouTube Shorts from feed</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="yt-block-shorts" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Hide sponsored content</div>
          <div class="setting-desc">Remove ads and sponsored videos</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="yt-hide-sponsored" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Zen Loading Screen</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Zen duration</div>
          <div class="setting-desc">Calming transition before browsing</div>
        </div>
        <input type="range" class="setting-range" id="yt-zen-duration" min="5" max="20" value="10" oninput="document.getElementById('yt-zen-val').textContent = this.value + 's'; onSettingChange()">
        <span class="setting-value" id="yt-zen-val">10s</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Your Intentions</div>
      <div class="chip-container">
        <div class="chip-list" id="yt-categories-list" data-empty="No intentions added ‚Äî the extension will ask each session"></div>
        <div class="chip-input-row">
          <input type="text" id="yt-category-input" placeholder="e.g. AI, cooking, programming..." />
          <button onclick="addChipItem('yt-categories', 'yt-category-input')">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Page: Instagram Settings -->
  <div class="page" id="page-instagram">
    <div class="section-title">Instagram Settings</div>

    <div class="settings-card">
      <div class="settings-card-title">General</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable Instagram filtering</div>
          <div class="setting-desc">Filter content on Instagram</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-enabled" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Daily budget</div>
          <div class="setting-desc">Maximum minutes per day</div>
        </div>
        <input type="number" class="setting-number" id="ig-budget-input" value="30" min="1" max="480" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Free browse budget</div>
          <div class="setting-desc">Minutes for unfiltered browsing (0 = off)</div>
        </div>
        <input type="number" class="setting-number" id="ig-free-browse-input" value="0" min="0" max="480" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Content Blocking</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Reels</div>
          <div class="setting-desc">Remove video posts from feed and block /reels/</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-block-reels" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Explore page</div>
          <div class="setting-desc">Block access to /explore/</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-block-explore" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">NSFW filter</div>
          <div class="setting-desc">Block adult content using image classification</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-nsfw-filter" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Hide sponsored posts</div>
          <div class="setting-desc">Remove ads from feed</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="ig-hide-ads" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Filtering</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Relevance threshold</div>
          <div class="setting-desc">Higher = stricter filtering</div>
        </div>
        <input type="range" class="setting-range" id="ig-threshold" min="1" max="100" value="35" oninput="document.getElementById('ig-threshold-val').textContent = this.value + '%'; onSettingChange()">
        <span class="setting-value" id="ig-threshold-val">35%</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Content to Avoid</div>
      <div class="chip-container">
        <div class="chip-list" id="ig-blocked-categories-list" data-empty="No categories added"></div>
        <div class="chip-input-row">
          <input type="text" id="ig-blocked-category-input" placeholder="e.g. gossip, fitness, politics..." />
          <button onclick="addChipItem('ig-blocked-categories', 'ig-blocked-category-input')">Add</button>
        </div>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Blocked Accounts</div>
      <div class="chip-container">
        <div class="chip-list" id="ig-blocked-accounts-list" data-empty="No accounts blocked"></div>
        <div class="chip-input-row">
          <input type="text" id="ig-blocked-account-input" placeholder="Instagram username..." />
          <button onclick="addChipItem('ig-blocked-accounts', 'ig-blocked-account-input')">Add</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Page: Facebook Settings -->
  <div class="page" id="page-facebook">
    <div class="section-title">Facebook Settings</div>

    <div class="settings-card">
      <div class="settings-card-title">General</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Enable Facebook filtering</div>
          <div class="setting-desc">Filter content on Facebook</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-enabled" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Daily budget</div>
          <div class="setting-desc">Maximum minutes per day</div>
        </div>
        <input type="number" class="setting-number" id="fb-budget-input" value="30" min="1" max="480" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Free browse budget</div>
          <div class="setting-desc">Minutes for unfiltered browsing (0 = off)</div>
        </div>
        <input type="number" class="setting-number" id="fb-free-browse-input" value="0" min="0" max="480" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Content Blocking</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Watch videos</div>
          <div class="setting-desc">Block access to Facebook Watch</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-watch" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Reels</div>
          <div class="setting-desc">Block Facebook Reels</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-reels" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Marketplace</div>
          <div class="setting-desc">Block Facebook Marketplace</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-marketplace" onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Gaming</div>
          <div class="setting-desc">Block Facebook Gaming section</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-gaming" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block Stories</div>
          <div class="setting-desc">Hide Stories from the top of your feed</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-stories" onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
    </div>

    <div class="settings-card">
      <div class="settings-card-title">Feed Filtering</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block sponsored posts</div>
          <div class="setting-desc">Remove ads and sponsored content from feed</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-sponsored" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Block suggested content</div>
          <div class="setting-desc">Remove "Suggested for you" and "People you may know"</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-block-suggested" checked onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Friends-only mode</div>
          <div class="setting-desc">Only show posts from friends in your feed</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="fb-friends-only" onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Scroll limit</div>
          <div class="setting-desc">Posts before "Time to refocus" wall (0 = off)</div>
        </div>
        <input type="number" class="setting-number" id="fb-scroll-limit" value="50" min="0" max="500" onchange="onSettingChange()">
        <span class="setting-value">posts</span>
      </div>
    </div>
  </div>

  <!-- Page: Accountability / Lock -->
  <div class="page" id="page-lock">
    <div class="section-title">Accountability Partner</div>
    <div class="lock-container" id="lock-content">
      <div class="lock-icon">üîì</div>
      <div class="lock-title">Loading...</div>
    </div>
  </div>

  <!-- Page: Settings (Account + Browsers + Time Limits + Device + Reset & Delete) -->
  <div class="page" id="page-settings">
    <div class="section-title">Settings</div>

    <!-- Account Card -->
    <div class="settings-card">
      <div class="settings-card-title">Account</div>

      <!-- Account: Loading -->
      <div id="account-loading">
        <p style="color: rgba(255,255,255,0.5); text-align: center; padding: 12px 0;">Checking...</p>
      </div>

      <!-- Account: Logged Out -->
      <div id="account-logged-out" style="display: none;">
        <p class="setting-desc" style="margin-bottom: 12px;">
          Sign in to sync settings across devices and recover after reinstall.
        </p>
        <div style="display: flex; flex-direction: column; gap: 12px; padding: 0 20px 8px;">
          <div>
            <div class="setting-label" style="padding: 0 0 4px;">Email</div>
            <input type="email" id="auth-email" class="setting-input" placeholder="you@example.com" style="width: 100%;">
          </div>
          <button class="btn-primary" id="auth-send-btn" onclick="authSendCode()">Send verification code</button>
          <p id="auth-login-error" class="setting-desc" style="color: #ef4444; display: none;"></p>
        </div>
      </div>

      <!-- Account: Code Entry -->
      <div id="account-code-entry" style="display: none;">
        <p class="setting-desc" style="margin-bottom: 12px;">
          We sent a 6-digit code to <strong id="auth-code-email" style="color: #fff;"></strong>
        </p>
        <div style="display: flex; flex-direction: column; gap: 12px; padding: 0 20px 8px;">
          <div>
            <div class="setting-label" style="padding: 0 0 4px;">Code</div>
            <input type="text" id="auth-code" class="setting-input" placeholder="000000" maxlength="6" style="width: 100%; letter-spacing: 4px; font-size: 18px;">
          </div>
          <div style="display: flex; align-items: center; gap: 12px;">
            <button class="btn-primary" id="auth-verify-btn" onclick="authVerifyCode()">Verify</button>
            <a href="#" style="color: rgba(255,255,255,0.5); font-size: 13px; text-decoration: none;" onclick="authBackToEmail(); return false;">‚Üê Back</a>
          </div>
          <p id="auth-verify-error" class="setting-desc" style="color: #ef4444; display: none;"></p>
        </div>
      </div>

      <!-- Account: Signed In -->
      <div id="account-signed-in" style="display: none;">
        <div class="info-row">
          <span class="info-label">Email</span>
          <span class="info-value" id="account-email">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Member since</span>
          <span class="info-value" id="account-since">-</span>
        </div>
        <div class="info-row">
          <span class="info-label">Devices</span>
          <span class="info-value" id="account-devices">-</span>
        </div>
        <div style="padding: 12px 20px 8px;">
          <button class="btn-secondary" onclick="authSignOut()">Sign out</button>
        </div>
      </div>
    </div>

    <!-- Browsers Card -->
    <div class="settings-card" style="padding: 0; overflow: hidden;">
      <div class="settings-card-title" style="padding: 16px 20px 12px;">Browsers</div>
      <div class="browser-card" id="browser-card" style="border: none; border-radius: 0;">
        <div class="empty-state" id="browser-empty" style="padding: 20px;">
          <div class="empty-state-text" style="font-size: 13px;">Loading browser status...</div>
        </div>
      </div>
    </div>

    <!-- Time Limits Card -->
    <div class="settings-card">
      <div class="settings-card-title">Time Limits</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Per-period limit</div>
          <div class="setting-desc">Max time within a rolling period</div>
        </div>
        <label class="toggle">
          <input type="checkbox" id="adv-period-enabled" onchange="onSettingChange()">
          <span class="toggle-track"></span>
        </label>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Period minutes</div>
          <div class="setting-desc">Max minutes per period</div>
        </div>
        <input type="number" class="setting-number" id="adv-period-minutes" value="20" min="1" max="120" onchange="onSettingChange()">
        <span class="setting-value">min</span>
      </div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Period length</div>
          <div class="setting-desc">Rolling period in hours</div>
        </div>
        <input type="number" class="setting-number" id="adv-period-hours" value="1" min="1" max="24" onchange="onSettingChange()">
        <span class="setting-value">hr</span>
      </div>
    </div>

    <!-- Device Card -->
    <div class="settings-card">
      <div class="settings-card-title">Device</div>
      <div class="info-row">
        <span class="info-label">Device ID</span>
        <span class="info-value" id="adv-device-id">-</span>
      </div>
      <div class="info-row">
        <span class="info-label">Backend</span>
        <span class="info-value">api.intentional.social</span>
      </div>
      <div class="info-row">
        <span class="info-label">Version</span>
        <span class="info-value">1.0</span>
      </div>
    </div>

    <!-- Reset & Delete Card -->
    <div class="settings-card">
      <div class="settings-card-title">Reset & Delete</div>
      <div class="setting-row">
        <div>
          <div class="setting-label">Reset all settings</div>
          <div class="setting-desc">Clear settings and return to onboarding</div>
        </div>
        <button class="btn-danger" onclick="confirmReset()">Reset</button>
      </div>
      <div class="setting-row" id="delete-account-row" style="display: none;">
        <div>
          <div class="setting-label">Delete account</div>
          <div class="setting-desc">Permanently removes your account. Confirmation email required.</div>
        </div>
        <button class="btn-danger" id="auth-delete-btn" onclick="authDeleteAccount()">Delete</button>
      </div>
      <p id="auth-delete-msg" class="setting-desc" style="display: none; padding: 0 20px 12px;"></p>
    </div>
  </div>

</div>

<!-- Toast -->
<div class="toast" id="toast"></div>

<script>
// ===== Bridge =====
function sendMessage(payload) {
  if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.intentional) {
    window.webkit.messageHandlers.intentional.postMessage(payload);
  }
}

// ===== Settings State =====
var settings = {
  lockMode: 'none',
  partnerEmail: '',
  partnerName: '',
  consentStatus: 'none',
  maxPerPeriod: { enabled: false, minutes: 20, periodHours: 1 },
  temporaryUnlockUntil: null,
  selfUnlockAvailableAt: null,
  unlockRequested: false,
  youtube: {},
  instagram: {},
  facebook: {},
  deviceId: ''
};

var settingSaveTimer = null;

// ===== Toast =====
var toastTimer = null;
function showToast(msg, type) {
  var el = document.getElementById('toast');
  el.textContent = msg;
  el.className = 'toast visible' + (type ? ' ' + type : '');
  clearTimeout(toastTimer);
  toastTimer = setTimeout(function() {
    el.className = 'toast';
  }, type === 'error' ? 4000 : 3000);
}

// ===== Navigation =====
function navigateTo(pageId) {
  document.querySelectorAll('.page').forEach(function(p) { p.classList.remove('active'); });
  document.querySelectorAll('.sidebar-item').forEach(function(s) { s.classList.remove('active'); });
  var page = document.getElementById('page-' + pageId);
  if (page) page.classList.add('active');
  var nav = document.querySelector('[data-page="' + pageId + '"]');
  if (nav) nav.classList.add('active');

  // Poll consent status when viewing accountability page with pending consent
  if (pageId === 'lock' && settings.consentStatus === 'pending') {
    sendMessage({ type: 'GET_PARTNER_STATUS' });
    startConsentPolling();
  } else {
    stopConsentPolling();
  }

  // Load account + browser status when viewing settings page
  if (pageId === 'settings') {
    loadAccountPage();
    sendMessage({ type: 'GET_EXTENSION_STATUS' });
  }
}

// ===== Refresh Data =====
function refresh() {
  sendMessage({ type: 'GET_DASHBOARD_DATA' });
  sendMessage({ type: 'GET_EXTENSION_STATUS' });
}

// ===== HTML Escape =====
function escapeHtml(str) {
  if (!str) return '';
  return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}

// ===== Button Loading States =====
function setButtonLoading(btnId, loadingText) {
  var btn = document.getElementById(btnId);
  if (!btn) return;
  btn._originalText = btn.textContent;
  btn.textContent = loadingText || 'Loading...';
  btn.disabled = true;
  btn.style.opacity = '0.6';
}

function clearButtonLoading(btnId) {
  var btn = document.getElementById(btnId);
  if (!btn) return;
  btn.textContent = btn._originalText || btn.textContent;
  btn.disabled = false;
  btn.style.opacity = '';
}

// ===== Chip/Tag Management =====
function renderChips(listId, items) {
  var list = document.getElementById(listId + '-list');
  if (!list) return;
  list.innerHTML = '';
  (items || []).forEach(function(item) {
    var chip = document.createElement('span');
    chip.className = 'chip';
    chip.innerHTML = item + ' <span class="chip-remove" onclick="removeChipItem(\'' + listId + '\', \'' + item.replace(/'/g, "\\'") + '\')">&times;</span>';
    list.appendChild(chip);
  });
}

function getChipItems(listId) {
  var list = document.getElementById(listId + '-list');
  if (!list) return [];
  var chips = list.querySelectorAll('.chip');
  var items = [];
  chips.forEach(function(chip) {
    // Get text content minus the √ó button
    var text = chip.childNodes[0].textContent.trim();
    if (text) items.push(text);
  });
  return items;
}

function addChipItem(listId, inputId) {
  var input = document.getElementById(inputId);
  if (!input) return;
  var value = input.value.trim().toLowerCase();
  if (!value) return;
  var items = getChipItems(listId);
  if (items.indexOf(value) === -1) {
    items.push(value);
    renderChips(listId, items);
    onSettingChange();
  }
  input.value = '';
  input.focus();
}

function removeChipItem(listId, value) {
  var items = getChipItems(listId);
  items = items.filter(function(i) { return i !== value; });
  renderChips(listId, items);
  onSettingChange();
}

// Wire Enter key for chip inputs
document.addEventListener('DOMContentLoaded', function() {
  ['yt-category-input', 'ig-blocked-category-input', 'ig-blocked-account-input'].forEach(function(id) {
    var el = document.getElementById(id);
    if (el) {
      el.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          e.preventDefault();
          var listId = id.replace('-input', '').replace('-category', '-categories').replace('-account', '-accounts');
          // Map input ID to list ID
          if (id === 'yt-category-input') listId = 'yt-categories';
          else if (id === 'ig-blocked-category-input') listId = 'ig-blocked-categories';
          else if (id === 'ig-blocked-account-input') listId = 'ig-blocked-accounts';
          addChipItem(listId, id);
        }
      });
    }
  });

  // Set up lock interceptors on toggle checkboxes
  setupLockInterceptors();
});

// ===== Setting Change Handler (debounced save) =====
var _lockInterceptActive = false; // Set by lock interceptor to suppress normal save

function onSettingChange() {
  if (_lockInterceptActive) return; // Lock interceptor is handling this change
  clearTimeout(settingSaveTimer);
  settingSaveTimer = setTimeout(saveAllSettings, 800);
}

function saveAllSettings() {
  var ytSettings = {
    enabled: document.getElementById('yt-enabled').checked,
    budget: parseInt(document.getElementById('yt-budget-input').value) || 30,
    threshold: parseInt(document.getElementById('yt-threshold').value) || 35,
    blockShorts: document.getElementById('yt-block-shorts').checked,
    hideSponsored: document.getElementById('yt-hide-sponsored').checked,
    blockMode: document.getElementById('yt-block-mode').value,
    zenDuration: parseInt(document.getElementById('yt-zen-duration').value) || 10,
    categories: getChipItems('yt-categories')
  };

  var igSettings = {
    enabled: document.getElementById('ig-enabled').checked,
    budget: parseInt(document.getElementById('ig-budget-input').value) || 30,
    threshold: parseInt(document.getElementById('ig-threshold').value) || 35,
    blockReels: document.getElementById('ig-block-reels').checked,
    blockExplore: document.getElementById('ig-block-explore').checked,
    nsfwFilter: document.getElementById('ig-nsfw-filter').checked,
    hideAds: document.getElementById('ig-hide-ads').checked,
    blockedCategories: getChipItems('ig-blocked-categories'),
    blockedAccounts: getChipItems('ig-blocked-accounts')
  };

  var fbSettings = {
    enabled: document.getElementById('fb-enabled').checked,
    budget: parseInt(document.getElementById('fb-budget-input').value) || 30,
    blockWatch: document.getElementById('fb-block-watch').checked,
    blockReels: document.getElementById('fb-block-reels').checked,
    blockMarketplace: document.getElementById('fb-block-marketplace').checked,
    blockGaming: document.getElementById('fb-block-gaming').checked,
    blockStories: document.getElementById('fb-block-stories').checked,
    blockSponsored: document.getElementById('fb-block-sponsored').checked,
    blockSuggested: document.getElementById('fb-block-suggested').checked,
    scrollLimit: parseInt(document.getElementById('fb-scroll-limit').value) || 0,
    friendsOnly: document.getElementById('fb-friends-only').checked
  };

  var maxPerPeriod = {
    enabled: document.getElementById('adv-period-enabled').checked,
    minutes: parseInt(document.getElementById('adv-period-minutes').value) || 20,
    periodHours: parseInt(document.getElementById('adv-period-hours').value) || 1
  };

  var freeBrowseBudgets = {
    youtube: parseInt(document.getElementById('yt-free-browse-input').value) || 0,
    instagram: parseInt(document.getElementById('ig-free-browse-input').value) || 0,
    facebook: parseInt(document.getElementById('fb-free-browse-input').value) || 0
  };

  sendMessage({
    type: 'SAVE_SETTINGS',
    settings: {
      youtube: ytSettings,
      instagram: igSettings,
      facebook: fbSettings,
      lockMode: settings.lockMode,
      partnerEmail: settings.partnerEmail,
      partnerName: settings.partnerName,
      maxPerPeriod: maxPerPeriod,
      freeBrowseBudgets: freeBrowseBudgets
    }
  });
}

// Populate settings UI from loaded data
function populateSettingsUI(data) {
  if (data.youtube) {
    var yt = data.youtube;
    document.getElementById('yt-enabled').checked = yt.enabled !== false;
    document.getElementById('yt-budget-input').value = yt.budget || 30;
    document.getElementById('yt-threshold').value = yt.threshold || 35;
    document.getElementById('yt-threshold-val').textContent = (yt.threshold || 35) + '%';
    document.getElementById('yt-block-shorts').checked = yt.blockShorts !== false;
    document.getElementById('yt-hide-sponsored').checked = yt.hideSponsored !== false;
    document.getElementById('yt-block-mode').value = yt.blockMode || 'hide';
    document.getElementById('yt-zen-duration').value = yt.zenDuration || 10;
    document.getElementById('yt-zen-val').textContent = (yt.zenDuration || 10) + 's';
    renderChips('yt-categories', yt.categories || []);
  }

  if (data.instagram) {
    var ig = data.instagram;
    document.getElementById('ig-enabled').checked = ig.enabled !== false;
    document.getElementById('ig-budget-input').value = ig.budget || 30;
    document.getElementById('ig-threshold').value = ig.threshold || 35;
    document.getElementById('ig-threshold-val').textContent = (ig.threshold || 35) + '%';
    document.getElementById('ig-block-reels').checked = ig.blockReels !== false;
    document.getElementById('ig-block-explore').checked = ig.blockExplore !== false;
    document.getElementById('ig-nsfw-filter').checked = ig.nsfwFilter !== false;
    document.getElementById('ig-hide-ads').checked = ig.hideAds !== false;
    renderChips('ig-blocked-categories', ig.blockedCategories || []);
    renderChips('ig-blocked-accounts', ig.blockedAccounts || []);
  }

  if (data.facebook) {
    var fb = data.facebook;
    document.getElementById('fb-enabled').checked = fb.enabled !== false;
    document.getElementById('fb-budget-input').value = fb.budget || 30;
    document.getElementById('fb-block-watch').checked = fb.blockWatch !== false;
    document.getElementById('fb-block-reels').checked = fb.blockReels !== false;
    document.getElementById('fb-block-marketplace').checked = fb.blockMarketplace === true;
    document.getElementById('fb-block-gaming').checked = fb.blockGaming !== false;
    document.getElementById('fb-block-stories').checked = fb.blockStories === true;
    document.getElementById('fb-block-sponsored').checked = fb.blockSponsored !== false;
    document.getElementById('fb-block-suggested').checked = fb.blockSuggested !== false;
    document.getElementById('fb-scroll-limit').value = fb.scrollLimit !== undefined ? fb.scrollLimit : 50;
    document.getElementById('fb-friends-only').checked = fb.friendsOnly === true;
  }

  if (data.maxPerPeriod) {
    var mpp = data.maxPerPeriod;
    document.getElementById('adv-period-enabled').checked = mpp.enabled === true;
    document.getElementById('adv-period-minutes').value = mpp.minutes || 20;
    document.getElementById('adv-period-hours').value = mpp.periodHours || 1;
  }

  if (data.freeBrowseBudgets) {
    var fb = data.freeBrowseBudgets;
    document.getElementById('yt-free-browse-input').value = fb.youtube || 0;
    document.getElementById('ig-free-browse-input').value = fb.instagram || 0;
    document.getElementById('fb-free-browse-input').value = fb.facebook || 0;
  }

  if (data.deviceId) {
    document.getElementById('adv-device-id').textContent = data.deviceId;
  }
}

// ===== Lock State Machine =====
function getLockState() {
  var mode = settings.lockMode || 'none';
  var consent = settings.consentStatus || 'none';
  var hasPartner = settings.partnerEmail && settings.partnerEmail !== '';

  // Check unlock state (permanent or temporary)
  if (settings.settingsUnlocked) return 'unlocked';
  if (settings.temporaryUnlockUntil) {
    var unlockEnd = new Date(settings.temporaryUnlockUntil).getTime();
    if (unlockEnd > Date.now()) {
      // Far-future sentinel (year 9000+) = permanently unlocked
      if (new Date(settings.temporaryUnlockUntil).getFullYear() >= 9000) return 'unlocked';
      return 'temporarily_unlocked';
    }
  }

  // Check self-lock countdown
  if (mode === 'self' && settings.selfUnlockAvailableAt) {
    var availAt = new Date(settings.selfUnlockAvailableAt).getTime();
    if (availAt > Date.now()) return 'self_countdown';
  }

  // Check if we're waiting for unlock code entry
  if (mode !== 'none' && settings.unlockRequested) return 'unlock_code_entry';

  // Consent states take priority over "locked" ‚Äî if partner hasn't confirmed yet,
  // showing "locked" is wrong. Only show locked when consent is confirmed (or for self mode).
  if (hasPartner && consent === 'pending') return 'pending';
  if (hasPartner && consent === 'declined') return 'declined';
  if (hasPartner && consent === 'expired') return 'expired';

  // Now check actual lock state
  if (mode !== 'none') return 'locked';

  // Partner confirmed but no lock mode chosen yet
  if (hasPartner && consent === 'confirmed') return 'confirmed';

  return 'setup';
}

var selectedLockMode = 'none';

function selectLockMode(mode) {
  selectedLockMode = mode;
  document.querySelectorAll('.lock-mode-option').forEach(function(opt) {
    opt.classList.toggle('selected', opt.getAttribute('data-mode') === mode);
  });
  var partnerCard = document.getElementById('partner-fields-card');
  if (partnerCard) {
    partnerCard.style.display = (mode === 'none') ? 'none' : '';
  }
}

var countdownInterval = null;

function renderLockState() {
  var el = document.getElementById('lock-content');
  var state = getLockState();
  var email = escapeHtml(settings.partnerEmail || '');
  var name = escapeHtml(settings.partnerName || '');
  var partnerDisplay = name ? name + ' (' + email + ')' : email;

  // Clear any running countdown
  if (countdownInterval) {
    clearInterval(countdownInterval);
    countdownInterval = null;
  }

  switch (state) {
    case 'pending':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Invitation</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge pending">Pending</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Sent to</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">Your partner needs to click the confirmation link in their email before lock mode can be activated.</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="resend-invite-btn" onclick="resendInvite()">Resend Invitation</button>' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
        '</div>';
      startConsentPolling();
      break;

    case 'confirmed':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Status</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge confirmed">Confirmed</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">Your partner is ready. Choose how to lock your settings:</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="enable-partner-btn" onclick="enableLockMode(\'partner\')">Enable Partner Lock</button>' +
          '<button class="btn-secondary" id="enable-self-btn" onclick="enableLockMode(\'self\')">Enable 24-Hour Delay</button>' +
        '</div>' +
        '<div class="lock-btn-row" style="margin-top:8px;">' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
          '<button class="btn-danger" id="remove-partner-btn" onclick="removePartner()">Remove Partner</button>' +
        '</div>';
      stopConsentPolling();
      break;

    case 'locked':
      var mode = settings.lockMode || 'partner';
      var modeLabel = mode === 'partner' ? 'Partner Lock' : '24-Hour Delay';
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Lock Status</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge locked">Locked</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Mode</div>' +
            '<span class="setting-value">' + modeLabel + '</span>' +
          '</div>' +
          (partnerDisplay ?
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' : '') +
        '</div>' +
        '<div class="settings-card">' +
          '<div class="settings-card-title">Protected Settings</div>' +
          '<div class="setting-row"><div class="setting-label">Platform toggles (YouTube, Instagram, Facebook)</div></div>' +
          '<div class="setting-row"><div class="setting-label">Relevance thresholds</div></div>' +
          '<div class="setting-row"><div class="setting-label">Content blocking (Shorts, Reels, Watch)</div></div>' +
          '<div class="setting-row"><div class="setting-label">Blocked categories</div></div>' +
          '<div class="setting-row"><div class="setting-label">Free browse budgets</div></div>' +
        '</div>' +
        '<button class="btn-primary" id="request-unlock-btn" onclick="requestUnlock()" style="width:100%;margin-top:16px;">Request Unlock Code</button>';
      stopConsentPolling();
      break;

    case 'unlock_code_entry':
      var codeMode = settings.lockMode || 'partner';
      var codeMsg = codeMode === 'partner'
        ? 'A 6-digit code has been sent to your partner. Enter it below to temporarily unlock settings.'
        : 'Enter the 6-digit code you received to temporarily unlock settings.';
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Enter Unlock Code</div>' +
          '<div style="padding:24px 20px;text-align:center;">' +
            '<div class="lock-helper-text" style="padding:0;margin-bottom:20px;">' + codeMsg + '</div>' +
            '<input type="text" class="unlock-code-input" id="unlock-code" maxlength="6" placeholder="000000" oninput="onCodeInput(this)">' +
          '</div>' +
        '</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="verify-code-btn" onclick="verifyUnlockCode()" disabled>Verify Code</button>' +
          '<button class="btn-secondary" onclick="cancelUnlock()">Cancel</button>' +
        '</div>';
      setTimeout(function() {
        var inp = document.getElementById('unlock-code');
        if (inp) inp.focus();
      }, 100);
      stopConsentPolling();
      break;

    case 'self_countdown':
      var availAt = new Date(settings.selfUnlockAvailableAt).getTime();
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Unlock Request</div>' +
          '<div style="text-align:center;padding:24px 20px;">' +
            '<div style="font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:8px;">Time remaining</div>' +
            '<div class="countdown-display" id="countdown-timer" style="margin:12px 0;">--:--:--</div>' +
            '<div class="unlock-timer-bar"><div class="unlock-timer-fill" id="countdown-bar" style="width:100%;background:#f59e0b;"></div></div>' +
            '<div class="lock-helper-text" style="padding:0;margin-top:12px;">The unlock code will be sent to your email when the countdown reaches zero.</div>' +
          '</div>' +
        '</div>' +
        '<button class="btn-secondary" onclick="cancelUnlock()" style="width:100%;margin-top:16px;">Cancel Request</button>';
      updateCountdown(availAt);
      countdownInterval = setInterval(function() {
        updateCountdown(availAt);
      }, 1000);
      stopConsentPolling();
      break;

    case 'unlocked':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Lock Status</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge unlocked">Unlocked</span>' +
          '</div>' +
          (partnerDisplay ?
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' : '') +
        '</div>' +
        '<div class="lock-helper-text">Settings are unlocked. Make your changes, then re-lock when done.</div>' +
        '<button class="btn-primary" onclick="relockSettings()" style="width:100%;">Re-lock Settings</button>' +
        '<div class="lock-btn-row" style="margin-top:8px;">' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
          '<button class="btn-danger" id="remove-partner-btn" onclick="removePartner()">Remove Partner</button>' +
        '</div>';
      stopConsentPolling();
      break;

    case 'temporarily_unlocked':
      var unlockEnd = new Date(settings.temporaryUnlockUntil).getTime();
      var totalMs = 5 * 60 * 1000;
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Temporary Unlock</div>' +
          '<div style="text-align:center;padding:24px 20px;">' +
            '<div style="font-size:14px;color:rgba(255,255,255,0.5);margin-bottom:8px;">Time remaining</div>' +
            '<div class="countdown-display" id="unlock-countdown" style="color:#34d399;margin:12px 0;">--:--</div>' +
            '<div class="unlock-timer-bar"><div class="unlock-timer-fill" id="unlock-bar"></div></div>' +
            '<div class="lock-helper-text" style="padding:0;margin-top:12px;">Make your changes now. Lock re-engages when timer expires.</div>' +
          '</div>' +
        '</div>';
      updateUnlockCountdown(unlockEnd, totalMs);
      countdownInterval = setInterval(function() {
        updateUnlockCountdown(unlockEnd, totalMs);
      }, 1000);
      stopConsentPolling();
      break;

    case 'declined':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Invitation</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge declined">Declined</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Partner</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">' + (name || email) + ' declined the accountability request. You can try a different partner.</div>' +
        '<div class="settings-card">' +
          '<div class="settings-card-title">New Partner</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Name</div>' +
            '<input class="setting-input" id="lock-partner-name" placeholder="Optional">' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Email</div>' +
            '<input class="setting-input" id="lock-partner-email" placeholder="partner@email.com" type="email">' +
          '</div>' +
        '</div>' +
        '<button class="btn-primary" id="save-lock-btn" onclick="saveLockSettings()" style="width:100%;margin-top:16px;">Save Lock Settings</button>';
      stopConsentPolling();
      break;

    case 'expired':
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Partner Invitation</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Status</div>' +
            '<span class="status-badge expired">Expired</span>' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label">Sent to</div>' +
            '<span class="setting-value">' + partnerDisplay + '</span>' +
          '</div>' +
        '</div>' +
        '<div class="lock-helper-text">The invitation expired after 7 days without a response.</div>' +
        '<div class="lock-btn-row">' +
          '<button class="btn-primary" id="resend-invite-btn" onclick="resendInvite()">Resend Invitation</button>' +
          '<button class="btn-secondary" onclick="changePartner()">Change Partner</button>' +
        '</div>';
      stopConsentPolling();
      break;

    default: // 'setup'
      var noneSelected = selectedLockMode === 'none' || !selectedLockMode ? ' selected' : '';
      var partnerSelected = selectedLockMode === 'partner' ? ' selected' : '';
      var selfSelected = selectedLockMode === 'self' ? ' selected' : '';
      var showPartner = (selectedLockMode && selectedLockMode !== 'none') ? '' : ' style="display:none"';
      el.innerHTML =
        '<div class="settings-card">' +
          '<div class="settings-card-title">Lock Mode</div>' +
          '<div class="lock-mode-option' + noneSelected + '" data-mode="none" onclick="selectLockMode(\'none\')">' +
            '<div class="lock-mode-radio"></div>' +
            '<div>' +
              '<div class="setting-label">Unlocked</div>' +
              '<div class="setting-desc">Anyone can change settings freely</div>' +
            '</div>' +
          '</div>' +
          '<div class="lock-mode-option' + partnerSelected + '" data-mode="partner" onclick="selectLockMode(\'partner\')">' +
            '<div class="lock-mode-radio"></div>' +
            '<div>' +
              '<div class="setting-label">Partner Lock</div>' +
              '<div class="setting-desc">Partner receives unlock codes via email</div>' +
            '</div>' +
          '</div>' +
          '<div class="lock-mode-option' + selfSelected + '" data-mode="self" onclick="selectLockMode(\'self\')">' +
            '<div class="lock-mode-radio"></div>' +
            '<div>' +
              '<div class="setting-label">24-Hour Delay</div>' +
              '<div class="setting-desc">24-hour cooling period before settings can change</div>' +
            '</div>' +
          '</div>' +
        '</div>' +
        '<div class="settings-card" id="partner-fields-card"' + showPartner + '>' +
          '<div class="settings-card-title">Accountability Partner</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Name</div>' +
            '<input class="setting-input" id="lock-partner-name" placeholder="Optional" value="' + name + '">' +
          '</div>' +
          '<div class="setting-row">' +
            '<div class="setting-label" style="min-width:50px;">Email</div>' +
            '<input class="setting-input" id="lock-partner-email" placeholder="partner@email.com" type="email" value="' + email + '">' +
          '</div>' +
        '</div>' +
        '<button class="btn-primary" id="save-lock-btn" onclick="saveLockSettings()" style="width:100%;margin-top:16px;">Save Lock Settings</button>';
      stopConsentPolling();
  }

  // Enforce lock on platform settings pages
  enforceLockMode();
}

// ===== Lock Enforcement on Settings Pages =====
var LOCKED_INPUT_IDS = [
  'yt-enabled', 'ig-enabled', 'fb-enabled',
  'yt-threshold', 'ig-threshold',
  'yt-block-shorts', 'ig-block-reels',
  'fb-block-watch', 'fb-block-reels', 'fb-block-marketplace',
  'fb-block-gaming', 'fb-block-stories',
  'fb-block-sponsored', 'fb-block-suggested', 'fb-friends-only',
  'yt-free-browse-input', 'ig-free-browse-input', 'fb-free-browse-input'
];

// Descriptions for the lock confirmation modal
var LOCK_CONFIRM_INFO = {
  'yt-enabled': { name: 'YouTube filtering', desc: 'YouTube videos will be filtered based on your stated intent.' },
  'ig-enabled': { name: 'Instagram filtering', desc: 'Instagram content will be filtered based on your settings.' },
  'fb-enabled': { name: 'Facebook filtering', desc: 'Facebook content will be filtered based on your settings.' },
  'yt-block-shorts': { name: 'Block YouTube Shorts', desc: 'YouTube Shorts will be completely removed from your feed.' },
  'ig-block-reels': { name: 'Block Instagram Reels', desc: 'Video posts and Reels will be removed from Instagram.' },
  'fb-block-watch': { name: 'Block Facebook Watch', desc: 'The Facebook Watch video section will be blocked.' },
  'fb-block-reels': { name: 'Block Facebook Reels', desc: 'Facebook Reels will be blocked.' },
  'fb-block-marketplace': { name: 'Block Marketplace', desc: 'Facebook Marketplace will be blocked.' },
  'fb-block-gaming': { name: 'Block Gaming', desc: 'The Facebook Gaming section will be blocked.' },
  'fb-block-stories': { name: 'Block Stories', desc: 'Facebook Stories will be hidden from the top of your feed.' },
  'fb-block-sponsored': { name: 'Block sponsored posts', desc: 'Sponsored posts and ads will be removed from your Facebook feed.' },
  'fb-block-suggested': { name: 'Block suggested content', desc: '"Suggested for you" and "People you may know" content will be removed.' },
  'fb-friends-only': { name: 'Friends-only mode', desc: 'Only posts from friends will appear in your feed.' }
};

function isSettingsLocked() {
  var state = getLockState();
  return state === 'locked' || state === 'unlock_code_entry' || state === 'self_countdown';
}

function enforceLockMode() {
  var locked = isSettingsLocked();

  LOCKED_INPUT_IDS.forEach(function(id) {
    var input = document.getElementById(id);
    if (!input) return;
    var row = input.closest('.setting-row');
    if (!row) return;

    if (locked) {
      // Checkbox toggles: OFF ones are confirmable, ON ones are fully locked
      if (input.type === 'checkbox' && !input.checked && LOCK_CONFIRM_INFO[id]) {
        row.classList.remove('locked');
        row.classList.add('lock-confirmable');
      } else {
        row.classList.add('locked');
        row.classList.remove('lock-confirmable');
      }
    } else {
      row.classList.remove('locked');
      row.classList.remove('lock-confirmable');
    }
  });

  // Add/remove locked banners on platform pages
  ['page-youtube', 'page-instagram', 'page-facebook'].forEach(function(pageId) {
    var page = document.getElementById(pageId);
    if (!page) return;
    var existingBanner = page.querySelector('.locked-banner');
    if (locked) {
      if (!existingBanner) {
        var banner = document.createElement('div');
        banner.className = 'locked-banner';
        banner.innerHTML = '<span>üîí</span> Settings are locked by your accountability partner. <a href="#" onclick="navigateTo(\'lock\'); return false;" style="color:#6366f1; text-decoration:underline;">Request unlock</a>';
        var firstCard = page.querySelector('.settings-card');
        if (firstCard) page.insertBefore(banner, firstCard);
      }
    } else {
      if (existingBanner) existingBanner.remove();
    }
  });
}

// ===== Lock Confirmation Modal =====
var _lockConfirmCallback = null;
var _lockInterceptorsSetup = false;

function showLockConfirm(inputId, callback) {
  var info = LOCK_CONFIRM_INFO[inputId];
  if (!info) { callback(false); return; }
  document.getElementById('lock-confirm-title').textContent = 'Enable ' + info.name + '?';
  document.getElementById('lock-confirm-desc').textContent = info.desc;
  document.getElementById('lock-confirm-modal').style.display = 'flex';
  _lockConfirmCallback = callback;
}

function closeLockConfirm(confirmed) {
  document.getElementById('lock-confirm-modal').style.display = 'none';
  if (_lockConfirmCallback) {
    _lockConfirmCallback(confirmed);
    _lockConfirmCallback = null;
  }
}

function setupLockInterceptors() {
  if (_lockInterceptorsSetup) return;
  _lockInterceptorsSetup = true;

  LOCKED_INPUT_IDS.forEach(function(id) {
    var input = document.getElementById(id);
    if (!input || input.type !== 'checkbox') return;

    input.addEventListener('change', function() {
      if (!isSettingsLocked()) return; // Not locked ‚Äî let onSettingChange() handle it normally

      // Suppress the inline onchange from triggering a save
      _lockInterceptActive = true;
      setTimeout(function() { _lockInterceptActive = false; }, 50);

      if (input.checked) {
        // Trying to turn ON while locked ‚Äî revert and show confirmation
        input.checked = false;
        showLockConfirm(id, function(confirmed) {
          if (confirmed) {
            input.checked = true;
            // Now it's ON while locked ‚Äî apply full lock
            var row = input.closest('.setting-row');
            if (row) {
              row.classList.add('locked');
              row.classList.remove('lock-confirmable');
            }
            _lockInterceptActive = false;
            onSettingChange(); // Trigger save now
          }
        });
      } else {
        // Trying to turn OFF while locked ‚Äî block it
        input.checked = true;
      }
    }, true); // Capture phase ‚Äî fires before the inline onchange
  });
}

// ===== Countdown Helpers =====
function updateCountdown(targetMs) {
  var el = document.getElementById('countdown-timer');
  if (!el) return;
  var diff = targetMs - Date.now();
  if (diff <= 0) {
    el.textContent = '00:00:00';
    // Countdown done - refresh state
    settings.selfUnlockAvailableAt = null;
    settings.unlockRequested = true;
    renderLockState();
    return;
  }
  var hours = Math.floor(diff / 3600000);
  var mins = Math.floor((diff % 3600000) / 60000);
  var secs = Math.floor((diff % 60000) / 1000);
  el.textContent = pad(hours) + ':' + pad(mins) + ':' + pad(secs);
  // Update progress bar
  var bar = document.getElementById('countdown-bar');
  if (bar) {
    var totalMs = 24 * 3600000;
    bar.style.width = Math.max(0, (diff / totalMs) * 100) + '%';
  }
}

function updateUnlockCountdown(endMs, totalMs) {
  var countdownEl = document.getElementById('unlock-countdown');
  var barEl = document.getElementById('unlock-bar');
  if (!countdownEl) return;
  var diff = endMs - Date.now();
  if (diff <= 0) {
    countdownEl.textContent = '0:00';
    if (barEl) barEl.style.width = '0%';
    // Unlock window expired - go back to locked
    settings.temporaryUnlockUntil = null;
    renderLockState();
    return;
  }
  var mins = Math.floor(diff / 60000);
  var secs = Math.floor((diff % 60000) / 1000);
  countdownEl.textContent = mins + ':' + pad(secs);
  if (barEl) barEl.style.width = ((diff / totalMs) * 100) + '%';
}

function pad(n) { return n < 10 ? '0' + n : '' + n; }

// ===== Unlock Code Input =====
function onCodeInput(el) {
  el.value = el.value.replace(/[^0-9]/g, '');
  var btn = document.getElementById('verify-code-btn');
  if (btn) btn.disabled = el.value.length < 6;
}

function verifyUnlockCode() {
  var code = (document.getElementById('unlock-code') || {}).value || '';
  if (code.length < 6) return;
  setButtonLoading('verify-code-btn', 'Verifying...');
  sendMessage({ type: 'VERIFY_UNLOCK', code: code });
}

function cancelUnlock() {
  settings.unlockRequested = false;
  settings.selfUnlockAvailableAt = null;
  renderLockState();
}

function relockSettings() {
  settings.settingsUnlocked = false;
  settings.temporaryUnlockUntil = null;
  settings.unlockRequested = false;
  settings.selfUnlockAvailableAt = null;
  sendMessage({ type: 'RELOCK_SETTINGS' });
  showToast('Settings re-locked');
  renderLockState();
}

// ===== Lock Actions =====
function saveLockSettings() {
  var email = (document.getElementById('lock-partner-email') || {}).value || '';
  var name = (document.getElementById('lock-partner-name') || {}).value || '';

  if (selectedLockMode !== 'none' && !email) {
    showToast('Partner email is required for lock mode', 'error');
    return;
  }

  setButtonLoading('save-lock-btn', 'Saving...');
  settings.partnerEmail = email;
  settings.partnerName = name;

  sendMessage({
    type: 'SAVE_LOCK_SETTINGS',
    lockMode: selectedLockMode,
    partnerEmail: email,
    partnerName: name
  });
}

function enableLockMode(mode) {
  var btnId = mode === 'partner' ? 'enable-partner-btn' : 'enable-self-btn';
  setButtonLoading(btnId, 'Enabling...');
  sendMessage({
    type: 'SAVE_LOCK_SETTINGS',
    lockMode: mode,
    partnerEmail: settings.partnerEmail,
    partnerName: settings.partnerName
  });
}

function removePartner() {
  if (!confirm('Remove your accountability partner? This will also disable the lock.')) return;
  setButtonLoading('remove-partner-btn', 'Removing...');
  sendMessage({ type: 'REMOVE_PARTNER' });
}

function resendInvite() {
  setButtonLoading('resend-invite-btn', 'Sending...');
  sendMessage({ type: 'RESEND_PARTNER_INVITE' });
}

function changePartner() {
  settings.partnerEmail = '';
  settings.partnerName = '';
  settings.consentStatus = 'none';
  // Persist the clear to Swift so it survives app restart
  sendMessage({
    type: 'SAVE_LOCK_SETTINGS',
    lockMode: settings.lockMode || 'none',
    partnerEmail: '',
    partnerName: ''
  });
  stopConsentPolling();
  renderLockState();
}

function requestUnlock() {
  setButtonLoading('request-unlock-btn', 'Requesting...');
  sendMessage({ type: 'REQUEST_UNLOCK' });
}

function confirmReset() {
  if (confirm('Reset all settings and return to onboarding? This cannot be undone.')) {
    sendMessage({ type: 'RESET_SETTINGS' });
  }
}

function copyStoreUrl(el, url) {
  navigator.clipboard.writeText(url).then(function() {
    var original = el.textContent;
    el.textContent = 'Copied!';
    el.classList.add('copied');
    setTimeout(function() {
      el.textContent = original;
      el.classList.remove('copied');
    }, 1500);
  });
}

function installExtension(browserName, bundleId) {
  var name = decodeURIComponent(browserName).toLowerCase();
  var storeUrl;
  if (name.indexOf('firefox') !== -1 || name.indexOf('waterfox') !== -1 || name.indexOf('librewolf') !== -1 || name.indexOf('zen') !== -1 || name.indexOf('floorp') !== -1) {
    storeUrl = 'https://addons.mozilla.org/en-US/firefox/search/?q=intentional';
  } else if (name.indexOf('safari') !== -1 || name.indexOf('orion') !== -1) {
    storeUrl = 'https://apps.apple.com/search/intentional';
  } else {
    storeUrl = 'https://chromewebstore.google.com/search/intentional';
  }
  sendMessage({ type: 'OPEN_EXTENSIONS_PAGE', url: storeUrl, bundleId: bundleId || null });
}

// ===== Consent Polling =====
var consentPollTimer = null;

function startConsentPolling() {
  if (consentPollTimer) return;
  consentPollTimer = setInterval(function() {
    sendMessage({ type: 'GET_PARTNER_STATUS' });
  }, 10000);
}

function stopConsentPolling() {
  if (consentPollTimer) {
    clearInterval(consentPollTimer);
    consentPollTimer = null;
  }
}

// ===== Callbacks from Swift =====

// Settings loaded
window._settingsResult = function(data) {
  if (data.lockMode !== undefined) settings.lockMode = data.lockMode;
  if (data.partnerEmail !== undefined) settings.partnerEmail = data.partnerEmail || '';
  if (data.partnerName !== undefined) settings.partnerName = data.partnerName || '';
  if (data.consentStatus !== undefined) settings.consentStatus = data.consentStatus;
  if (data.temporaryUnlockUntil !== undefined) settings.temporaryUnlockUntil = data.temporaryUnlockUntil;
  if (data.selfUnlockAvailableAt !== undefined) settings.selfUnlockAvailableAt = data.selfUnlockAvailableAt;
  if (data.deviceId !== undefined) settings.deviceId = data.deviceId;

  populateSettingsUI(data);
  renderLockState();
};

// Save settings result
window._saveSettingsResult = function(data) {
  if (data.success) {
    showToast('Settings saved');
  } else {
    showToast(data.message || 'Failed to save settings', 'error');
  }
};

// Lock settings saved
window._lockSettingsResult = function(data) {
  clearButtonLoading('save-lock-btn');
  settings.lockMode = data.lockMode || 'none';
  if (data.consentStatus) settings.consentStatus = data.consentStatus;
  if (data.partnerEmail !== undefined) settings.partnerEmail = data.partnerEmail || '';
  if (data.partnerName !== undefined) settings.partnerName = data.partnerName || '';

  renderLockState();

  if (data.success) {
    showToast(data.message || 'Lock settings saved');
  } else if (data.consentStatus === 'pending') {
    showToast('Partner invitation sent! Waiting for acceptance.', 'warning');
  } else {
    showToast(data.message || 'Failed to set lock mode', 'error');
  }
};

// Partner status (from polling)
window._partnerStatusResult = function(data) {
  if (!data.success) return;

  var changed = false;
  if (data.consentStatus && data.consentStatus !== settings.consentStatus) {
    settings.consentStatus = data.consentStatus;
    changed = true;
  }
  if (data.partnerEmail !== undefined && (data.partnerEmail || '') !== settings.partnerEmail) {
    settings.partnerEmail = data.partnerEmail || '';
    changed = true;
  }
  if (data.partnerName !== undefined && (data.partnerName || '') !== settings.partnerName) {
    settings.partnerName = data.partnerName || '';
    changed = true;
  }

  if (changed) {
    renderLockState();
  }
};

// Remove partner result
window._removePartnerResult = function(data) {
  if (data.success) {
    settings.partnerEmail = '';
    settings.partnerName = '';
    settings.consentStatus = 'none';
    settings.lockMode = 'none';
    settings.temporaryUnlockUntil = null;
    settings.selfUnlockAvailableAt = null;
    settings.unlockRequested = false;
    settings.settingsUnlocked = false;
    showToast('Partner removed');
  } else {
    showToast('Failed to remove partner', 'error');
  }
  renderLockState();
};

// Resend invite result
window._resendInviteResult = function(data) {
  clearButtonLoading('resend-invite-btn');
  if (data.success) {
    showToast(data.message || 'Invitation resent!');
  } else {
    showToast(data.message || 'Failed to resend invitation', 'error');
  }
};

// Unlock result
window._unlockResult = function(data) {
  if (data.success) {
    showToast(data.message || 'Unlock code sent!');
    // Transition to code entry or countdown state
    if (settings.lockMode === 'self') {
      settings.selfUnlockAvailableAt = data.availableAt || new Date(Date.now() + 24 * 3600000).toISOString();
    } else {
      settings.unlockRequested = true;
    }
    renderLockState();
  } else {
    clearButtonLoading('request-unlock-btn');
    showToast(data.message || 'Unlock request failed', 'error');
    if (data.message && data.message.indexOf('not locked') !== -1) {
      settings.lockMode = 'none';
      renderLockState();
    }
  }
};

// Verify unlock result
window._verifyUnlockResult = function(data) {
  if (data.success) {
    if (data.auto_relock === false) {
      showToast('Settings unlocked!');
      settings.settingsUnlocked = true;
      settings.temporaryUnlockUntil = null;
    } else {
      showToast('Settings unlocked for 5 minutes!');
      settings.temporaryUnlockUntil = data.unlockUntil || new Date(Date.now() + 5 * 60000).toISOString();
    }
    settings.unlockRequested = false;
    settings.selfUnlockAvailableAt = null;
    renderLockState();
  } else {
    clearButtonLoading('verify-code-btn');
    showToast(data.message || 'Invalid code', 'error');
  }
};

// Dashboard data
window._dashboardDataResult = function(data) {
  var platforms = [
    { prefix: 'yt', key: 'youtube' },
    { prefix: 'ig', key: 'instagram' },
    { prefix: 'fb', key: 'facebook' }
  ];
  platforms.forEach(function(p) {
    var d = data[p.key];
    if (!d) return;

    // Usage stats
    document.getElementById(p.prefix + '-minutes').textContent = d.minutesUsed || 0;
    document.getElementById(p.prefix + '-budget').textContent = '/ ' + (d.budget || 30) + ' min budget';
    var pct = Math.min(100, ((d.minutesUsed || 0) / (d.budget || 30)) * 100);
    document.getElementById(p.prefix + '-bar').style.width = pct + '%';
    updateFreeBrowseDisplay(p.prefix, d);

    // Active session indicator
    var sessionEl = document.getElementById(p.prefix + '-session');
    var sessionLabel = document.getElementById(p.prefix + '-session-label');
    var intentEl = document.getElementById(p.prefix + '-session-intent');
    var card = document.getElementById(p.prefix + '-usage-card');

    if (d.session && d.session.active) {
      card.classList.add('has-session');
      sessionEl.style.display = 'flex';

      if (d.session.freeBrowse) {
        sessionLabel.textContent = 'Free Browse';
        sessionLabel.style.color = '#f59e0b';
        sessionEl.querySelector('.usage-session-dot').style.background = '#f59e0b';
        intentEl.style.display = 'none';
      } else {
        sessionLabel.textContent = 'Active Session';
        sessionLabel.style.color = '#34d399';
        sessionEl.querySelector('.usage-session-dot').style.background = '#34d399';

        if (d.session.intent) {
          intentEl.textContent = '"' + d.session.intent + '"';
          intentEl.style.display = 'block';
        } else {
          intentEl.style.display = 'none';
        }
      }

      // Show time remaining if timed session
      if (d.session.endsAt) {
        var remaining = d.session.endsAt - Date.now();
        if (remaining > 0) {
          var mins = Math.ceil(remaining / 60000);
          sessionLabel.textContent += ' ¬∑ ' + mins + 'm left';
        } else {
          sessionLabel.textContent += ' ¬∑ expired';
        }
      }
    } else {
      card.classList.remove('has-session');
      sessionEl.style.display = 'none';
      intentEl.style.display = 'none';
    }
  });
};

function updateFreeBrowseDisplay(prefix, platformData) {
  var fbBudget = platformData.freeBrowseBudget || 0;
  var fbUsed = Math.round(platformData.freeBrowseMinutesUsed || 0);
  var label = document.getElementById(prefix + '-free-browse');
  var barContainer = document.getElementById(prefix + '-fb-bar-container');
  var bar = document.getElementById(prefix + '-fb-bar');
  var minutes = document.getElementById(prefix + '-fb-minutes');
  if (fbBudget > 0) {
    if (label) { label.style.display = 'block'; }
    if (barContainer) { barContainer.style.display = 'block'; }
    if (minutes) { minutes.textContent = fbUsed; }
    if (bar) { bar.style.width = Math.min(100, (fbUsed / fbBudget) * 100) + '%'; }
  } else {
    if (label) { label.style.display = 'none'; }
    if (barContainer) { barContainer.style.display = 'none'; }
  }
}

// Browser status
window._extensionStatusResult = function(data) {
  var card = document.getElementById('browser-card');
  var empty = document.getElementById('browser-empty');

  if (!data.browsers || data.browsers.length === 0) {
    if (empty) {
      empty.innerHTML =
        '<div class="empty-state-icon">üåê</div>' +
        '<div class="empty-state-text">No browsers detected</div>';
    }
    return;
  }

  if (empty) empty.remove();

  // Sort: connected first, then alphabetical
  data.browsers.sort(function(a, b) {
    var aConn = (a.hasExtension && a.isEnabled) ? 0 : 1;
    var bConn = (b.hasExtension && b.isEnabled) ? 0 : 1;
    if (aConn !== bConn) return aConn - bConn;
    return a.name.localeCompare(b.name);
  });

  function getBrowserIcon(b) {
    if (b.iconDataUrl) {
      return '<span class="browser-icon"><img src="' + b.iconDataUrl + '" alt="' + escapeHtml(b.name) + '"></span>';
    }
    return '<span class="browser-icon" style="border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700;color:white;background:#6B7280;">' + b.name.charAt(0).toUpperCase() + '</span>';
  }

  function getStoreUrl(name) {
    var n = name.toLowerCase();
    if (n.indexOf('firefox') !== -1 || n.indexOf('waterfox') !== -1 || n.indexOf('librewolf') !== -1 || n.indexOf('zen') !== -1 || n.indexOf('floorp') !== -1)
      return 'addons.mozilla.org';
    if (n.indexOf('safari') !== -1 || n.indexOf('orion') !== -1)
      return 'apps.apple.com';
    return 'chromewebstore.google.com';
  }

  function getFullStoreUrl(name) {
    var n = name.toLowerCase();
    if (n.indexOf('firefox') !== -1 || n.indexOf('waterfox') !== -1 || n.indexOf('librewolf') !== -1 || n.indexOf('zen') !== -1 || n.indexOf('floorp') !== -1)
      return 'https://addons.mozilla.org/en-US/firefox/search/?q=intentional';
    if (n.indexOf('safari') !== -1 || n.indexOf('orion') !== -1)
      return 'https://apps.apple.com/search/intentional';
    return 'https://chromewebstore.google.com/search/intentional';
  }

  card.innerHTML = data.browsers.map(function(b) {
    var icon = getBrowserIcon(b);
    var isConnected = b.hasExtension && b.isEnabled;
    var isDisabled = b.hasExtension && !b.isEnabled;
    var rowClass = 'browser-row' + (isConnected ? ' browser-connected' : '');
    var storeHint = getStoreUrl(b.name);
    var fullUrl = getFullStoreUrl(b.name);

    var statusHtml;
    if (isConnected) {
      statusHtml = '<span class="browser-status connected"><span class="browser-status-dot connected"></span>Connected</span>';
    } else if (isDisabled) {
      statusHtml = '<span class="browser-status" style="color: #f59e0b;">Disabled</span>';
    } else {
      statusHtml = '<button class="browser-install-btn" onclick="installExtension(\'' + encodeURIComponent(b.name) + '\', \'' + (b.bundleId || '') + '\')">Install</button>';
    }

    return '<div class="' + rowClass + '">' +
      icon +
      '<span class="browser-name">' + escapeHtml(b.name) + '</span>' +
      '<span class="browser-ext-url" onclick="copyStoreUrl(this, \'' + fullUrl + '\')" title="Click to copy store URL">' + storeHint + '</span>' +
      statusHtml +
    '</div>';
  }).join('');
};

// ===== Account Auth =====
var authPendingEmail = '';

function showAccountState(state) {
  document.getElementById('account-loading').style.display = state === 'loading' ? 'block' : 'none';
  document.getElementById('account-logged-out').style.display = state === 'logged-out' ? 'block' : 'none';
  document.getElementById('account-code-entry').style.display = state === 'code-entry' ? 'block' : 'none';
  document.getElementById('account-signed-in').style.display = state === 'signed-in' ? 'block' : 'none';
}

function loadAccountPage() {
  showAccountState('loading');
  sendMessage({ type: 'GET_AUTH_STATE' });
}

window._authStateResult = function(data) {
  if (data.loggedIn) {
    document.getElementById('account-email').textContent = data.email;
    document.getElementById('account-since').textContent = formatAccountDate(data.createdAt);
    document.getElementById('account-devices').textContent = data.deviceCount + ' linked';
    showAccountState('signed-in');
    var delRow = document.getElementById('delete-account-row');
    if (delRow) delRow.style.display = '';
  } else {
    showAccountState('logged-out');
    var delRow = document.getElementById('delete-account-row');
    if (delRow) delRow.style.display = 'none';
  }
};

function authSendCode() {
  var email = document.getElementById('auth-email').value.trim();
  if (!email || email.indexOf('@') === -1) {
    document.getElementById('auth-login-error').textContent = 'Please enter a valid email.';
    document.getElementById('auth-login-error').style.display = 'block';
    return;
  }
  document.getElementById('auth-login-error').style.display = 'none';
  document.getElementById('auth-send-btn').disabled = true;
  document.getElementById('auth-send-btn').textContent = 'Sending...';
  authPendingEmail = email;
  sendMessage({ type: 'AUTH_LOGIN', email: email });
}

window._authLoginResult = function(data) {
  document.getElementById('auth-send-btn').disabled = false;
  document.getElementById('auth-send-btn').textContent = 'Send verification code';
  if (data.success) {
    document.getElementById('auth-code-email').textContent = authPendingEmail;
    document.getElementById('auth-code').value = '';
    document.getElementById('auth-verify-error').style.display = 'none';
    showAccountState('code-entry');
  } else {
    document.getElementById('auth-login-error').textContent = data.message;
    document.getElementById('auth-login-error').style.display = 'block';
  }
};

function authVerifyCode() {
  var code = document.getElementById('auth-code').value.trim();
  if (!code || code.length !== 6) {
    document.getElementById('auth-verify-error').textContent = 'Please enter the 6-digit code.';
    document.getElementById('auth-verify-error').style.display = 'block';
    return;
  }
  document.getElementById('auth-verify-error').style.display = 'none';
  document.getElementById('auth-verify-btn').disabled = true;
  document.getElementById('auth-verify-btn').textContent = 'Verifying...';
  sendMessage({ type: 'AUTH_VERIFY', email: authPendingEmail, code: code });
}

window._authVerifyResult = function(data) {
  document.getElementById('auth-verify-btn').disabled = false;
  document.getElementById('auth-verify-btn').textContent = 'Verify';
  if (data.success) {
    showToast('Signed in successfully');
    loadAccountPage();
  } else {
    document.getElementById('auth-verify-error').textContent = data.message;
    document.getElementById('auth-verify-error').style.display = 'block';
  }
};

function authBackToEmail() {
  document.getElementById('auth-verify-error').style.display = 'none';
  showAccountState('logged-out');
}

function authSignOut() {
  sendMessage({ type: 'AUTH_LOGOUT' });
}

window._authLogoutResult = function(data) {
  showAccountState('logged-out');
  showToast('Signed out');
};

function authDeleteAccount() {
  if (!confirm('Are you sure? A confirmation email will be sent to finalize deletion.')) return;
  document.getElementById('auth-delete-btn').disabled = true;
  document.getElementById('auth-delete-btn').textContent = 'Sending...';
  document.getElementById('auth-delete-msg').style.display = 'none';
  sendMessage({ type: 'AUTH_DELETE' });
}

window._authDeleteResult = function(data) {
  document.getElementById('auth-delete-btn').disabled = false;
  document.getElementById('auth-delete-btn').textContent = 'Delete';
  var msg = document.getElementById('auth-delete-msg');
  msg.textContent = data.message;
  msg.style.color = data.success ? '#34d399' : '#ef4444';
  msg.style.display = 'block';
};

function formatAccountDate(isoString) {
  if (!isoString) return '-';
  var d = new Date(isoString);
  var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return months[d.getMonth()] + ' ' + d.getDate() + ', ' + d.getFullYear();
}

// ===== Init =====
sendMessage({ type: 'GET_SETTINGS' });
sendMessage({ type: 'GET_PARTNER_STATUS' });
refresh();
setInterval(refresh, 5000);
</script>

<!-- Lock Confirmation Modal -->
<div id="lock-confirm-modal" class="lock-confirm-overlay" style="display:none">
  <div class="lock-confirm-box">
    <div class="lock-confirm-icon">üîí</div>
    <h3 id="lock-confirm-title">Enable setting?</h3>
    <p id="lock-confirm-desc">Description of the setting.</p>
    <p class="lock-confirm-warning">This setting will stay enabled until your profile is unlocked.</p>
    <div class="lock-confirm-actions">
      <button class="lock-confirm-cancel" onclick="closeLockConfirm(false)">Cancel</button>
      <button class="lock-confirm-enable" onclick="closeLockConfirm(true)">Enable</button>
    </div>
  </div>
</div>

</body>
</html>
